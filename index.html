<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faizan-e-Raza Madarsa Result Portal</title>
<style>
:root {
  --primary: #2e7d32;
  --primary-dark: #1b5e20;
  --primary-light: #4caf50;
  --secondary: #d4af37;
  --accent: #1976d2;
  --danger: #d32f2f;
  --warning: #ff9800;
  --success: #388e3c;
  --light-bg: #f8fff8;
  --card-bg: #ffffff;
  --text: #333333;
  --text-light: #666666;
  --border: #e0e0e0;
  --shadow: 0 2px 8px rgba(0,0,0,0.1);
}

* {
  box-sizing: border-box;
}

body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  background: var(--light-bg); 
  margin: 0; 
  padding: 0; 
  color: var(--text);
  line-height: 1.6;
}

header { 
  background: linear-gradient(to right, var(--primary), var(--secondary)); 
  color: white; 
  text-align: center; 
  padding: 1rem; 
  font-size: 1.4rem; 
  font-weight: bold;
  box-shadow: var(--shadow);
}

nav { 
  display: flex; 
  justify-content: center; 
  flex-wrap: wrap; 
  background: var(--card-bg); 
  border-bottom: 2px solid var(--border);
  padding: 0.5rem;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow);
}

nav button { 
  margin: 5px; 
  padding: 10px 18px; 
  border: none; 
  background: var(--primary); 
  color: white; 
  border-radius: 5px; 
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  flex: 1;
  min-width: 120px;
  max-width: 200px;
}

nav button:hover { 
  background: var(--primary-dark); 
  transform: translateY(-2px);
}

section { 
  display: none; 
  padding: 20px; 
  max-width: 1200px;
  margin: 0 auto;
}

.active { 
  display: block; 
}

.hidden { 
  display: none; 
}

input, select, textarea { 
  width: 100%; 
  padding: 12px; 
  margin-top: 8px; 
  border: 1px solid var(--border); 
  border-radius: 5px; 
  font-size: 1rem;
  transition: border 0.3s;
}

input:focus, select:focus, textarea:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
}

.btn { 
  background: var(--success); 
  color: white; 
  border: none; 
  padding: 12px 18px; 
  border-radius: 5px; 
  cursor: pointer; 
  margin-top: 10px;
  font-size: 1rem;
  transition: all 0.3s ease;
  display: inline-block;
  text-align: center;
}

.btn:hover { 
  background: var(--primary-dark); 
  transform: translateY(-2px);
}

.btn-info { 
  background: var(--accent); 
  color: white; 
  border: none; 
  padding: 8px 14px; 
  border-radius: 5px; 
  cursor: pointer; 
  margin-top: 5px; 
  margin-left: 10px; 
}

.btn-info:hover { 
  background: #1565c0; 
}

.btn-danger { 
  background: var(--danger); 
  color: white; 
  border: none; 
  padding: 8px 14px; 
  border-radius: 5px; 
  cursor: pointer; 
  margin-top: 5px; 
  margin-left: 10px; 
}

.btn-danger:hover { 
  background: #b71c1c; 
}

.btn-warning { 
  background: var(--warning); 
  color: white; 
  border: none; 
  padding: 8px 14px; 
  border-radius: 5px; 
  cursor: pointer; 
  margin-top: 5px; 
  margin-left: 10px; 
}

.btn-warning:hover { 
  background: #f57c00; 
}

.btn-pay { 
  background: #4CAF50; 
  color: white; 
  border: none; 
  padding: 8px 14px; 
  border-radius: 5px; 
  cursor: pointer; 
  margin-top: 5px; 
  margin-left: 10px; 
  font-weight: bold;
}

.btn-pay:hover { 
  background: #388E3C; 
}

table { 
  width: 100%; 
  border-collapse: collapse; 
  margin-top: 15px;
  box-shadow: var(--shadow);
  border-radius: 8px;
  overflow: hidden;
}

th, td { 
  border: 1px solid var(--border); 
  padding: 12px; 
  text-align: center; 
}

th { 
  background: #e8f5e9; 
  font-weight: 600;
}

.result-card { 
  background: var(--card-bg); 
  border-radius: 8px; 
  padding: 20px; 
  margin-top: 20px; 
  box-shadow: var(--shadow);
  border-left: 4px solid var(--primary);
}

.position-1st { 
  color: var(--secondary); 
  font-weight: bold; 
  font-size: 1.2em; 
}

.position-2nd { 
  color: var(--primary); 
  font-weight: bold; 
}

.position-3rd { 
  color: var(--primary-dark); 
  font-weight: bold; 
}

.position-pass { 
  color: var(--text-light); 
}

.absent { 
  color: var(--danger); 
  font-weight: bold; 
}

.flower { 
  position: fixed; 
  font-size: 20px; 
  opacity: 0; 
  z-index: 1000; 
  pointer-events: none; 
}

@keyframes fall {
  0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}

.confirmation-dialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 25px;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  z-index: 2000;
  text-align: center;
  max-width: 90%;
  width: 400px;
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1999;
}

.attendance-inputs {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.attendance-inputs input {
  flex: 1;
  min-width: 150px;
}

.fine-calc { 
  background: #fff3cd; 
  padding: 15px; 
  border-radius: 5px; 
  margin: 15px 0; 
  border: 1px solid #ffeaa7;
}

.edit-form {
  background: #e8f5e9;
  padding: 20px;
  border-radius: 8px;
  margin: 20px 0;
  border: 1px solid #c8e6c9;
}

.currency {
  font-weight: bold;
  color: var(--primary);
}

.student-edit-form {
  background: #e3f2fd;
  padding: 20px;
  border-radius: 8px;
  margin: 20px 0;
  border: 2px solid var(--accent);
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 15px;
}

.result-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin: 15px 0;
}

.summary-card {
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: var(--shadow);
  text-align: center;
}

.summary-card h3 {
  margin-top: 0;
  color: var(--primary);
}

.summary-value {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--primary-dark);
}

.admin-view {
  position: fixed;
  top: 10px;
  right: 10px;
  background: rgba(255, 255, 255, 0.9);
  padding: 10px;
  border-radius: 5px;
  box-shadow: var(--shadow);
  z-index: 1001;
  font-size: 0.9rem;
  border-left: 4px solid var(--primary);
}

.admin-view.hidden {
  display: none;
}

/* Academy Student Styles */
.academy-student-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  border-left: 4px solid var(--accent);
}

.academy-student-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.academy-student-details {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 15px;
}

.detail-item {
  display: flex;
  flex-direction: column;
}

.detail-label {
  font-weight: bold;
  color: var(--text-light);
  font-size: 0.9rem;
}

.detail-value {
  font-size: 1rem;
  color: var(--text);
}

.academy-student-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 15px;
}

.academy-student-search {
  margin-bottom: 20px;
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.academy-student-search input {
  flex: 1;
  min-width: 200px;
}

.academy-student-filters {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.academy-student-filters select {
  min-width: 150px;
}

.academy-student-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 20px;
}

.stat-card {
  background: white;
  padding: 15px;
  border-radius: 8px;
  box-shadow: var(--shadow);
  text-align: center;
}

.stat-card h3 {
  margin-top: 0;
  color: var(--primary);
  font-size: 1rem;
}

.stat-value {
  font-size: 1.5rem;
  font-weight: bold;
  color: var(--primary-dark);
}

.academy-student-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
}

.academy-student-item {
  background: white;
  border-radius: 8px;
  padding: 15px;
  box-shadow: var(--shadow);
  transition: transform 0.3s ease;
}

.academy-student-item:hover {
  transform: translateY(-5px);
}

.academy-student-item-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.academy-student-item-name {
  font-weight: bold;
  font-size: 1.1rem;
  color: var(--primary);
}

.academy-student-item-roll {
  background: var(--primary-light);
  color: white;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.8rem;
}

.academy-student-item-details {
  font-size: 0.9rem;
  color: var(--text-light);
  margin-bottom: 10px;
}

.academy-student-item-actions {
  display: flex;
  gap: 5px;
  flex-wrap: wrap;
}

.academy-form-section {
  background: #e8f5e9;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  border: 1px solid #c8e6c9;
}

.academy-form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 15px;
  margin-bottom: 15px;
}

.toggle-buttons {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.toggle-btn {
  background: var(--primary-light);
  color: white;
  border: none;
  padding: 10px 15px;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.toggle-btn.active {
  background: var(--primary);
  font-weight: bold;
}

.toggle-btn:hover {
  background: var(--primary);
}

/* Mobile-specific styles */
@media (max-width: 768px) {
  header {
    font-size: 1.2rem;
    padding: 0.8rem;
  }
  
  nav {
    padding: 0.3rem;
  }
  
  nav button {
    padding: 8px 12px;
    font-size: 0.8rem;
    min-width: 100px;
  }
  
  section {
    padding: 15px;
  }
  
  table {
    font-size: 0.85rem;
  }
  
  th, td {
    padding: 8px 5px;
  }
  
  .btn {
    padding: 10px 15px;
    width: 100%;
    margin: 5px 0;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .attendance-inputs {
    flex-direction: column;
  }
  
  .confirmation-dialog {
    width: 90%;
    padding: 20px;
  }
  
  .result-summary {
    grid-template-columns: 1fr;
  }
  
  .admin-view {
    position: static;
    margin: 10px;
    text-align: center;
  }
  
  .academy-student-header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .academy-student-details {
    grid-template-columns: 1fr;
  }
  
  .academy-student-list {
    grid-template-columns: 1fr;
  }
  
  .academy-student-search {
    flex-direction: column;
  }
  
  .academy-student-filters {
    flex-direction: column;
  }
  
  .academy-form-grid {
    grid-template-columns: 1fr;
  }
  
  .toggle-buttons {
    flex-direction: column;
  }
}

@media (max-width: 480px) {
  header {
    font-size: 1rem;
  }
  
  nav button {
    min-width: 80px;
    font-size: 0.75rem;
    padding: 6px 8px;
  }
  
  table {
    display: block;
    overflow-x: auto;
  }
  
  input, select, textarea {
    padding: 10px;
  }
}

/* Sequential numbering styles */
.sequential-number {
  display: inline-block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  text-align: center;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  margin-right: 10px;
  font-weight: bold;
}

/* Eye-friendly improvements */
h1, h2, h3 {
  color: var(--primary-dark);
  margin-top: 0;
}

p {
  margin: 10px 0;
}

label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: var(--text);
}

/* Loading spinner */
.spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left-color: var(--primary);
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
  display: none;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Success/Error messages */
.message {
  padding: 10px 15px;
  border-radius: 5px;
  margin: 10px 0;
  font-weight: 500;
}

.message.success {
  background: #e8f5e9;
  color: var(--success);
  border: 1px solid #c8e6c9;
}

.message.error {
  background: #ffebee;
  color: var(--danger);
  border: 1px solid #ffcdd2;
}

.message.info {
  background: #e3f2fd;
  color: var(--accent);
  border: 1px solid #bbdefb;
}

.roll-warning {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  padding: 10px;
  border-radius: 5px;
  margin: 10px 0;
  color: #856404;
}

.fine-paid {
  color: var(--success);
  font-weight: bold;
}

.fine-pending {
  color: var(--danger);
  font-weight: bold;
}

/* Roll number grouping */
.roll-group {
  margin-bottom: 25px;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: var(--shadow);
}

.roll-header {
  background: var(--primary);
  color: white;
  padding: 12px 15px;
  font-weight: bold;
  font-size: 1.1rem;
}

.roll-content {
  background: white;
  padding: 15px;
}

.roll-student-info {
  background: #f5f5f5;
  padding: 10px 15px;
  border-bottom: 1px solid var(--border);
  margin-bottom: 10px;
}

.roll-student-info p {
  margin: 5px 0;
}

.roll-results-table {
  width: 100%;
  border-collapse: collapse;
}

.roll-results-table th {
  background: #e8f5e9;
}

.roll-results-table th, 
.roll-results-table td {
  padding: 10px;
  border: 1px solid var(--border);
  text-align: center;
}

.no-results {
  text-align: center;
  padding: 20px;
  color: var(--text-light);
  font-style: italic;
}

.login-time {
  font-size: 0.8rem;
  color: var(--primary-dark);
  margin-top: 5px;
}

.exited-student {
  opacity: 0.7;
  border-left: 4px solid var(--danger);
}

.academy-type-badge {
  background: var(--secondary);
  color: white;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.7rem;
  margin-left: 5px;
}

.delete-btn {
  background: #d32f2f;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.8rem;
  transition: all 0.3s ease;
}

.delete-btn:hover {
  background: #b71c1c;
}
</style>
</head>
<body>

<header>üïå Faizan-e-Raza Madarsa Result Portal</header>

<!-- Admin View Panel -->
<div id="adminViewPanel" class="admin-view hidden">
  <strong>üîê Admin Mode</strong>
  <div id="adminViewInfo"></div>
  <div id="adminLoginTime" class="login-time"></div>
</div>

<nav>
  <button onclick="showSection('resultSection')">Check Result</button>
  <button id="loginBtn" onclick="showSection('loginSection')">Admin Login</button>
  <button id="studentBtn" class="hidden" onclick="showSection('studentSection')">Add / Exit Student</button>
  <button id="allStudentBtn" class="hidden" onclick="showSection('allStudentsSection')">All Students</button>
  <button id="academyStudentBtn" class="hidden" onclick="showSection('academyStudentsSection')">Academy Students</button>
  <button id="exitListBtn" class="hidden" onclick="showSection('exitListSection')">Exit Student List</button>
  <button id="resultBtn" class="hidden" onclick="showSection('addResultSection')">Add Results</button>
  <button id="allResultBtn" class="hidden" onclick="showSection('allResultsSection')">All Results</button>
  <button id="changeCodeBtn" class="hidden" onclick="showSection('changeCodeSection')">Change Admin Code</button>
  <button id="logoutBtn" class="hidden" onclick="adminLogout()">Logout</button>
</nav>

<!-- üü¢ PUBLIC RESULT CHECK -->
<section id="resultSection" class="active">
  <h2>Check Student Result</h2>
  <input type="text" id="searchRoll" placeholder="Enter Roll Number">
  <button class="btn" onclick="checkResult()">Check</button>
  <div id="resultOutput"></div>
</section>

<!-- üîê ADMIN LOGIN -->
<section id="loginSection">
  <h2>Admin Login</h2>
  <input type="password" id="adminCode" placeholder="Enter Admin Code">
  <button class="btn" onclick="adminLogin()">Login</button>
  <p id="loginMsg"></p>
</section>

<!-- üßë‚Äçüéì ADD / EXIT STUDENT -->
<section id="studentSection">
  <h2>Add Student</h2>
  <input type="text" id="nameInput" placeholder="Student Name">
  <input type="text" id="fatherInput" placeholder="Father Name">
  <input type="text" id="phoneInput" placeholder="Phone Number">
  <input type="text" id="rollInput" placeholder="Roll Number">
  <input type="date" id="admissionInput">
  <select id="categoryInput">
    <option value="">Select Class</option>
    <option>Noorani Qaida</option>
    <option>Separa</option>
    <option>Nazra</option>
    <option>Hifz</option>
  </select>
  <button class="btn" onclick="addStudent()">Add Student</button>
  <p id="stdMsg"></p>
  <hr>
  <h2>Exit Student</h2>
  <input type="text" id="exitRoll" placeholder="Enter Roll Number">
  <input type="date" id="exitDate">
  <input type="text" id="exitReason" placeholder="Reason for Exit">
  <button class="btn" onclick="exitStudent()">Exit Student</button>
  <p id="exitMsg"></p>
</section>

<!-- üìã ALL STUDENTS -->
<section id="allStudentsSection">
  <h2>All Students</h2>
  <button class="btn" onclick="loadAllStudents()">Refresh</button>
  
  <!-- Student Edit Form (Hidden by default) -->
  <div id="editStudentForm" class="student-edit-form hidden">
    <h3>‚úèÔ∏è Edit Student Information</h3>
    <input type="hidden" id="editStudentRoll">
    <div class="form-grid">
      <div>
        <label>Roll Number</label>
        <input type="text" id="editStudentNewRoll" placeholder="New Roll Number">
        <div id="rollWarning" class="roll-warning hidden">
          ‚ö† Changing roll number will update all related records
        </div>
      </div>
      <div>
        <label>Student Name</label>
        <input type="text" id="editStudentName" placeholder="Student Name">
      </div>
      <div>
        <label>Father Name</label>
        <input type="text" id="editStudentFather" placeholder="Father Name">
      </div>
      <div>
        <label>Phone Number</label>
        <input type="text" id="editStudentPhone" placeholder="Phone Number">
      </div>
      <div>
        <label>Admission Date</label>
        <input type="date" id="editStudentAdmission">
      </div>
      <div>
        <label>Class</label>
        <select id="editStudentCategory">
          <option value="">Select Class</option>
          <option>Noorani Qaida</option>
          <option>Separa</option>
          <option>Nazra</option>
          <option>Hifz</option>
        </select>
      </div>
    </div>
    <button class="btn" onclick="updateStudent()">üíæ Update Student</button>
    <button class="btn-warning" onclick="cancelStudentEdit()">‚ùå Cancel</button>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Roll</th>
        <th>Name</th>
        <th>Father</th>
        <th>Phone</th>
        <th>Class</th>
        <th>Admission</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="allStudentsTable"></tbody>
  </table>
</section>

<!-- üè´ ACADEMY STUDENTS -->
<section id="academyStudentsSection">
  <h2>üè´ Academy Students Management</h2>
  
  <!-- Toggle between Add and View -->
  <div class="toggle-buttons">
    <button id="addAcademyToggle" class="toggle-btn active" onclick="toggleAcademyView('add')">‚ûï Add Academy Student</button>
    <button id="viewAcademyToggle" class="toggle-btn" onclick="toggleAcademyView('view')">üëÅÔ∏è View Academy Students</button>
  </div>
  
  <!-- Add Academy Student Form -->
  <div id="addAcademyForm" class="academy-form-section">
    <h3>‚ûï Add New Academy Student</h3>
    <div class="academy-form-grid">
      <div>
        <label>Student Name *</label>
        <input type="text" id="academyName" placeholder="Student Name" required>
      </div>
      <div>
        <label>Father Name *</label>
        <input type="text" id="academyFather" placeholder="Father Name" required>
      </div>
      <div>
        <label>Phone Number</label>
        <input type="text" id="academyPhone" placeholder="Phone Number">
      </div>
      <div>
        <label>Roll Number *</label>
        <input type="text" id="academyRoll" placeholder="Roll Number" required>
      </div>
      <div>
        <label>Admission Date</label>
        <input type="date" id="academyAdmission">
      </div>
      <div>
        <label>Class *</label>
        <select id="academyCategory" required>
          <option value="">Select Class</option>
          <option value="1">Class 1</option>
          <option value="2">Class 2</option>
          <option value="3">Class 3</option>
          <option value="4">Class 4</option>
          <option value="5">Class 5</option>
          <option value="6">Class 6</option>
          <option value="7">Class 7</option>
          <option value="8">Class 8</option>
          <option value="9">Class 9</option>
          <option value="10">Class 10</option>
          <option value="11">Class 11</option>
          <option value="12">Class 12</option>
        </select>
      </div>
      <div>
        <label>Academy Type *</label>
        <select id="academyType" required>
          <option value="">Select Type</option>
          <option value="regular">Regular Academy</option>
          <option value="special">Special Academy</option>
          <option value="weekend">Weekend Academy</option>
          <option value="summer">Summer Academy</option>
        </select>
      </div>
      <div>
        <label>Address</label>
        <textarea id="academyAddress" placeholder="Full Address" rows="3"></textarea>
      </div>
      <div>
        <label>Additional Notes</label>
        <textarea id="academyNotes" placeholder="Any additional information" rows="3"></textarea>
      </div>
    </div>
    <button class="btn" onclick="addAcademyStudent()">‚ûï Add Academy Student</button>
    <p id="academyMsg"></p>
  </div>
  
  <!-- View Academy Students -->
  <div id="viewAcademySection" class="hidden">
    <!-- Search and Filters -->
    <div class="academy-student-search">
      <input type="text" id="academyStudentSearch" placeholder="Search by name, roll, or father name">
      <button class="btn" onclick="searchAcademyStudents()">Search</button>
      <button class="btn" onclick="clearAcademySearch()">Clear</button>
    </div>
    
    <div class="academy-student-filters">
      <select id="academyClassFilter" onchange="filterAcademyStudents()">
        <option value="">All Classes</option>
        <option value="1">Class 1</option>
        <option value="2">Class 2</option>
        <option value="3">Class 3</option>
        <option value="4">Class 4</option>
        <option value="5">Class 5</option>
        <option value="6">Class 6</option>
        <option value="7">Class 7</option>
        <option value="8">Class 8</option>
        <option value="9">Class 9</option>
        <option value="10">Class 10</option>
        <option value="11">Class 11</option>
        <option value="12">Class 12</option>
      </select>
      <select id="academyTypeFilter" onchange="filterAcademyStudents()">
        <option value="">All Types</option>
        <option value="regular">Regular Academy</option>
        <option value="special">Special Academy</option>
        <option value="weekend">Weekend Academy</option>
        <option value="summer">Summer Academy</option>
      </select>
      <select id="academyStatusFilter" onchange="filterAcademyStudents()">
        <option value="">All Students</option>
        <option value="active">Active</option>
        <option value="exited">Exited</option>
      </select>
    </div>
    
    <!-- Statistics -->
    <div class="academy-student-stats">
      <div class="stat-card">
        <h3>Total Academy Students</h3>
        <div class="stat-value" id="totalAcademyStudentsCount">0</div>
      </div>
      <div class="stat-card">
        <h3>Active Academy Students</h3>
        <div class="stat-value" id="activeAcademyStudentsCount">0</div>
      </div>
      <div class="stat-card">
        <h3>Exited Academy Students</h3>
        <div class="stat-value" id="exitedAcademyStudentsCount">0</div>
      </div>
      <div class="stat-card">
        <h3>Academy Types</h3>
        <div class="stat-value" id="academyTypesCount">0</div>
      </div>
    </div>
    
    <!-- Student List -->
    <div id="academyStudentsList" class="academy-student-list">
      <!-- Student cards will be dynamically inserted here -->
    </div>
    
    <!-- No Results Message -->
    <div id="noAcademyStudents" class="no-results hidden">
      No academy students found matching your criteria.
    </div>
  </div>
</section>

<!-- üßæ EXIT LIST -->
<section id="exitListSection">
  <h2>Exit Student List</h2>
  <button class="btn" onclick="loadExitList()">Refresh</button>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Roll</th>
        <th>Name</th>
        <th>Date</th>
        <th>Reason</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="exitStudentsTable"></tbody>
  </table>
</section>

<!-- üßÆ ADD RESULTS -->
<section id="addResultSection">
  <h2>Add Monthly Results</h2>
  <input type="text" id="monthInput" placeholder="Month (e.g. October)">
  
  <h3>Set Total Marks</h3>
  <input type="number" id="namazTotal" placeholder="Namaz Total">
  <input type="number" id="kalmaTotal" placeholder="Kalma Total">
  <input type="number" id="quranTotal" placeholder="Nazra Total">
  
  <h3>Set Attendance Details</h3>
  <div class="attendance-inputs">
    <input type="number" id="totalWorkingDays" placeholder="Total Working Days" required>
  </div>
  
  <div class="fine-calc">
    <strong>üí∞ Fine Calculation:</strong>
    <p><span class="currency">Rs.</span> 10 per absent day will be automatically calculated</p>
    <p>Fine = (Total Working Days - Present Days) √ó <span class="currency">Rs.</span> 10</p>
  </div>
  
  <button class="btn" onclick="loadStudentsForResults()">Load Students</button>
  <div id="resultTableContainer"></div>
  <button class="btn" onclick="saveAllResults()">üíæ Save All Results</button>
  <p id="resMsg"></p>
</section>

<!-- üìä ALL RESULTS -->
<section id="allResultsSection">
  <h2>All Results</h2>
  <button class="btn" onclick="loadAllResults()">Refresh</button>
  <button class="btn" onclick="loadAllResultsByRoll()">View by Roll Number</button>
  <button class="btn-danger" onclick="showDeleteConfirmation()">üóë Delete All Results</button>
  
  <!-- Edit Form (Hidden by default) -->
  <div id="editResultForm" class="edit-form hidden">
    <h3>‚úèÔ∏è Edit Result</h3>
    <input type="hidden" id="editResultKey">
    <div class="attendance-inputs">
      <input type="number" id="editNamazObt" placeholder="Namaz Obtained">
      <input type="number" id="editKalmaObt" placeholder="Kalma Obtained">
      <input type="number" id="editQuranObt" placeholder="Nazra Obtained">
    </div>
    <div class="attendance-inputs">
      <input type="number" id="editPresentDays" placeholder="Present Days">
      <input type="number" id="editTotalWorkingDays" placeholder="Total Working Days">
    </div>
    <div class="attendance-inputs">
      <input type="number" id="editFine" placeholder="Fine Amount">
      <select id="editPosition">
        <option value="">Select Position</option>
        <option value="1st">1st Position</option>
        <option value="2nd">2nd Position</option>
        <option value="3rd">3rd Position</option>
        <option value="Pass">Pass</option>
      </select>
    </div>
    <button class="btn" onclick="updateResult()">üíæ Update Result</button>
    <button class="btn-warning" onclick="cancelEdit()">‚ùå Cancel</button>
  </div>
  
  <!-- Default Results View -->
  <div id="defaultResultsView">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Roll</th>
          <th>Name</th>
          <th>Father</th>
          <th>Month</th>
          <th>Total</th>
          <th>Attendance</th>
          <th>Position</th>
          <th>Fine</th>
          <th>Status</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="allResultsTable"></tbody>
    </table>
  </div>
  
  <!-- Roll Number Grouped Results View -->
  <div id="rollResultsView" class="hidden">
    <div id="rollResultsContainer"></div>
  </div>
</section>

<!-- üîë CHANGE ADMIN CODE -->
<section id="changeCodeSection">
  <h2>Change Admin Code</h2>
  <input type="password" id="oldCode" placeholder="Old Code">
  <input type="password" id="newCode" placeholder="New Code">
  <button class="btn" onclick="changeAdminCode()">Change</button>
  <p id="codeMsg"></p>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get, child, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB_zOJiXH5ZSHs4miirkF4p7Fc6NUDuNiY",
  authDomain: "faizan-e-raza-madarsa-8c743.firebaseapp.com",
  databaseURL: "https://faizan-e-raza-madarsa-8c743-default-rtdb.firebaseio.com",
  projectId: "faizan-e-raza-madarsa-8c743",
  storageBucket: "faizan-e-raza-madarsa-8c743.firebasestorage.app",
  messagingSenderId: "659467130617",
  appId: "1:659467130617:web:9ed42e7bb8e3eea5917428"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ‚úÖ Ensure Admin Code exists in Firebase
const adminRef = ref(db, "admin/code");
get(adminRef).then(snap => { if (!snap.exists()) set(adminRef, "6457"); });


// Navigation
window.showSection=id=>{
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  updateAdminView();
  
  // Load academy students when that section is shown
  if (id === 'academyStudentsSection') {
    loadAcademyStudents();
  }
};

// üîê Admin Login
window.adminLogin=async()=>{
  const code=adminCode.value.trim();
  const snap=await get(ref(db,"admin/code"));
  const realCode=snap.exists()?snap.val():"6457";
  if(code===realCode){
    document.querySelectorAll("#studentBtn,#logoutBtn,#resultBtn,#allResultBtn,#changeCodeBtn,#exitListBtn,#allStudentBtn,#academyStudentBtn")
      .forEach(b=>b.classList.remove("hidden"));
    document.getElementById("loginBtn").classList.add("hidden");
    document.getElementById("adminViewPanel").classList.remove("hidden");
    
   
    
    loginMsg.textContent="‚úÖ Login Successful!";
    showSection("studentSection");
  } else loginMsg.textContent="‚ùå Wrong Admin Code!";
};

// Update Admin View Panel
function updateAdminView() {
  const currentTime = new Date().toLocaleTimeString();
  const currentSection = document.querySelector('section.active h2').textContent;
  
  let adminInfoHTML = `<div>Viewing: ${currentSection}</div>`;
  
  if (adminLoginTime) {
    const loginTimeStr = adminLoginTime.toLocaleTimeString();
    const loginDateStr = adminLoginTime.toLocaleDateString();
    adminInfoHTML += `<div class="login-time">Logged in: ${loginDateStr} at ${loginTimeStr}</div>`;
  }
  
  document.getElementById("adminViewInfo").innerHTML = adminInfoHTML;
}

// Logout
window.adminLogout=()=>{
  document.querySelectorAll("#studentBtn,#logoutBtn,#resultBtn,#allResultBtn,#changeCodeBtn,#exitListBtn,#allStudentBtn,#academyStudentBtn")
    .forEach(b=>b.classList.add("hidden"));
  document.getElementById("loginBtn").classList.remove("hidden");
  document.getElementById("adminViewPanel").classList.add("hidden");
  adminLoginTime = null;
  showSection("resultSection");
};

// Add Student
window.addStudent=async()=>{
  if(!nameInput.value||!fatherInput.value||!rollInput.value||!categoryInput.value)
    return stdMsg.textContent="‚ö† Fill all fields!";
  await set(ref(db,"students/"+rollInput.value),{
    name:nameInput.value,father:fatherInput.value,phone:phoneInput.value,
    roll:rollInput.value,admission:admissionInput.value,category:categoryInput.value
  });
  stdMsg.textContent="‚úÖ Student Added!";
  nameInput.value=fatherInput.value=phoneInput.value=rollInput.value="";
};

// Exit Student
window.exitStudent=async()=>{
  const roll=exitRoll.value.trim();
  if(!roll||!exitDate.value||!exitReason.value)
    return exitMsg.textContent="‚ö† Fill all fields!";
  const s=await get(child(ref(db),"students/"+roll));
  if(s.exists()){
    const st=s.val();
    await set(ref(db,"exited/"+roll),{roll,name:st.name,date:exitDate.value,reason:exitReason.value});
    await remove(ref(db,"students/"+roll));
    exitMsg.textContent="‚úÖ Student Exited!";
  } else exitMsg.textContent="‚ùå Roll Not Found!";
};

// Exit List
window.loadExitList=()=>{
  get(child(ref(db),"exited")).then(snap=>{
    exitStudentsTable.innerHTML="";
    if(snap.exists()){
      let count = 1;
      snap.forEach(c=>{
        const s=c.val();
        exitStudentsTable.innerHTML+=`<tr>
          <td>${count}</td>
          <td>${s.roll}</td>
          <td>${s.name}</td>
          <td>${s.date}</td>
          <td>${s.reason}</td>
          <td><button class="delete-btn" onclick="deleteExitStudent('${s.roll}')">üóë Delete</button></td>
        </tr>`;
        count++;
      });
    } else exitStudentsTable.innerHTML="<tr><td colspan='6'>No Exited Students</td></tr>";
  });
};
window.deleteExitStudent=async(roll)=>{await remove(ref(db,"exited/"+roll));loadExitList();};

// All Students
window.loadAllStudents=()=>{
  get(child(ref(db),"students")).then(snap=>{
    allStudentsTable.innerHTML="";
    if(snap.exists()){
      let count = 1;
      snap.forEach(c=>{
        const s=c.val();
        allStudentsTable.innerHTML+=`<tr>
          <td>${count}</td>
          <td>${s.roll}</td>
          <td>${s.name}</td>
          <td>${s.father}</td>
          <td>${s.phone}</td>
          <td>${s.category}</td>
          <td>${s.admission}</td>
          <td>
            <button class="btn-info" onclick="editStudent('${s.roll}')">‚úèÔ∏è Edit</button>
            <button class="btn-danger" onclick="deleteStudent('${s.roll}')">üóë Delete</button>
          </td>
        </tr>`;
        count++;
      });
    } else allStudentsTable.innerHTML="<tr><td colspan='8'>No Students</td></tr>";
  });
};

// Edit Student
window.editStudent = async (roll) => {
  const studentRef = ref(db, "students/" + roll);
  const snapshot = await get(studentRef);
  
  if (snapshot.exists()) {
    const student = snapshot.val();
    
    // Show edit form
    document.getElementById('editStudentForm').classList.remove('hidden');
    
    // Fill form with current data
    document.getElementById('editStudentRoll').value = roll;
    document.getElementById('editStudentNewRoll').value = roll;
    document.getElementById('editStudentName').value = student.name || '';
    document.getElementById('editStudentFather').value = student.father || '';
    document.getElementById('editStudentPhone').value = student.phone || '';
    document.getElementById('editStudentAdmission').value = student.admission || '';
    document.getElementById('editStudentCategory').value = student.category || '';
    
    // Show warning when roll number is changed
    document.getElementById('editStudentNewRoll').addEventListener('input', function() {
      if(this.value !== roll) {
        document.getElementById('rollWarning').classList.remove('hidden');
      } else {
        document.getElementById('rollWarning').classList.add('hidden');
      }
    });
    
    // Scroll to edit form
    document.getElementById('editStudentForm').scrollIntoView({ behavior: 'smooth' });
  }
};

// Update Student
window.updateStudent = async () => {
  const oldRoll = document.getElementById('editStudentRoll').value;
  const newRoll = document.getElementById('editStudentNewRoll').value;
  
  const name = document.getElementById('editStudentName').value;
  const father = document.getElementById('editStudentFather').value;
  const phone = document.getElementById('editStudentPhone').value;
  const admission = document.getElementById('editStudentAdmission').value;
  const category = document.getElementById('editStudentCategory').value;
  
  if(!name || !father || !category || !newRoll) {
    alert("‚ö† Please fill all required fields!");
    return;
  }
  
  const updates = {
    name: name,
    father: father,
    phone: phone,
    admission: admission,
    category: category,
    roll: newRoll
  };
  
  try {
    // If roll number is changed, we need to:
    // 1. Create new student record with new roll
    // 2. Update all results with new roll
    // 3. Delete old student record
    
    if(oldRoll !== newRoll) {
      // Check if new roll number already exists
      const existingStudent = await get(ref(db, "students/" + newRoll));
      if(existingStudent.exists()) {
        alert("‚ùå Roll number already exists! Please use a different roll number.");
        return;
      }
      
      // Create new student record
      await set(ref(db, "students/" + newRoll), updates);
      
      // Update all results with new roll number
      const resultsSnap = await get(child(ref(db), "results"));
      if(resultsSnap.exists()) {
        const updatePromises = [];
        resultsSnap.forEach(c => {
          const result = c.val();
          if(result.roll === oldRoll) {
            // Create new result with updated roll
            const newResult = {...result, roll: newRoll};
            const newKey = newRoll + "_" + result.month;
            updatePromises.push(set(ref(db, "results/" + newKey), newResult));
            // Delete old result
            updatePromises.push(remove(ref(db, "results/" + c.key)));
          }
        });
        await Promise.all(updatePromises);
      }
      
      // Delete old student record
      await remove(ref(db, "students/" + oldRoll));
      
    } else {
      // Just update the student record if roll number is same
      await update(ref(db, "students/" + oldRoll), updates);
    }
    
    document.getElementById('editStudentForm').classList.add('hidden');
    loadAllStudents();
    alert("‚úÖ Student information updated successfully!");
  } catch (error) {
    alert("‚ùå Error updating student: " + error.message);
  }
};

// Cancel Student Edit
window.cancelStudentEdit = () => {
  document.getElementById('editStudentForm').classList.add('hidden');
};

// Delete Student
window.deleteStudent=async(roll)=>{
  if(confirm("Are you sure you want to delete this student? This will also delete all their results!")) {
    try {
      // Delete student
      await remove(ref(db,"students/"+roll));
      
      // Delete student's results
      const resultsSnap = await get(child(ref(db), "results"));
      if(resultsSnap.exists()) {
        const deletePromises = [];
        resultsSnap.forEach(c => {
          const result = c.val();
          if(result.roll === roll) {
            deletePromises.push(remove(ref(db, "results/" + c.key)));
          }
        });
        await Promise.all(deletePromises);
      }
      
      loadAllStudents();
      alert("‚úÖ Student and their results deleted successfully!");
    } catch (error) {
      alert("‚ùå Error deleting student: " + error.message);
    }
  }
};

// Add Results
window.loadStudentsForResults=()=>{
  const totalWorkingDays = document.getElementById('totalWorkingDays').value;
  if(!totalWorkingDays) {
    alert("‚ö† Please enter Total Working Days first!");
    return;
  }

  get(child(ref(db),"students")).then(snap=>{
    if(!snap.exists())return resultTableContainer.innerHTML="<p>No Students Found</p>";
    
    let html=`<table><thead><tr>
      <th>#</th>
      <th>Roll</th>
      <th>Name</th>
      <th>Father</th>
      <th>Namaz</th>
      <th>Kalma</th>
      <th>Nazra</th>
      <th>Present Days</th>
      <th>Auto Fine (<span class="currency">Rs.</span> 10/day)</th>
      <th>Position</th>
    </tr></thead><tbody>`;
    
    let count = 1;
    snap.forEach(c=>{
      const s=c.val();
      html+=`<tr>
        <td>${count}</td>
        <td>${s.roll}</td>
        <td>${s.name}</td>
        <td>${s.father}</td>
        <td><input type='number' id='n${s.roll}' placeholder='0' min='0' max='${document.getElementById('namazTotal').value || 100}'></td>
        <td><input type='number' id='k${s.roll}' placeholder='0' min='0' max='${document.getElementById('kalmaTotal').value || 100}'></td>
        <td><input type='number' id='q${s.roll}' placeholder='0' min='0' max='${document.getElementById('quranTotal').value || 100}'></td>
        <td><input type='number' id='a${s.roll}' placeholder='0' min='0' max='${totalWorkingDays}' onchange="calculateAutoFine('${s.roll}')"></td>
        <td><span id='autoFine${s.roll}'><span class="currency">Rs.</span> 0</span></td>
        <td><select id='p${s.roll}'><option value=''>Select Position</option><option value='1st'>1st Position</option><option value='2nd'>2nd Position</option><option value='3rd'>3rd Position</option><option value='Pass'>Pass</option></select></td>
      </tr>`;
      count++;
    });
    html+="</tbody></table>";
    resultTableContainer.innerHTML=html;
  });
};

// Calculate automatic fine
window.calculateAutoFine = (roll) => {
  const totalWorkingDays = +document.getElementById('totalWorkingDays').value;
  const presentDays = +document.getElementById('a'+roll).value || 0;
  const absentDays = totalWorkingDays - presentDays;
  const autoFine = absentDays * 10; // Rs. 10 per absent day
  
  document.getElementById('autoFine'+roll).innerHTML = `<span class="currency">Rs.</span> ${autoFine}`;
};

// Save Results (month-wise)
window.saveAllResults=async()=>{
  const month=monthInput.value.trim();
  if(!month)return resMsg.textContent="‚ö† Enter month!";
  
  const nT=+namazTotal.value,kT=+kalmaTotal.value,qT=+quranTotal.value;
  const totalWorkingDays = +document.getElementById('totalWorkingDays').value;
  if(!totalWorkingDays)return resMsg.textContent="‚ö† Enter Total Working Days!";
  
  const snap=await get(child(ref(db),"students"));
  if(!snap.exists())return resMsg.textContent="‚ö† No Students!";
  
  const promises=[];
  snap.forEach(c=>{
    const s=c.val();
    const positionValue = document.getElementById('p'+s.roll)?.value || '';
    const presentDays = +document.getElementById('a'+s.roll)?.value || 0;
    const absentDays = totalWorkingDays - presentDays;
    const autoFine = absentDays * 10; // Rs. 10 per absent day
    
    // Calculate attendance percentage
    const attendancePercentage = totalWorkingDays > 0 ? Math.round((presentDays / totalWorkingDays) * 100) : 0;
    
    const d={
      roll:s.roll,name:s.name,father:s.father,month,
      namazObt:document.getElementById('n'+s.roll)?.value||0,
      kalmaObt:document.getElementById('k'+s.roll)?.value||0,
      quranObt:document.getElementById('q'+s.roll)?.value||0,
      presentDays: presentDays,
      totalWorkingDays: totalWorkingDays,
      attendancePercentage: attendancePercentage,
      position:positionValue,
      fine: autoFine, // Auto calculated fine
      finePaid: false, // Track if fine is paid
      namazTotal:nT,kalmaTotal:kT,quranTotal:qT
    };
    promises.push(set(ref(db,"results/"+s.roll+"_"+month),d));
  });
  await Promise.all(promises);
  resMsg.textContent="‚úÖ All Results Saved!";
};

// All Results - Default View
window.loadAllResults=()=>{
  document.getElementById('defaultResultsView').classList.remove('hidden');
  document.getElementById('rollResultsView').classList.add('hidden');
  
  get(child(ref(db),"results")).then(snap=>{
    allResultsTable.innerHTML="";
    if(snap.exists()){
      let count = 1;
      snap.forEach(c=>{
        const r=c.val();
        const obt=(+r.namazObt||0)+(+r.kalmaObt||0)+(+r.quranObt||0);
        const total=(+r.namazTotal||0)+(+r.kalmaTotal||0)+(+r.quranTotal||0);
        
        let positionClass = "";
        let positionDisplay = r.position || "-";
        
        if(r.position === "1st") positionClass = "position-1st";
        else if(r.position === "2nd") positionClass = "position-2nd";
        else if(r.position === "3rd") positionClass = "position-3rd";
        else if(r.position === "Pass") positionClass = "position-pass";
        
        // Determine fine status
        const fineStatus = r.finePaid ? 
          `<span class="fine-paid">Paid</span>` : 
          `<span class="fine-pending">Pending</span>`;
        
        allResultsTable.innerHTML+=`<tr>
          <td>${count}</td>
          <td>${r.roll}</td>
          <td>${r.name}</td>
          <td>${r.father}</td>
          <td>${r.month}</td>
          <td>${obt}/${total}</td>
          <td>${r.presentDays}/${r.totalWorkingDays} (${r.attendancePercentage}%)</td>
          <td class="${positionClass}">${positionDisplay}</td>
          <td><span class="currency">Rs.</span> ${r.fine||0}</td>
          <td>${fineStatus}</td>
          <td>
            <button class="btn-info" onclick="editResult('${c.key}')">‚úèÔ∏è Edit</button>
            <button class="btn-pay" onclick="payFine('${c.key}')">üí∞ Pay</button>
            <button class="btn-danger" onclick="deleteResult('${c.key}')">üóë Delete</button>
          </td>
        </tr>`;
        count++;
      });
    } else allResultsTable.innerHTML="<tr><td colspan='11'>No Results Found</td></tr>";
  });
};

// All Results - Grouped by Roll Number
window.loadAllResultsByRoll = () => {
  document.getElementById('defaultResultsView').classList.add('hidden');
  document.getElementById('rollResultsView').classList.remove('hidden');
  
  get(child(ref(db),"results")).then(snap=>{
    const rollResultsContainer = document.getElementById('rollResultsContainer');
    rollResultsContainer.innerHTML = "";
    
    if(!snap.exists()) {
      rollResultsContainer.innerHTML = '<div class="no-results">No Results Found</div>';
      return;
    }
    
    // Group results by roll number
    const resultsByRoll = {};
    
    snap.forEach(c => {
      const r = c.val();
      if (!resultsByRoll[r.roll]) {
        resultsByRoll[r.roll] = [];
      }
      resultsByRoll[r.roll].push({...r, key: c.key});
    });
    
    // Sort roll numbers
    const sortedRolls = Object.keys(resultsByRoll).sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));
    
    if (sortedRolls.length === 0) {
      rollResultsContainer.innerHTML = '<div class="no-results">No Results Found</div>';
      return;
    }
    
    // Create HTML for each roll number group
    sortedRolls.forEach(roll => {
      const results = resultsByRoll[roll];
      const firstResult = results[0]; // Get student info from first result
      
      const rollGroup = document.createElement('div');
      rollGroup.className = 'roll-group';
      
      // Roll header with student info
      const rollHeader = document.createElement('div');
      rollHeader.className = 'roll-header';
      rollHeader.innerHTML = `Roll Number: ${roll}`;
      
      const rollContent = document.createElement('div');
      rollContent.className = 'roll-content';
      
      // Student information
      const studentInfo = document.createElement('div');
      studentInfo.className = 'roll-student-info';
      studentInfo.innerHTML = `
        <p><strong>Student:</strong> ${firstResult.name}</p>
        <p><strong>Father:</strong> ${firstResult.father}</p>
      `;
      
      // Results table
      let resultsHTML = `
        <table class="roll-results-table">
          <thead>
            <tr>
              <th>Month</th>
              <th>Namaz</th>
              <th>Kalma</th>
              <th>Nazra</th>
              <th>Total</th>
              <th>Attendance</th>
              <th>Position</th>
              <th>Fine</th>
              <th>Status</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      results.forEach(r => {
        const obt = (+r.namazObt||0) + (+r.kalmaObt||0) + (+r.quranObt||0);
        const total = (+r.namazTotal||0) + (+r.kalmaTotal||0) + (+r.quranTotal||0);
        
        let positionClass = "";
        if(r.position === "1st") positionClass = "position-1st";
        else if(r.position === "2nd") positionClass = "position-2nd";
        else if(r.position === "3rd") positionClass = "position-3rd";
        else if(r.position === "Pass") positionClass = "position-pass";
        
        const fineStatus = r.finePaid ? 
          `<span class="fine-paid">Paid</span>` : 
          `<span class="fine-pending">Pending</span>`;
        
        resultsHTML += `
          <tr>
            <td>${r.month}</td>
            <td>${r.namazObt}/${r.namazTotal}</td>
            <td>${r.kalmaObt}/${r.kalmaTotal}</td>
            <td>${r.quranObt}/${r.quranTotal}</td>
            <td>${obt}/${total}</td>
            <td>${r.presentDays}/${r.totalWorkingDays} (${r.attendancePercentage}%)</td>
            <td class="${positionClass}">${r.position || "-"}</td>
            <td><span class="currency">Rs.</span> ${r.fine||0}</td>
            <td>${fineStatus}</td>
            <td>
              <button class="btn-info" onclick="editResult('${r.key}')">‚úèÔ∏è Edit</button>
              <button class="btn-pay" onclick="payFine('${r.key}')">üí∞ Pay</button>
              <button class="btn-danger" onclick="deleteResult('${r.key}')">üóë Delete</button>
            </td>
          </tr>
        `;
      });
      
      resultsHTML += `</tbody></table>`;
      
      rollContent.appendChild(studentInfo);
      rollContent.innerHTML += resultsHTML;
      
      rollGroup.appendChild(rollHeader);
      rollGroup.appendChild(rollContent);
      
      rollResultsContainer.appendChild(rollGroup);
    });
  });
};

// Pay Fine function
window.payFine = async (key) => {
  if(confirm("Mark this fine as paid? This action cannot be undone.")) {
    try {
      const resultRef = ref(db, "results/" + key);
      await update(resultRef, { finePaid: true });
      loadAllResults();
      alert("‚úÖ Fine marked as paid!");
    } catch (error) {
      alert("‚ùå Error updating fine status: " + error.message);
    }
  }
};

// Edit Result
window.editResult = async (key) => {
  const resultRef = ref(db, "results/" + key);
  const snapshot = await get(resultRef);
  
  if (snapshot.exists()) {
    const result = snapshot.val();
    
    // Show edit form
    document.getElementById('editResultForm').classList.remove('hidden');
    
    // Fill form with current data
    document.getElementById('editResultKey').value = key;
    document.getElementById('editNamazObt').value = result.namazObt || 0;
    document.getElementById('editKalmaObt').value = result.kalmaObt || 0;
    document.getElementById('editQuranObt').value = result.quranObt || 0;
    document.getElementById('editPresentDays').value = result.presentDays || 0;
    document.getElementById('editTotalWorkingDays').value = result.totalWorkingDays || 0;
    document.getElementById('editFine').value = result.fine || 0;
    document.getElementById('editPosition').value = result.position || '';
    
    // Scroll to edit form
    document.getElementById('editResultForm').scrollIntoView({ behavior: 'smooth' });
  }
};

// Update Result
window.updateResult = async () => {
  const key = document.getElementById('editResultKey').value;
  const resultRef = ref(db, "results/" + key);
  
  const namazObt = +document.getElementById('editNamazObt').value || 0;
  const kalmaObt = +document.getElementById('editKalmaObt').value || 0;
  const quranObt = +document.getElementById('editQuranObt').value || 0;
  const presentDays = +document.getElementById('editPresentDays').value || 0;
  const totalWorkingDays = +document.getElementById('editTotalWorkingDays').value || 0;
  const fine = +document.getElementById('editFine').value || 0;
  const position = document.getElementById('editPosition').value;
  
  // Calculate attendance percentage
  const attendancePercentage = totalWorkingDays > 0 ? Math.round((presentDays / totalWorkingDays) * 100) : 0;
  
  const updates = {
    namazObt: namazObt,
    kalmaObt: kalmaObt,
    quranObt: quranObt,
    presentDays: presentDays,
    totalWorkingDays: totalWorkingDays,
    attendancePercentage: attendancePercentage,
    fine: fine,
    position: position
  };
  
  try {
    await update(resultRef, updates);
    document.getElementById('editResultForm').classList.add('hidden');
    loadAllResults();
    alert("‚úÖ Result updated successfully!");
  } catch (error) {
    alert("‚ùå Error updating result: " + error.message);
  }
};

// Cancel Edit
window.cancelEdit = () => {
  document.getElementById('editResultForm').classList.add('hidden');
};

// Delete Result
window.deleteResult=async(key)=>{
  if(confirm("Are you sure you want to delete this result?")) {
    await remove(ref(db,"results/"+key));
    loadAllResults();
  }
};

// Delete All Results
window.showDeleteConfirmation=()=>{
  const dialog = document.createElement('div');
  dialog.className = 'confirmation-dialog';
  dialog.innerHTML = `
    <h3>‚ö† Delete All Results</h3>
    <p>Are you sure you want to delete ALL results?</p>
    <p style="color: red; font-weight: bold;">This action cannot be undone!</p>
    <button class="btn-danger" onclick="deleteAllResults()">Yes, Delete All</button>
    <button class="btn" onclick="closeConfirmation()" style="margin-left: 10px;">Cancel</button>
  `;
  
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  
  document.body.appendChild(overlay);
  document.body.appendChild(dialog);
};

window.closeConfirmation=()=>{
  const dialog = document.querySelector('.confirmation-dialog');
  const overlay = document.querySelector('.overlay');
  if(dialog) document.body.removeChild(dialog);
  if(overlay) document.body.removeChild(overlay);
};

window.deleteAllResults=async()=>{
  try {
    await remove(ref(db, "results"));
    closeConfirmation();
    loadAllResults();
    alert("‚úÖ All results deleted successfully!");
  } catch (error) {
    alert("‚ùå Error deleting results: " + error.message);
  }
};

// Flower animation function with different durations and new flowers
function createFlowers(position) {
  // No flowers for Pass students
  if(position === "Pass") return;
  
  const flowerContainer = document.createElement('div');
  flowerContainer.id = 'flowerContainer';
  flowerContainer.style.position = 'fixed';
  flowerContainer.style.top = '0';
  flowerContainer.style.left = '0';
  flowerContainer.style.width = '100%';
  flowerContainer.style.height = '100%';
  flowerContainer.style.pointerEvents = 'none';
  flowerContainer.style.zIndex = '1000';
  document.body.appendChild(flowerContainer);

  let flowers = [];
  let flowerCount = 0;
  let maxFlowers = 0;
  let duration = 0;
  let intervalTime = 0;
  
  // Set different parameters based on position with NEW FLOWERS
  if(position === "1st") {
    flowers = ["üíê", "üå∫", "üèµÔ∏è"]; // New flowers for 1st position
    maxFlowers = 25;
    duration = 7000;
    intervalTime = 150;
  } else if(position === "2nd") {
    flowers = ["üå∑", "üåª", "ü•Ä"]; // New flowers for 2nd position
    maxFlowers = 18;
    duration = 5000;
    intervalTime = 200;
  } else if(position === "3rd") {
    flowers = ["üåº", "üå∏", "üíÆ"]; // New flowers for 3rd position
    maxFlowers = 12;
    duration = 4000;
    intervalTime = 250;
  }
  
  const interval = setInterval(() => {
    if(flowerCount >= maxFlowers) {
      clearInterval(interval);
      setTimeout(() => {
        if(document.getElementById('flowerContainer')) {
          document.body.removeChild(flowerContainer);
        }
      }, 1000);
      return;
    }
    
    flowers.forEach(flower => {
      const flowerElement = document.createElement('div');
      flowerElement.className = 'flower';
      flowerElement.innerHTML = flower;
      flowerElement.style.left = Math.random() * 100 + 'vw';
      flowerElement.style.animation = `fall ${Math.random() * 2 + 3}s linear forwards`;
      flowerContainer.appendChild(flowerElement);
      
      setTimeout(() => {
        if(flowerElement.parentNode === flowerContainer) {
          flowerContainer.removeChild(flowerElement);
        }
      }, 6000);
    });
    
    flowerCount += flowers.length;
  }, intervalTime);

  setTimeout(() => {
    clearInterval(interval);
    setTimeout(() => {
      if(document.getElementById('flowerContainer')) {
        document.body.removeChild(flowerContainer);
      }
    }, 1000);
  }, duration);
}

// Check Result (Public)
window.checkResult=()=>{
  const roll=searchRoll.value.trim();
  if(!roll)return resultOutput.textContent="‚ö† Enter Roll Number!";
  
  get(child(ref(db),"results")).then(snap=>{
    if(snap.exists()){
      let found=false;
      let latestResult = null;
      
      // Find the latest result for this roll number
      snap.forEach(c=>{
        const d=c.val();
        if(d.roll===roll){
          found=true;
          // Keep the most recent result (assuming chronological order)
          if(!latestResult || d.month > latestResult.month) {
            latestResult = d;
          }
        }
      });
      
      if(found && latestResult) {
        const d = latestResult;
        const obt=(+d.namazObt)+(+d.kalmaObt)+(+d.quranObt);
        const total=(+d.namazTotal)+(+d.kalmaTotal)+(+d.quranTotal);
        
        let positionClass = "";
        let positionDisplay = d.position || "Not assigned";
        
        if(d.position === "1st") positionClass = "position-1st";
        else if(d.position === "2nd") positionClass = "position-2nd";
        else if(d.position === "3rd") positionClass = "position-3rd";
        else if(d.position === "Pass") positionClass = "position-pass";
        
        // Check if student has marks (not absent)
        const hasMarks = (+d.namazObt || +d.kalmaObt || +d.quranObt) > 0;
        
        // Create flower animation based on position with different durations
        if(d.position && d.position !== "Pass" && hasMarks) {
          createFlowers(d.position);
        }
        
        // Create result summary cards
        const summaryHTML = `
          <div class="result-summary">
            <div class="summary-card">
              <h3>Namaz</h3>
              <div class="summary-value">${d.namazObt}/${d.namazTotal}</div>
            </div>
            <div class="summary-card">
              <h3>Kalma</h3>
              <div class="summary-value">${d.kalmaObt}/${d.kalmaTotal}</div>
            </div>
            <div class="summary-card">
              <h3>Nazra</h3>
              <div class="summary-value">${d.quranObt}/${d.quranTotal}</div>
            </div>
            <div class="summary-card">
              <h3>Total</h3>
              <div class="summary-value">${obt}/${total}</div>
            </div>
          </div>
        `;
        
        resultOutput.innerHTML=`<div class="result-card">
        <h3>${d.name} (${d.roll})</h3>
        <p><b>Father:</b> ${d.father}</p>
        <p><b>Month:</b> ${d.month}</p>
        ${summaryHTML}
        ${hasMarks ? `
          <p><b>Attendance:</b> ${d.presentDays}/${d.totalWorkingDays} Days (${d.attendancePercentage}%)</p>
          <p><b>Position:</b> <span class="${positionClass}">${positionDisplay}</span></p>
          <p><b>Fine:</b> <span class="currency">Rs.</span> ${d.fine||0} ${d.finePaid ? '<span class="fine-paid">(Paid)</span>' : '<span class="fine-pending">(Pending)</span>'}</p>
        ` : `
          <p class="absent"><b>Status: ABSENT</b></p>
          <p><b>Attendance:</b> ${d.presentDays}/${d.totalWorkingDays} Days (${d.attendancePercentage}%)</p>
          <p><b>Fine:</b> <span class="currency">Rs.</span> ${d.fine||0} ${d.finePaid ? '<span class="fine-paid">(Paid)</span>' : '<span class="fine-pending">(Pending)</span>'}</p>
        `}
        </div>`;
      } else {
        // Student exists but has no results
        get(child(ref(db),"students/"+roll)).then(studentSnap=>{
          if(studentSnap.exists()){
            const student = studentSnap.val();
            resultOutput.innerHTML=`<div class="result-card">
              <h3>${student.name} (${student.roll})</h3>
              <p><b>Father:</b> ${student.father}</p>
              <p style="color: #666; font-style: italic;">No result available yet. Please check back later.</p>
            </div>`;
          } else {
            resultOutput.textContent="‚ùå No Record Found!";
          }
        });
      }
    } else {
      // No results at all
      get(child(ref(db),"students/"+roll)).then(studentSnap=>{
        if(studentSnap.exists()){
          const student = studentSnap.val();
          resultOutput.innerHTML=`<div class="result-card">
            <h3>${student.name} (${student.roll})</h3>
            <p><b>Father:</b> ${student.father}</p>
            <p style="color: #666; font-style: italic;">No result available yet. Please check back later.</p>
          </div>`;
        } else {
          resultOutput.textContent="‚ùå No Record Found!";
        }
      });
    }
  });
};

// Change Admin Code (Firebase-based)
window.changeAdminCode=async()=>{
  const old=oldCode.value.trim(),newC=newCode.value.trim();
  const snap=await get(ref(db,"admin/code"));
  const realCode=snap.exists()?snap.val():"6457";
  if(old===realCode && newC){
    await set(ref(db,"admin/code"),newC);
    codeMsg.textContent="‚úÖ Admin Code Changed Successfully!";
    oldCode.value=newCode.value="";
  } else codeMsg.textContent="‚ùå Wrong Old Code!";
};

// ===================
// ACADEMY STUDENTS SECTION
// ===================

// Toggle between Add and View Academy Students
window.toggleAcademyView = (view) => {
  const addForm = document.getElementById('addAcademyForm');
  const viewSection = document.getElementById('viewAcademySection');
  const addToggle = document.getElementById('addAcademyToggle');
  const viewToggle = document.getElementById('viewAcademyToggle');
  
  if (view === 'add') {
    addForm.classList.remove('hidden');
    viewSection.classList.add('hidden');
    addToggle.classList.add('active');
    viewToggle.classList.remove('active');
  } else {
    addForm.classList.add('hidden');
    viewSection.classList.remove('hidden');
    addToggle.classList.remove('active');
    viewToggle.classList.add('active');
    loadAcademyStudents();
  }
};

// Add Academy Student
window.addAcademyStudent = async () => {
  const name = document.getElementById('academyName').value.trim();
  const father = document.getElementById('academyFather').value.trim();
  const phone = document.getElementById('academyPhone').value.trim();
  const roll = document.getElementById('academyRoll').value.trim();
  const admission = document.getElementById('academyAdmission').value;
  const category = document.getElementById('academyCategory').value;
  const type = document.getElementById('academyType').value;
  const address = document.getElementById('academyAddress').value.trim();
  const notes = document.getElementById('academyNotes').value.trim();
  
  if (!name || !father || !roll || !category || !type) {
    document.getElementById('academyMsg').textContent = "‚ö† Please fill all required fields!";
    document.getElementById('academyMsg').className = "message error";
    return;
  }
  
  try {
    // Check if roll number already exists
    const existingStudent = await get(ref(db, "academyStudents/" + roll));
    if (existingStudent.exists()) {
      document.getElementById('academyMsg').textContent = "‚ùå Roll number already exists!";
      document.getElementById('academyMsg').className = "message error";
      return;
    }
    
    // Add academy student to database
    await set(ref(db, "academyStudents/" + roll), {
      name: name,
      father: father,
      phone: phone,
      roll: roll,
      admission: admission,
      category: category,
      type: type,
      address: address,
      notes: notes,
      status: 'active',
      createdAt: new Date().toISOString()
    });
    
    document.getElementById('academyMsg').textContent = "‚úÖ Academy Student Added Successfully!";
    document.getElementById('academyMsg').className = "message success";
    
    // Clear form
    document.getElementById('academyName').value = '';
    document.getElementById('academyFather').value = '';
    document.getElementById('academyPhone').value = '';
    document.getElementById('academyRoll').value = '';
    document.getElementById('academyAdmission').value = '';
    document.getElementById('academyCategory').value = '';
    document.getElementById('academyType').value = '';
    document.getElementById('academyAddress').value = '';
    document.getElementById('academyNotes').value = '';
    
  } catch (error) {
    document.getElementById('academyMsg').textContent = "‚ùå Error adding academy student: " + error.message;
    document.getElementById('academyMsg').className = "message error";
  }
};

// Load Academy Students
window.loadAcademyStudents = async () => {
  try {
    // Get both active and exited academy students
    const [academySnap, exitedAcademySnap] = await Promise.all([
      get(child(ref(db), "academyStudents")),
      get(child(ref(db), "exitedAcademyStudents"))
    ]);
    
    const academyStudents = [];
    const exitedAcademyStudents = [];
    
    // Process active academy students
    if (academySnap.exists()) {
      academySnap.forEach(c => {
        const student = c.val();
        academyStudents.push({
          ...student,
          status: 'active',
          id: c.key
        });
      });
    }
    
    // Process exited academy students
    if (exitedAcademySnap.exists()) {
      exitedAcademySnap.forEach(c => {
        const student = c.val();
        exitedAcademyStudents.push({
          ...student,
          status: 'exited',
          id: c.key
        });
      });
    }
    
    // Combine all academy students
    const allAcademyStudents = [...academyStudents, ...exitedAcademyStudents];
    
    // Update statistics
    updateAcademyStatistics(academyStudents.length, exitedAcademyStudents.length);
    
    // Display academy students
    displayAcademyStudents(allAcademyStudents);
    
  } catch (error) {
    console.error("Error loading academy students:", error);
    alert("‚ùå Error loading academy students data");
  }
};

// Update Academy Statistics
function updateAcademyStatistics(activeCount, exitedCount) {
  const totalCount = activeCount + exitedCount;
  
  document.getElementById('totalAcademyStudentsCount').textContent = totalCount;
  document.getElementById('activeAcademyStudentsCount').textContent = activeCount;
  document.getElementById('exitedAcademyStudentsCount').textContent = exitedCount;
  
  // Count unique academy types
  const typeFilter = document.getElementById('academyTypeFilter');
  const uniqueTypes = new Set();
  
  // Get all available types from the filter options
  for (let i = 1; i < typeFilter.options.length; i++) {
    uniqueTypes.add(typeFilter.options[i].value);
  }
  
  document.getElementById('academyTypesCount').textContent = uniqueTypes.size;
}

// Display Academy Students
function displayAcademyStudents(students) {
  const container = document.getElementById('academyStudentsList');
  const noResults = document.getElementById('noAcademyStudents');
  
  if (students.length === 0) {
    container.innerHTML = '';
    noResults.classList.remove('hidden');
    return;
  }
  
  noResults.classList.add('hidden');
  
  // Apply filters
  const searchTerm = document.getElementById('academyStudentSearch').value.toLowerCase();
  const classFilter = document.getElementById('academyClassFilter').value;
  const typeFilter = document.getElementById('academyTypeFilter').value;
  const statusFilter = document.getElementById('academyStatusFilter').value;
  
  const filteredStudents = students.filter(student => {
    // Search filter
    const matchesSearch = !searchTerm || 
      student.name.toLowerCase().includes(searchTerm) ||
      student.roll.toLowerCase().includes(searchTerm) ||
      (student.father && student.father.toLowerCase().includes(searchTerm));
    
    // Class filter
    const matchesClass = !classFilter || student.category === classFilter;
    
    // Type filter
    const matchesType = !typeFilter || student.type === typeFilter;
    
    // Status filter
    const matchesStatus = !statusFilter || student.status === statusFilter;
    
    return matchesSearch && matchesClass && matchesType && matchesStatus;
  });
  
  if (filteredStudents.length === 0) {
    container.innerHTML = '';
    noResults.classList.remove('hidden');
    return;
  }
  
  // Sort students by roll number
  filteredStudents.sort((a, b) => a.roll.localeCompare(b.roll, undefined, {numeric: true}));
  
  // Generate HTML for student cards
  container.innerHTML = filteredStudents.map(student => `
    <div class="academy-student-item ${student.status === 'exited' ? 'exited-student' : ''}">
      <div class="academy-student-item-header">
        <div class="academy-student-item-name">
          ${student.name}
          <span class="academy-type-badge">${getAcademyTypeLabel(student.type)}</span>
        </div>
        <div class="academy-student-item-roll">${student.roll}</div>
      </div>
      <div class="academy-student-item-details">
        <div><strong>Father:</strong> ${student.father || 'N/A'}</div>
        <div><strong>Class:</strong> ${student.category || 'N/A'}</div>
        <div><strong>Phone:</strong> ${student.phone || 'N/A'}</div>
        ${student.admission ? `<div><strong>Admission:</strong> ${student.admission}</div>` : ''}
        ${student.address ? `<div><strong>Address:</strong> ${student.address}</div>` : ''}
        ${student.status === 'exited' ? `
          <div><strong>Exit Date:</strong> ${student.date}</div>
          <div><strong>Reason:</strong> ${student.reason}</div>
        ` : ''}
      </div>
      <div class="academy-student-item-actions">
        ${student.status === 'active' ? `
          <button class="btn-info" onclick="viewStudentResults('${student.roll}')">üìä Results</button>
          <button class="btn-warning" onclick="editAcademyStudent('${student.roll}')">‚úèÔ∏è Edit</button>
          <button class="btn-danger" onclick="exitAcademyStudent('${student.roll}')">üö™ Exit</button>
        ` : `
          <button class="btn-info" onclick="viewStudentResults('${student.roll}')">üìä Past Results</button>
        `}
        <button class="btn" onclick="viewAcademyStudentDetails('${student.roll}')">üëÅÔ∏è View</button>
        <button class="delete-btn" onclick="deleteAcademyStudent('${student.roll}', '${student.status}')">üóë Delete</button>
      </div>
    </div>
  `).join('');
}

// Get Academy Type Label
function getAcademyTypeLabel(type) {
  const typeLabels = {
    'regular': 'Regular',
    'special': 'Special',
    'weekend': 'Weekend',
    'summer': 'Summer'
  };
  return typeLabels[type] || type;
}

// Search Academy Students
window.searchAcademyStudents = () => {
  loadAcademyStudents();
};

// Clear Academy Search
window.clearAcademySearch = () => {
  document.getElementById('academyStudentSearch').value = '';
  document.getElementById('academyClassFilter').value = '';
  document.getElementById('academyTypeFilter').value = '';
  document.getElementById('academyStatusFilter').value = '';
  loadAcademyStudents();
};

// Filter Academy Students
window.filterAcademyStudents = () => {
  loadAcademyStudents();
};

// View Academy Student Details
window.viewAcademyStudentDetails = async (roll) => {
  try {
    // Get student data from both active and exited academy collections
    const [studentSnap, exitedSnap] = await Promise.all([
      get(child(ref(db), "academyStudents/" + roll)),
      get(child(ref(db), "exitedAcademyStudents/" + roll))
    ]);
    
    let student = null;
    let status = 'unknown';
    
    if (studentSnap.exists()) {
      student = studentSnap.val();
      status = 'active';
    } else if (exitedSnap.exists()) {
      student = exitedSnap.val();
      status = 'exited';
    }
    
    if (!student) {
      alert("‚ùå Academy student not found!");
      return;
    }
    
    // Create a detailed view modal
    const modal = document.createElement('div');
    modal.className = 'confirmation-dialog';
    modal.style.width = '500px';
    modal.style.maxWidth = '90vw';
    
    modal.innerHTML = `
      <h3>üë®‚Äçüéì Academy Student Details</h3>
      <div class="academy-student-details">
        <div class="detail-item">
          <span class="detail-label">Roll Number</span>
          <span class="detail-value">${student.roll}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Student Name</span>
          <span class="detail-value">${student.name}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Father Name</span>
          <span class="detail-value">${student.father || 'N/A'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Phone Number</span>
          <span class="detail-value">${student.phone || 'N/A'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Class</span>
          <span class="detail-value">Class ${student.category}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Academy Type</span>
          <span class="detail-value">${getAcademyTypeLabel(student.type)}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Admission Date</span>
          <span class="detail-value">${student.admission || 'N/A'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Address</span>
          <span class="detail-value">${student.address || 'N/A'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Notes</span>
          <span class="detail-value">${student.notes || 'N/A'}</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Status</span>
          <span class="detail-value ${status === 'active' ? 'fine-paid' : 'fine-pending'}">${status === 'active' ? 'Active' : 'Exited'}</span>
        </div>
        ${status === 'exited' ? `
          <div class="detail-item">
            <span class="detail-label">Exit Date</span>
            <span class="detail-value">${student.date}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Exit Reason</span>
            <span class="detail-value">${student.reason}</span>
          </div>
        ` : ''}
      </div>
      <div class="academy-student-actions">
        <button class="btn" onclick="viewStudentResults('${student.roll}')">üìä View Results</button>
        ${status === 'active' ? `
          <button class="btn-warning" onclick="editAcademyStudent('${student.roll}')">‚úèÔ∏è Edit</button>
        ` : ''}
        <button class="delete-btn" onclick="deleteAcademyStudent('${student.roll}', '${status}')">üóë Delete</button>
        <button class="btn" onclick="closeModal()">Close</button>
      </div>
    `;
    
    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    
    document.body.appendChild(overlay);
    document.body.appendChild(modal);
    
    window.closeModal = () => {
      document.body.removeChild(overlay);
      document.body.removeChild(modal);
    };
    
  } catch (error) {
    console.error("Error viewing academy student details:", error);
    alert("‚ùå Error loading academy student details");
  }
};

// Edit Academy Student
window.editAcademyStudent = async (roll) => {
  // Implementation for editing academy student
  alert("Edit Academy Student functionality will be implemented here for roll: " + roll);
};

// Exit Academy Student
window.exitAcademyStudent = async (roll) => {
  const exitDate = prompt("Enter exit date (YYYY-MM-DD):");
  if (!exitDate) return;
  
  const exitReason = prompt("Enter reason for exit:");
  if (!exitReason) return;
  
  try {
    // Get student data
    const studentSnap = await get(child(ref(db), "academyStudents/" + roll));
    if (!studentSnap.exists()) {
      alert("‚ùå Academy student not found!");
      return;
    }
    
    const student = studentSnap.val();
    
    // Move to exited academy students
    await set(ref(db, "exitedAcademyStudents/" + roll), {
      ...student,
      date: exitDate,
      reason: exitReason,
      exitedAt: new Date().toISOString()
    });
    
    // Remove from active academy students
    await remove(ref(db, "academyStudents/" + roll));
    
    alert("‚úÖ Academy student exited successfully!");
    loadAcademyStudents();
    
  } catch (error) {
    alert("‚ùå Error exiting academy student: " + error.message);
  }
};

// Delete Academy Student
window.deleteAcademyStudent = async (roll, status) => {
  const studentType = status === 'active' ? 'academy student' : 'exited academy student';
  
  if (!confirm(`Are you sure you want to delete this ${studentType}? This action cannot be undone!`)) {
    return;
  }
  
  try {
    if (status === 'active') {
      // Delete from active academy students
      await remove(ref(db, "academyStudents/" + roll));
    } else {
      // Delete from exited academy students
      await remove(ref(db, "exitedAcademyStudents/" + roll));
    }
    
    // Also delete any results for this student
    const resultsSnap = await get(child(ref(db), "results"));
    if (resultsSnap.exists()) {
      const deletePromises = [];
      resultsSnap.forEach(c => {
        const result = c.val();
        if (result.roll === roll) {
          deletePromises.push(remove(ref(db, "results/" + c.key)));
        }
      });
      await Promise.all(deletePromises);
    }
    
    alert("‚úÖ Academy student deleted successfully!");
    loadAcademyStudents();
    
  } catch (error) {
    alert("‚ùå Error deleting academy student: " + error.message);
  }
};

// View Student Results
window.viewStudentResults = (roll) => {
  // Set the roll number in the search field and check result
  document.getElementById('searchRoll').value = roll;
  showSection('resultSection');
  setTimeout(() => {
    checkResult();
  }, 100);
};
</script>
</body>
</html>