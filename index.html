<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Faizan-e-Raza Madarsa Result Portal</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5fff5; margin: 0; padding: 0; }
    header { background: linear-gradient(to right, #228b22, #d4af37); color: white; text-align: center; padding: 1rem; font-size: 1.4rem; font-weight: bold; }
    nav { display: flex; justify-content: center; background: #e8f5e9; border-bottom: 2px solid #c5e1a5; flex-wrap: wrap; }
    nav button { margin: 5px; padding: 10px 18px; border: none; background: #2e7d32; color: white; border-radius: 5px; cursor: pointer; }
    nav button:hover { background: #1b5e20; }
    section { display: none; padding: 20px; }
    .active { display: block; }
    .hidden { display: none; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
    .btn { background: #388e3c; color: white; border: none; padding: 8px 14px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
    .btn:hover { background: #2e7d32; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #c8e6c9; }
  </style>
</head>
<body>
  <header>üïå Faizan-e-Raza Madarsa Result Portal</header>

  <nav>
    <button onclick="showSection('resultSection')">Check Result</button>
    <button id="loginBtn" onclick="showSection('loginSection')">Admin Login</button>
    <button id="studentBtn" class="hidden" onclick="showSection('studentSection')">Add Student</button>
    <button id="studentListBtn" class="hidden" onclick="showSection('studentListSection')">Student List</button>
    <button id="exitListBtn" class="hidden" onclick="showSection('exitListSection')">Exit Student List</button>
    <button id="resultBtn" class="hidden" onclick="showSection('addResultSection')">Add Result</button>
    <button id="allResultBtn" class="hidden" onclick="showSection('allResultsSection')">All Results List</button>
    <button id="deleteResultBtn" class="hidden" onclick="showSection('deleteResultSection')">Delete Result</button>
    <button id="changeCodeBtn" class="hidden" onclick="showSection('changeCodeSection')">Change Admin Code</button>
    <button id="logoutBtn" class="hidden" onclick="adminLogout()">Logout</button>
  </nav>

  <!-- üîπ Result Check -->
  <section id="resultSection" class="active">
    <h2>Check Student Result</h2>
    <input type="text" id="searchRoll" placeholder="Enter Roll Number">
    <button class="btn" onclick="checkResult()">Check</button>
    <div id="resultOutput"></div>
  </section>

  <!-- üîπ Admin Login -->
  <section id="loginSection">
    <h2>Admin Login</h2>
    <input type="password" id="adminCode" placeholder="Enter Admin Code">
    <button class="btn" onclick="adminLogin()">Login</button>
    <p id="loginMsg"></p>
  </section>

  <!-- üîπ Add Student + Exit Student -->
  <section id="studentSection">
    <h2>Add Student</h2>
    <input type="text" id="name" placeholder="Student Name">
    <input type="text" id="roll" placeholder="Roll Number">
    <input type="date" id="admission">

    <select id="category">
      <option value="">Select Class/Category</option>
      <option value="Noorani Qaida">Noorani Qaida</option>
      <option value="Separa">Separa</option>
      <option value="Nazra">Nazra</option>
      <option value="Hifz">Hifz</option>
    </select>

    <button class="btn" onclick="addStudent()">Add Student</button>
    <p id="stdMsg"></p>

    <hr>
    <h2>Exit Student</h2>
    <input type="text" id="exitRoll" placeholder="Enter Roll Number">
    <input type="date" id="exitDate">
    <input type="text" id="exitReason" placeholder="Reason for Exit">
    <button class="btn" onclick="exitStudent()">Exit Student</button>
    <p id="exitMsg"></p>
  </section>

  <!-- üîπ Student List -->
  <section id="studentListSection">
    <h2>All Students</h2>
    <button class="btn" onclick="loadStudentList()">Refresh List</button>
    <table>
      <thead><tr><th>Roll</th><th>Name</th><th>Class</th><th>Admission Date</th></tr></thead>
      <tbody id="studentTable"></tbody>
    </table>
  </section>

  <!-- üîπ Exit Student List -->
  <section id="exitListSection">
    <h2>Exit Student List</h2>
    <button class="btn" onclick="loadExitList()">Refresh Exit List</button>
    <table>
      <thead><tr><th>Roll</th><th>Name</th><th>Exit Date</th><th>Reason</th></tr></thead>
      <tbody id="exitTable"></tbody>
    </table>
  </section>

  <!-- üîπ Add Result -->
  <section id="addResultSection">
    <h2>Add Result</h2>
    <select id="rRoll"></select>
    <input type="text" id="rName" placeholder="Name">
    <input type="text" id="month" placeholder="Month (e.g. October)">
    <input type="number" id="namazObt" placeholder="Namaz Obtained">
    <input type="number" id="namazTotal" placeholder="Namaz Total">
    <input type="number" id="quranObt" placeholder="Quran Obtained">
    <input type="number" id="quranTotal" placeholder="Quran Total">
    <input type="number" id="kalmaObt" placeholder="Kalma Obtained">
    <input type="number" id="kalmaTotal" placeholder="Kalma Total">
    <input type="number" id="attendance" placeholder="Attendance (%)">
    <button class="btn" onclick="addResult()">Add Result</button>
    <p id="resMsg"></p>
  </section>

  <!-- üîπ All Results List -->
  <section id="allResultsSection">
    <h2>All Students Results</h2>
    <button class="btn" onclick="loadAllResults()">Refresh All Results</button>
    <table>
      <thead>
        <tr><th>Roll</th><th>Name</th><th>Month</th><th>Total Marks</th><th>Attendance</th></tr>
      </thead>
      <tbody id="allResultsTable"></tbody>
    </table>
  </section>

  <!-- üîπ Delete Result -->
  <section id="deleteResultSection">
    <h2>Delete Result</h2>
    <select id="delRoll"></select>
    <button class="btn" onclick="deleteResult()">Delete Selected Result</button>
    <p id="delMsg"></p>
  </section>

  <!-- üîπ Change Admin Code -->
  <section id="changeCodeSection">
    <h2>Change Admin Code</h2>
    <input type="password" id="oldCode" placeholder="Enter Old Code">
    <input type="password" id="newCode" placeholder="Enter New Code">
    <button class="btn" onclick="changeAdminCode()">Change Code</button>
    <p id="codeMsg"></p>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, get, child, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_zOJiXH5ZSHs4miirkF4p7Fc6NUDuNiY",
      authDomain: "faizan-e-raza-madarsa-8c743.firebaseapp.com",
      databaseURL: "https://faizan-e-raza-madarsa-8c743-default-rtdb.firebaseio.com",
      projectId: "faizan-e-raza-madarsa-8c743",
      storageBucket: "faizan-e-raza-madarsa-8c743.firebasestorage.app",
      messagingSenderId: "659467130617",
      appId: "1:659467130617:web:9ed42e7bb8e3eea5917428"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.showSection = id => {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    };

    if (!localStorage.getItem("adminCode")) localStorage.setItem("adminCode", "6457");

    window.adminLogin = function () {
      const inputCode = adminCode.value.trim();
      const msg = loginMsg;
      const saved = localStorage.getItem("adminCode");
      if (inputCode === saved) {
        msg.textContent = "‚úÖ Login Successful!";
        msg.style.color = "green";
        ["loginBtn","studentBtn","resultBtn","logoutBtn","studentListBtn","changeCodeBtn","exitListBtn","allResultBtn","deleteResultBtn"].forEach(id => document.getElementById(id).classList.toggle("hidden"));
        showSection("studentSection");
        loadRollNumbers();
      } else {
        msg.textContent = "‚ùå Wrong Code!";
        msg.style.color = "red";
      }
    };

    window.adminLogout = function () {
      ["loginBtn","studentBtn","resultBtn","logoutBtn","studentListBtn","changeCodeBtn","exitListBtn","allResultBtn","deleteResultBtn"].forEach(id => document.getElementById(id).classList.toggle("hidden"));
      showSection("resultSection");
      alert("Logged out successfully!");
    };

    // --- Add Student ---
    window.addStudent = function () {
      const name = name.value.trim();
      const roll = roll.value.trim();
      const admission = admission.value;
      const category = category.value;
      const msg = stdMsg;
      if (!name || !roll || !category) {
        msg.textContent = "‚ö† Please fill all fields!";
        return;
      }
      set(ref(db, "students/" + roll), { name, roll, admission, category })
        .then(() => { msg.textContent = "‚úÖ Student Added Successfully!"; loadRollNumbers(); })
        .catch(e => msg.textContent = "‚ùå Error: " + e.message);
    };

    // --- Exit Student ---
    window.exitStudent = async function () {
      const roll = exitRoll.value.trim();
      const date = exitDate.value;
      const reason = exitReason.value.trim();
      const msg = exitMsg;
      if (!roll || !date || !reason) {
        msg.textContent = "‚ö† Please fill all fields!";
        msg.style.color = "red";
        return;
      }
      const snapshot = await get(child(ref(db), "students/" + roll));
      if (snapshot.exists()) {
        const s = snapshot.val();
        await set(ref(db, "exited/" + roll), { roll, name: s.name, date, reason });
        await remove(ref(db, "students/" + roll));
        await remove(ref(db, "results/" + roll));
        msg.textContent = "‚úÖ Student Exited & Removed Successfully!";
        msg.style.color = "green";
      } else {
        msg.textContent = "‚ùå Roll not found!";
        msg.style.color = "red";
      }
    };

    // --- Student List ---
    window.loadStudentList = function () {
      const table = studentTable;
      get(child(ref(db), "students")).then(snap => {
        table.innerHTML = "";
        if (snap.exists()) {
          snap.forEach(c => {
            const s = c.val();
            table.innerHTML += `<tr><td>${s.roll}</td><td>${s.name}</td><td>${s.category||"-"}</td><td>${s.admission||"-"}</td></tr>`;
          });
        } else table.innerHTML = "<tr><td colspan='4'>No Students Found</td></tr>";
      });
    };

    // --- Exit List ---
    window.loadExitList = function () {
      const table = exitTable;
      get(child(ref(db), "exited")).then(snap => {
        table.innerHTML = "";
        if (snap.exists()) {
          snap.forEach(c => {
            const s = c.val();
            table.innerHTML += `<tr><td>${s.roll}</td><td>${s.name||"-"}</td><td>${s.date}</td><td>${s.reason}</td></tr>`;
          });
        } else table.innerHTML = "<tr><td colspan='4'>No Exit Students Found</td></tr>";
      });
    };

    // --- Load Roll Numbers ---
    window.loadRollNumbers = function () {
      const select = rRoll;
      select.innerHTML = "";
      get(child(ref(db), "students")).then(snap => {
        if (snap.exists()) {
          select.innerHTML = "<option value=''>Select Roll Number</option>";
          snap.forEach(c => {
            const s = c.val();
            select.innerHTML += `<option value='${s.roll}'>${s.roll} - ${s.name}</option>`;
          });
        } else select.innerHTML = "<option>No Students Found</option>";
      });

      // Also fill delete result dropdown
      const delSelect = delRoll;
      delSelect.innerHTML = "";
      get(child(ref(db), "results")).then(snap => {
        if (snap.exists()) {
          delSelect.innerHTML = "<option value=''>Select Roll to Delete</option>";
          snap.forEach(c => {
            const s = c.val();
            delSelect.innerHTML += `<option value='${s.roll}'>${s.roll} - ${s.name}</option>`;
          });
        } else delSelect.innerHTML = "<option>No Results Found</option>";
      });
    };

    // --- Add Result ---
    window.addResult = function () {
      const roll = rRoll.value.trim();
      const name = rName.value.trim();
      const month = month.value.trim();
      if (!roll || !name || !month) return resMsg.textContent = "‚ö† Please fill all main fields!";
      set(ref(db, "results/" + roll), {
        roll, name, month,
        namazObt: namazObt.value, namazTotal: namazTotal.value,
        quranObt: quranObt.value, quranTotal: quranTotal.value,
        kalmaObt: kalmaObt.value, kalmaTotal: kalmaTotal.value,
        attendance: attendance.value
      }).then(() => { resMsg.textContent = "‚úÖ Result Added Successfully!"; loadRollNumbers(); });
    };

    // --- All Students Results ---
    window.loadAllResults = function () {
      const table = allResultsTable;
      get(child(ref(db), "results")).then(snap => {
        table.innerHTML = "";
        if (snap.exists()) {
          snap.forEach(c => {
            const r = c.val();
            const totalObt = (+r.namazObt||0)+(+r.quranObt||0)+(+r.kalmaObt||0);
            const totalMarks = (+r.namazTotal||0)+(+r.quranTotal||0)+(+r.kalmaTotal||0);
            table.innerHTML += `
              <tr>
                <td>${r.roll}</td>
                <td>${r.name}</td>
                <td>${r.month}</td>
                <td>${totalObt}/${totalMarks}</td>
                <td>${r.attendance||"-"}%</td>
              </tr>`;
          });
        } else table.innerHTML = "<tr><td colspan='5'>No Results Found</td></tr>";
      });
    };

    // --- Delete Result ---
    window.deleteResult = async function () {
      const roll = delRoll.value.trim();
      const msg = delMsg;
      if (!roll) {
        msg.textContent = "‚ö† Please select a Roll Number!";
        msg.style.color = "red";
        return;
      }
      const snapshot = await get(child(ref(db), "results/" + roll));
      if (snapshot.exists()) {
        await remove(ref(db, "results/" + roll));
        msg.textContent = "‚úÖ Result deleted successfully!";
        msg.style.color = "green";
        loadRollNumbers();
      } else {
        msg.textContent = "‚ùå Result not found!";
        msg.style.color = "red";
      }
    };

    // --- Change Admin Code ---
    window.changeAdminCode = function () {
      const oldC = oldCode.value.trim(), newC = newCode.value.trim();
      if (oldC === localStorage.getItem("adminCode") && newC) {
        localStorage.setItem("adminCode", newC);
        codeMsg.textContent = "‚úÖ Code Changed!";
        codeMsg.style.color = "green";
      } else {
        codeMsg.textContent = "‚ùå Wrong old code!";
        codeMsg.style.color = "red";
      }
    };

    // --- Check Result ---
    window.checkResult = function () {
      const roll = searchRoll.value.trim();
      const out = resultOutput;
      get(child(ref(db), "results/" + roll)).then(snap => {
        if (snap.exists()) {
          const d = snap.val();
          const obt = (+d.namazObt||0)+(+d.quranObt||0)+(+d.kalmaObt||0);
          const total = (+d.namazTotal||0)+(+d.quranTotal||0)+(+d.kalmaTotal||0);
          out.innerHTML = `
            <h3>${d.name} (Roll: ${d.roll})</h3>
            <p><b>Month:</b> ${d.month}</p>
            <p>üïå Namaz: ${d.namazObt}/${d.namazTotal}</p>
            <p>üìñ Quran: ${d.quranObt}/${d.quranTotal}</p>
            <p>‚ò™ Kalma: ${d.kalmaObt}/${d.kalmaTotal}</p>
            <p>üìÖ Attendance: ${d.attendance}%</p>
            <hr><b>Total Marks:</b> ${obt}/${total}`;
        } else out.innerHTML = "‚ùå No record found!";
      });
    };
  </script>
</body>
</html>
