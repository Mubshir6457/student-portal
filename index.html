<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Faizana Raza Mudrasa Results System</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Tahoma', Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 15px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            border: 3px solid #667eea;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #4b0082;
            font-size: 2.2rem;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .header h2 {
            color: #764ba2;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid #667eea;
            flex-wrap: wrap;
            gap: 1px;
        }

        .tab {
            flex: 1;
            padding: 16px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 700;
            color: #4b0082;
            font-size: 1rem;
            min-width: 120px;
            border-bottom: 3px solid transparent;
        }

        .tab:hover {
            background: linear-gradient(135deg, #f3e8ff 0%, #e0f2fe 100%);
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom: 3px solid #ffd700;
        }

        .content {
            display: none;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            margin-bottom: 25px;
            border: 2px solid #667eea;
        }

        .content.active {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Public Results Page */
        .public-results {
            background: linear-gradient(135deg, #f8f4ff 0%, #f0f9ff 100%);
        }

        .search-box {
            background: white;
            padding: 22px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid #8b5cf6;
        }

        .search-box h3 {
            color: #4b0082;
            margin-bottom: 18px;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #4b0082;
            font-weight: 600;
            font-size: 1rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #c4b5fd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }

        .btn:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .btn-excel {
            background: linear-gradient(135deg, #0ea5e9 0%, #3b82f6 100%);
        }

        .btn-info {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .btn-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }

        .result-card {
            background: white;
            padding: 22px;
            border-radius: 15px;
            border-left: 6px solid #667eea;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
            border: 2px solid #e9d5ff;
            position: relative;
            overflow: hidden;
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
        }

        .result-card h3 {
            color: #4b0082;
            margin-bottom: 12px;
            font-size: 1.25rem;
            padding-bottom: 10px;
            border-bottom: 2px solid #f3f4f6;
        }

        .position-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 2;
            flex-direction: column;
            text-align: center;
        }

        .position-1 {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #8B4513 !important;
        }

        .position-2 {
            background: linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%);
        }

        .position-3 {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
        }

        .position-text {
            font-size: 0.7rem;
            margin-top: 2px;
        }

        .grade-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            margin-top: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .grade-a { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .grade-b { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .grade-c { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .grade-d { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .grade-f { background: linear-gradient(135deg, #64748b 0%, #475569 100%); color: white; }

        /* Add Result Page */
        .add-result-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        @media (min-width: 1024px) {
            .add-result-container {
                grid-template-columns: 380px 1fr;
            }
        }

        .student-list-panel {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 22px;
            border-radius: 15px;
            border: 2px solid #c4b5fd;
            height: 500px;
            overflow-y: auto;
        }

        .student-list-panel h3 {
            color: #4b0082;
            margin-bottom: 18px;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .student-item {
            background: white;
            padding: 16px;
            margin-bottom: 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e2e8f0;
            position: relative;
        }

        .student-item:hover {
            background: linear-gradient(135deg, #f3e8ff 0%, #e0f2fe 100%);
            transform: translateX(5px);
            border-color: #c4b5fd;
        }

        .student-item.selected {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #4b0082;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .student-item h4 {
            color: inherit;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }

        .student-item .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .student-item:hover .delete-btn {
            display: flex;
        }

        .result-form-panel {
            background: white;
            padding: 22px;
            border-radius: 15px;
            border: 2px solid #c4b5fd;
        }

        .result-form-panel h3 {
            color: #4b0082;
            margin-bottom: 22px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            margin-bottom: 18px;
        }

        @media (min-width: 768px) {
            .form-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Subjects Grid */
        .subjects-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px;
            margin: 20px 0;
        }

        @media (min-width: 768px) {
            .subjects-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        .subject-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .subject-card:hover {
            border-color: #c4b5fd;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .subject-card h4 {
            color: #4b0082;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.1rem;
        }

        .marks-input {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .marks-input label {
            color: #4b0082;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .marks-input input {
            width: 100px;
            text-align: center;
            padding: 10px;
            border: 2px solid #c4b5fd;
            border-radius: 8px;
            background: white;
        }

        /* Attendance Page */
        .attendance-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        @media (min-width: 1024px) {
            .attendance-container {
                grid-template-columns: 350px 1fr;
            }
        }

        .attendance-controls {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 22px;
            border-radius: 15px;
            border: 2px solid #c4b5fd;
        }

        .attendance-list {
            background: white;
            padding: 22px;
            border-radius: 15px;
            border: 2px solid #c4b5fd;
            max-height: 600px;
            overflow-y: auto;
        }

        .attendance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 18px;
        }

        .attendance-card {
            background: #f8fafc;
            padding: 18px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .attendance-card.present {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }

        .attendance-card.absent {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border-color: #ef4444;
        }

        .status-toggle {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .status-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .present-btn {
            background: #d1fae5;
            color: #065f46;
        }

        .present-btn:hover, .present-btn.active {
            background: #10b981;
            color: white;
            box-shadow: 0 3px 10px rgba(16, 185, 129, 0.3);
        }

        .absent-btn {
            background: #fee2e2;
            color: #991b1b;
        }

        .absent-btn:hover, .absent-btn.active {
            background: #ef4444;
            color: white;
            box-shadow: 0 3px 10px rgba(239, 68, 68, 0.3);
        }

        /* Admin Management Page */
        .admin-management {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .export-section {
            background: white;
            padding: 22px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 2px solid #c4b5fd;
            transition: all 0.3s ease;
        }

        .export-section:hover {
            border-color: #8b5cf6;
            transform: translateY(-2px);
        }

        .export-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        /* Message Styling */
        .message {
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 22px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
            border: 2px solid;
            animation: slideIn 0.4s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        @keyframes slideIn {
            from { transform: translateY(-15px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .message.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border-color: #10b981;
        }

        .message.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border-color: #ef4444;
        }

        .message.info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border-color: #3b82f6;
        }

        .message.warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border-color: #f59e0b;
        }

        /* Position Selection */
        .position-section {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #f59e0b;
        }

        .position-section h3 {
            color: #92400e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .position-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .position-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .position-card.selected {
            border-color: #f59e0b;
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3);
        }

        .position-card h4 {
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .position-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .position-selector select {
            flex: 1;
            padding: 8px;
            border: 2px solid #c4b5fd;
            border-radius: 8px;
            background: white;
        }

        /* Results Summary Section */
        .results-summary {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #3b82f6;
        }

        .results-summary h3 {
            color: #1e40af;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            text-align: center;
        }

        .summary-card h4 {
            color: #1e40af;
            margin-bottom: 10px;
        }

        .summary-value {
            font-size: 2rem;
            font-weight: bold;
            color: #3b82f6;
        }

        /* Admin Panel */
        .admin-panel {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 1000;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .admin-btn {
            background: linear-gradient(135deg, #4b0082 0%, #667eea 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            box-shadow: 0 4px 15px rgba(75, 0, 130, 0.2);
        }

        .admin-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #4b0082 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(75, 0, 130, 0.3);
        }

        .logout-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-bottom: 2px solid #e2e8f0;
            }
            
            .content {
                padding: 18px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .header h2 {
                font-size: 1.1rem;
            }
            
            .admin-panel {
                position: static;
                margin-bottom: 15px;
                justify-content: center;
            }
            
            .results-grid,
            .attendance-grid {
                grid-template-columns: 1fr;
            }
            
            .export-buttons {
                grid-template-columns: 1fr;
            }
            
            .student-list-panel,
            .attendance-controls {
                height: auto;
                max-height: 400px;
            }
            
            .position-grid,
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .position-badge {
                width: 40px;
                height: 40px;
                font-size: 1rem;
            }
            
            .position-text {
                font-size: 0.6rem;
            }
            
            .file-input-container {
                flex-direction: column;
            }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            border-left: 5px solid #667eea;
            z-index: 2000;
            animation: slideUp 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
        }

        @keyframes slideUp {
            from { transform: translateY(100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .toast.success {
            border-left-color: #10b981;
        }

        .toast.error {
            border-left-color: #ef4444;
        }

        .toast.info {
            border-left-color: #3b82f6;
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            background: #667eea;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            margin-bottom: 15px;
            width: 100%;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
            
            .tabs {
                display: none;
            }
            
            .tabs.mobile-open {
                display: flex;
            }
        }

        /* File Input Styling */
        .file-input-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }

        .file-input-container input[type="file"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #c4b5fd;
            border-radius: 8px;
            background: white;
        }

        .excel-preview {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #c4b5fd;
            border-radius: 10px;
            padding: 15px;
            background: #f8fafc;
        }

        .excel-preview table {
            width: 100%;
            border-collapse: collapse;
        }

        .excel-preview th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: left;
            position: sticky;
            top: 0;
        }

        .excel-preview td {
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
        }

        .excel-preview tr:nth-child(even) td {
            background: #f8fafc;
        }

        /* Class-wise Position Selection */
        .class-position-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .class-position-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .class-position-card:hover {
            border-color: #f59e0b;
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.1);
        }

        .class-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }

        .class-position-card.separa .class-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .class-position-card.noorani .class-header {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        /* Load Students Button */
        .load-students-btn {
            margin-bottom: 15px;
        }

        /* Excel File Upload Section */
        .excel-upload-section {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 2px solid #10b981;
        }

        .excel-upload-section h3 {
            color: #065f46;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fine-summary {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #f59e0b;
        }

        .fine-summary h4 {
            color: #92400e;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .monthly-fine-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .monthly-fine-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #f59e0b;
        }

        .monthly-fine-card h5 {
            color: #92400e;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Public Results Page (Default) -->
        <div class="header">
            <h1>üåô Faizana Raza Mudrasa</h1>
            <h2>Islamic Education Management System</h2>
        </div>

        <!-- Mobile Menu Toggle -->
        <button class="menu-toggle" onclick="toggleMobileMenu()">‚ò∞ Menu</button>

        <!-- Admin Panel -->
        <div class="admin-panel">
            <a href="#" class="admin-btn" onclick="showAdminLogin()">üîê Admin Login</a>
            <a href="#" class="admin-btn logout-btn" onclick="logout()" style="display: none;" id="logoutBtn">üö™ Logout</a>
        </div>

        <!-- Tabs Navigation -->
        <div class="tabs" id="mobileTabs">
            <div class="tab active" onclick="showTab('publicResults')">üìñ Check Results</div>
            <div class="tab" onclick="showTab('addResult')" id="adminTab1" style="display: none;">‚ûï Add Result</div>
            <div class="tab" onclick="showTab('addStudent')" id="adminTab2" style="display: none;">üë®‚Äçüéì Add Student</div>
            <div class="tab" onclick="showTab('attendance')" id="adminTab3" style="display: none;">üìã Attendance</div>
            <div class="tab" onclick="showTab('adminManagement')" id="adminTab4" style="display: none;">‚öôÔ∏è Admin Panel</div>
        </div>

        <!-- Message Container -->
        <div id="messageContainer"></div>

        <!-- Public Results Tab -->
        <div id="publicResults" class="content active public-results">
            <!-- Individual Search -->
            <div class="search-box">
                <h3>üîç Check Individual Student Result</h3>
                <div class="form-group">
                    <label>Enter Student Roll Number:</label>
                    <input type="text" id="searchQuery" placeholder="e.g., 101, 102, etc.">
                </div>
                <button class="btn" onclick="searchResults()">Check Result</button>
            </div>

            <!-- Individual Results Display -->
            <div id="searchResults" class="results-grid"></div>
        </div>

        <!-- Add Result Tab -->
        <div id="addResult" class="content">
            <div class="add-result-container">
                <!-- Student List Panel -->
                <div class="student-list-panel">
                    <h3>üë®‚Äçüéì Select Student</h3>
                    <input type="text" id="studentSearch" placeholder="Search by roll number or name..." 
                           onkeyup="filterStudents()" class="form-group" style="margin-bottom: 20px;">
                    <div id="studentList"></div>
                </div>

                <!-- Result Form Panel -->
                <div class="result-form-panel">
                    <h3>üìù Add Result for <span id="selectedStudentName">[Select Student]</span></h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Roll Number</label>
                            <input type="text" id="resultStudentRoll" readonly>
                        </div>
                        <div class="form-group">
                            <label>Student Name</label>
                            <input type="text" id="resultStudentName" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Exam Month</label>
                        <select id="examMonth">
                            <option value="January">January</option>
                            <option value="February">February</option>
                            <option value="March">March</option>
                            <option value="April">April</option>
                            <option value="May">May</option>
                            <option value="June">June</option>
                            <option value="July">July</option>
                            <option value="August">August</option>
                            <option value="September">September</option>
                            <option value="October">October</option>
                            <option value="November">November</option>
                            <option value="December">December</option>
                        </select>
                    </div>
                    
                    <h4 style="color: #4b0082; margin: 20px 0 15px 0; display: flex; align-items: center; gap: 10px;">üìö Subjects Marks</h4>
                    
                    <div class="subjects-grid">
                        <!-- Nazra -->
                        <div class="subject-card">
                            <h4>Nazra <span style="color: #666; font-size: 0.9em;">(Total: <span id="nazraTotalDisplay">100</span>)</span></h4>
                            <div class="marks-input">
                                <label>Obtained Marks:</label>
                                <input type="number" id="nazraMarks" min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="marks-input">
                                <label>Total Marks:</label>
                                <input type="number" id="nazraTotal" value="100" min="1" max="200" onchange="updateSubjectTotal('nazra')">
                            </div>
                        </div>
                        
                        <!-- Kalma -->
                        <div class="subject-card">
                            <h4>Kalma <span style="color: #666; font-size: 0.9em;">(Total: <span id="kalmaTotalDisplay">100</span>)</span></h4>
                            <div class="marks-input">
                                <label>Obtained Marks:</label>
                                <input type="number" id="kalmaMarks" min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="marks-input">
                                <label>Total Marks:</label>
                                <input type="number" id="kalmaTotal" value="100" min="1" max="200" onchange="updateSubjectTotal('kalma')">
                            </div>
                        </div>
                        
                        <!-- Namaz -->
                        <div class="subject-card">
                            <h4>Namaz <span style="color: #666; font-size: 0.9em;">(Total: <span id="namazTotalDisplay">100</span>)</span></h4>
                            <div class="marks-input">
                                <label>Obtained Marks:</label>
                                <input type="number" id="namazMarks" min="0" max="100" placeholder="0-100">
                            </div>
                            <div class="marks-input">
                                <label>Total Marks:</label>
                                <input type="number" id="namazTotal" value="100" min="1" max="200" onchange="updateSubjectTotal('namaz')">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-top: 20px;">
                        <div class="form-group">
                            <label>Total Obtained</label>
                            <input type="text" id="totalObtained" readonly>
                        </div>
                        <div class="form-group">
                            <label>Overall Total</label>
                            <input type="text" id="overallTotal" readonly>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Percentage</label>
                            <input type="text" id="percentage" readonly>
                        </div>
                        <div class="form-group">
                            <label>Grade</label>
                            <select id="grade">
                                <option value="A+">A+ (90-100%)</option>
                                <option value="A">A (80-89%)</option>
                                <option value="B">B (70-79%)</option>
                                <option value="C">C (60-69%)</option>
                                <option value="D">D (50-59%)</option>
                                <option value="F">F (Below 50%)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Fine Information in Add Result -->
                    <div id="fineInfoInAdd" style="display: none; margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border: 2px solid #f59e0b;">
                        <h4 style="color: #92400e; margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">üí∞ Fine Information</h4>
                        <p style="color: #92400e; margin: 5px 0;">Absent Days: <span id="absentDaysCount">0</span></p>
                        <p style="color: #92400e; margin: 5px 0;">Fine Amount: ‚Çπ<span id="fineAmount">0</span></p>
                    </div>

                    <button class="btn btn-success" onclick="addResult()" style="width: 100%; padding: 16px; font-size: 18px;">
                        ‚úÖ Save Result
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Student Tab -->
        <div id="addStudent" class="content">
            <div class="add-student-container">
                <h3 style="color: #4b0082; margin-bottom: 30px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 10px;">üë®‚Äçüéì Register New Student</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Roll Number (Assigned by Admin)</label>
                        <input type="text" id="studentRoll" placeholder="e.g., 101, 102, etc.">
                    </div>
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="studentName" placeholder="Enter full name">
                    </div>
                </div>

                <div class="form-group">
                    <label>Class</label>
                    <select id="studentClass">
                        <option value="Noorani Qayda">Noorani Qayda</option>
                        <option value="Separa">Separa</option>
                    </select>
                </div>
                
                <button class="btn btn-purple" onclick="addStudent()" style="width: 100%; padding: 16px; font-size: 18px;">
                    üìù Register Student
                </button>

                <!-- Students List -->
                <div style="margin-top: 40px;">
                    <h3 style="color: #4b0082; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">üìã Registered Students</h3>
                    <div id="allStudentsList"></div>
                </div>
            </div>
        </div>

        <!-- Attendance Tab -->
        <div id="attendance" class="content">
            <div class="attendance-container">
                <div class="attendance-controls">
                    <!-- Excel File Upload Section -->
                    <div class="excel-upload-section">
                        <h3>üìÅ Excel File Management</h3>
                        <p style="color: #065f46; margin-bottom: 15px;">
                            Upload your attendance Excel file. New attendance will be added to this file automatically.
                        </p>
                        
                        <div class="file-input-container">
                            <input type="file" id="excelFile" accept=".xlsx, .xls" style="flex: 1;">
                            <button class="btn btn-success" onclick="uploadExcelFile()">üì§ Upload Excel</button>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="downloadTemplate()" style="width: 100%;">
                                üì• Download Template
                            </button>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 12px; background: white; border-radius: 8px; border: 2px solid #10b981;">
                            <p style="color: #065f46; margin: 0; font-weight: 600;">
                                üìä Current Excel File: 
                                <span id="currentExcelFileName" style="color: #667eea;">No file uploaded</span>
                            </p>
                            <p style="color: #666; font-size: 0.9rem; margin-top: 5px;">
                                Last Updated: <span id="excelLastUpdated">Never</span>
                            </p>
                        </div>
                    </div>

                    <h3>üìÖ Attendance Controls</h3>
                    <div class="form-group">
                        <label>Select Date</label>
                        <input type="date" id="attendanceDate" value="<?php echo date('Y-m-d'); ?>">
                    </div>
                    <div class="form-group">
                        <label>Select Class</label>
                        <select id="attendanceClass">
                            <option value="all">All Classes</option>
                            <option value="Noorani Qayda">Noorani Qayda</option>
                            <option value="Separa">Separa</option>
                        </select>
                    </div>
                    
                    <button class="btn load-students-btn" onclick="loadAttendanceStudents()" style="width: 100%; margin-bottom: 15px;">
                        üì• Load Students
                    </button>
                    
                    <button class="btn btn-success" onclick="markAllPresent()" style="width: 100%; margin-bottom: 10px;">
                        ‚úì Mark All Present
                    </button>
                    <button class="btn btn-warning" onclick="markAllAbsent()" style="width: 100%; margin-bottom: 10px;">
                        ‚úó Mark All Absent
                    </button>
                    <button class="btn" onclick="saveAttendanceToExcel()" style="width: 100%;">
                        üíæ Save to Excel File
                    </button>
                    
                    <!-- Fine Summary -->
                    <div class="fine-summary" id="fineSummary" style="display: none;">
                        <h4>üí∞ Fine Summary (This Month)</h4>
                        <p>Total Absent Days: <span id="totalAbsentDays" style="color: #ef4444; font-weight: bold;">0</span></p>
                        <p>Total Fine Amount: ‚Çπ<span id="totalFineAmount" style="color: #92400e; font-weight: bold;">0</span></p>
                        <div id="monthlyFineDetails" class="monthly-fine-grid"></div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 18px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 10px; border: 2px solid #e2e8f0;">
                        <p style="color: #4b0082; font-weight: 600; margin-bottom: 10px;">üìä Today's Summary:</p>
                        <p>‚úÖ Present: <span id="presentCount" style="color: #10b981; font-weight: bold;">0</span></p>
                        <p>‚ùå Absent: <span id="absentCount" style="color: #ef4444; font-weight: bold;">0</span></p>
                        <p>üìù Total: <span id="totalCount" style="color: #667eea; font-weight: bold;">0</span></p>
                    </div>
                </div>

                <div class="attendance-list">
                    <h3>üë• Student Attendance List</h3>
                    <div id="attendanceList" class="attendance-grid"></div>
                </div>
            </div>
        </div>

        <!-- Admin Management Tab -->
        <div id="adminManagement" class="content admin-management">
            <!-- Class-wise Position Selection Section -->
            <div class="position-section">
                <h3>üèÜ Select Top 3 Positions for Each Class</h3>
                <p style="color: #92400e; margin-bottom: 15px;">Select the top 3 students for each class. Positions will be displayed on their result cards.</p>
                
                <div class="form-group">
                    <label>Select Exam Month for Positions:</label>
                    <select id="positionMonth" onchange="loadClassPositionCandidates()">
                        <option value="January">January</option>
                        <option value="February">February</option>
                        <option value="March">March</option>
                        <option value="April">April</option>
                        <option value="May">May</option>
                        <option value="June">June</option>
                        <option value="July">July</option>
                        <option value="August">August</option>
                        <option value="September">September</option>
                        <option value="October">October</option>
                        <option value="November">November</option>
                        <option value="December">December</option>
                    </select>
                </div>
                
                <div class="class-position-grid" id="classPositionSelection">
                    <!-- Class-wise position cards will be loaded here -->
                </div>
                
                <button class="btn btn-warning" onclick="saveClassPositions()" style="width: 100%; margin-top: 20px;">
                    üíæ Save Positions for All Classes
                </button>
            </div>

            <!-- Export Data Section with Separate Buttons -->
            <div class="export-section">
                <h3>üìä Export Data</h3>
                <p style="color: #666; margin-bottom: 15px;">Export data to Excel for backup and analysis.</p>
                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="exportStudentsToExcel()">
                        üë®‚Äçüéì Export Students
                    </button>
                    <button class="btn btn-info" onclick="exportResultsToExcel()">
                        üìù Export Results
                    </button>
                    <button class="btn btn-success" onclick="exportAttendanceToExcel()">
                        üìã Export Attendance
                    </button>
                    <button class="btn btn-purple" onclick="exportPositionsToExcel()">
                        üèÜ Export Positions
                    </button>
                    <button class="btn btn-excel" onclick="exportAllToExcel()">
                        üì• Export All Data
                    </button>
                </div>
                <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                    <strong>Note:</strong> You can export specific data or all data in separate sheets
                </p>
            </div>

            <div class="export-section">
                <h3>üîß Admin Settings</h3>
                <div class="form-group">
                    <label>Change Admin Code</label>
                    <div class="form-row">
                        <div class="form-group">
                            <input type="password" id="newAdminCode" placeholder="New Admin Code (min 4 characters)">
                        </div>
                        <div class="form-group">
                            <input type="password" id="confirmAdminCode" placeholder="Confirm New Code">
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="changeAdminCode()">Change Admin Code</button>
                    <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
                        Current Admin Code: <strong id="currentAdminCodeDisplay">FRM123</strong>
                    </p>
                </div>
            </div>

            <div class="export-section" style="border-color: #ef4444; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);">
                <h3 style="color: #ef4444; display: flex; align-items: center; gap: 10px;">‚ö†Ô∏è Danger Zone</h3>
                <p style="color: #666; margin-bottom: 15px;">These actions cannot be undone. Please be careful.</p>
                <div class="export-buttons">
                    <button class="btn btn-danger" onclick="deleteAllResults()">
                        üóëÔ∏è Delete All Results
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllStudents()">
                        üóëÔ∏è Delete All Students
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllAttendance()">
                        üóëÔ∏è Delete All Attendance
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllPositions()">
                        üóëÔ∏è Delete All Positions
                    </button>
                    <button class="btn btn-danger" onclick="deleteAllData()">
                        üóëÔ∏è Delete All Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; padding: 35px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 3px solid #667eea; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);">
            <h3 style="color: #4b0082; margin-bottom: 25px; display: flex; align-items: center; justify-content: center; gap: 10px;">üîê Admin Login</h3>
            <div class="form-group">
                <input type="password" id="adminCode" placeholder="Enter Admin Code" 
                       style="text-align: center; font-size: 18px; letter-spacing: 2px; padding: 15px; border-radius: 10px; border: 2px solid #c4b5fd;">
            </div>
            <button class="btn" onclick="adminLogin()" style="width: 100%; margin-bottom: 15px; padding: 15px;">
                Login
            </button>
            <button onclick="hideAdminLogin()" style="background: none; border: none; color: #666; cursor: pointer; padding: 10px;">
                Cancel
            </button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDp8fdbDJRs17iFgcj1lN1YAmhiWccEkuc",
            authDomain: "result-app-8cdd1.firebaseapp.com",
            databaseURL: "https://result-app-8cdd1-default-rtdb.firebaseio.com",
            projectId: "result-app-8cdd1",
            storageBucket: "result-app-8cdd1.firebasestorage.app",
            messagingSenderId: "1000820695282",
            appId: "1:1000820695282:web:82a4f0ee1e51de2305f06b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Admin code (can be changed by admin)
        let ADMIN_CODE = "FRM123";

        // Global variables
        let selectedStudentId = null;
        let allStudents = [];
        let attendanceStatus = {};
        let lastAttendanceDate = null;
        let currentExcelFile = null;
        let currentExcelData = null;
        
        // Store positions for each class separately
        let classPositions = {
            "Separa": {1: null, 2: null, 3: null},
            "Noorani Qayda": {1: null, 2: null, 3: null}
        };

        // Initialize on page load
        window.onload = function() {
            checkAdminStatus();
            loadAllStudents();
            updateSubjectTotal('nazra');
            updateSubjectTotal('kalma');
            updateSubjectTotal('namaz');
            setupEventListeners();
            loadClassPositions(); // Load saved positions for classes
            loadExcelFileFromStorage(); // Load saved Excel file info
        };

        // Setup event listeners
        function setupEventListeners() {
            // Auto-calculate totals when marks change
            document.getElementById('nazraMarks').addEventListener('input', calculateTotal);
            document.getElementById('kalmaMarks').addEventListener('input', calculateTotal);
            document.getElementById('namazMarks').addEventListener('input', calculateTotal);
            document.getElementById('nazraTotal').addEventListener('input', calculateTotal);
            document.getElementById('kalmaTotal').addEventListener('input', calculateTotal);
            document.getElementById('namazTotal').addEventListener('input', calculateTotal);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        // Handle keyboard shortcuts
        function handleKeyboardShortcuts(event) {
            // Ctrl + S to save
            if (event.ctrlKey && event.key === 's') {
                event.preventDefault();
                const activeTab = document.querySelector('.content.active').id;
                if (activeTab === 'addResult') {
                    addResult();
                } else if (activeTab === 'addStudent') {
                    addStudent();
                } else if (activeTab === 'attendance') {
                    saveAttendanceToExcel();
                } else if (activeTab === 'adminManagement') {
                    saveClassPositions();
                }
            }
            
            // Escape to close modal
            if (event.key === 'Escape') {
                hideAdminLogin();
            }
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const tabs = document.getElementById('mobileTabs');
            tabs.classList.toggle('mobile-open');
        }

        // Check if admin is logged in
        function checkAdminStatus() {
            const savedCode = localStorage.getItem('mudrasaAdminCode');
            const isLoggedIn = localStorage.getItem('mudrasaAdminLoggedIn');
            
            // Load saved admin code if exists
            if (savedCode) {
                ADMIN_CODE = savedCode;
            }
            
            document.getElementById('currentAdminCodeDisplay').textContent = ADMIN_CODE;
            
            if (isLoggedIn === 'true') {
                showAdminTabs();
            }
        }

        // Show admin login modal
        function showAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'flex';
            document.getElementById('adminCode').focus();
        }

        // Hide admin login modal
        function hideAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'none';
            document.getElementById('adminCode').value = '';
        }

        // Admin login
        function adminLogin() {
            const enteredCode = document.getElementById('adminCode').value;
            
            if (!enteredCode) {
                showToast('Please enter admin code!', 'error');
                return;
            }
            
            if (enteredCode === ADMIN_CODE) {
                localStorage.setItem('mudrasaAdminLoggedIn', 'true');
                showAdminTabs();
                hideAdminLogin();
                showToast('Admin login successful!', 'success');
            } else {
                showToast('Invalid admin code!', 'error');
            }
        }

        // Show admin tabs
        function showAdminTabs() {
            document.getElementById('adminTab1').style.display = 'flex';
            document.getElementById('adminTab2').style.display = 'flex';
            document.getElementById('adminTab3').style.display = 'flex';
            document.getElementById('adminTab4').style.display = 'flex';
            document.getElementById('logoutBtn').style.display = 'inline-flex';
            document.querySelector('.admin-panel .admin-btn').style.display = 'none';
        }

        // Logout
        function logout() {
            localStorage.removeItem('mudrasaAdminLoggedIn');
            document.getElementById('adminTab1').style.display = 'none';
            document.getElementById('adminTab2').style.display = 'none';
            document.getElementById('adminTab3').style.display = 'none';
            document.getElementById('adminTab4').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'none';
            document.querySelector('.admin-panel .admin-btn').style.display = 'inline-flex';
            showTab('publicResults');
            showToast('Logged out successfully!', 'success');
        }

        // Change admin code
        function changeAdminCode() {
            const newCode = document.getElementById('newAdminCode').value;
            const confirmCode = document.getElementById('confirmAdminCode').value;
            
            if (!newCode || !confirmCode) {
                showToast('Please enter both fields!', 'error');
                return;
            }
            
            if (newCode !== confirmCode) {
                showToast('Codes do not match!', 'error');
                return;
            }
            
            if (newCode.length < 4) {
                showToast('Code must be at least 4 characters!', 'error');
                return;
            }
            
            // Ask for current admin code for security
            const currentCode = prompt('Please enter current admin code to confirm change:');
            if (currentCode !== ADMIN_CODE) {
                showToast('Current admin code is incorrect!', 'error');
                return;
            }
            
            // Update admin code
            ADMIN_CODE = newCode;
            localStorage.setItem('mudrasaAdminCode', newCode);
            document.getElementById('currentAdminCodeDisplay').textContent = newCode;
            
            // Clear fields
            document.getElementById('newAdminCode').value = '';
            document.getElementById('confirmAdminCode').value = '';
            
            showToast('Admin code changed successfully!', 'success');
        }

        // Show tab content
        function showTab(tabName) {
            // Close mobile menu if open
            const tabs = document.getElementById('mobileTabs');
            tabs.classList.remove('mobile-open');
            
            // Hide all tabs
            const contentTabs = document.querySelectorAll('.content');
            contentTabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Update tab headers
            const tabHeaders = document.querySelectorAll('.tab');
            tabHeaders.forEach(header => header.classList.remove('active'));
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'addResult') {
                loadStudentList();
            } else if (tabName === 'addStudent') {
                loadAllStudentsTable();
            } else if (tabName === 'attendance') {
                // Clear attendance list when tab is opened
                document.getElementById('attendanceList').innerHTML = '<div class="message info">Click "Load Students" button to load students for attendance.</div>';
                updateFineSummary();
            } else if (tabName === 'adminManagement') {
                loadClassPositionCandidates();
            }
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            // Remove existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                toast.style.animation = 'slideUp 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Show message
        function showMessage(text, type) {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML = `
                <div class="message ${type}">
                    <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</span>
                    <span>${text}</span>
                </div>
            `;
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 4000);
        }

        // Update subject total display
        function updateSubjectTotal(subject) {
            const totalInput = document.getElementById(subject + 'Total');
            const totalDisplay = document.getElementById(subject + 'TotalDisplay');
            const marksInput = document.getElementById(subject + 'Marks');
            
            const total = parseInt(totalInput.value) || 100;
            totalDisplay.textContent = total;
            
            // Update marks input max value
            marksInput.max = total;
            
            // Calculate total
            calculateTotal();
        }

        // Calculate total marks and percentage
        function calculateTotal() {
            const nazraMarks = parseFloat(document.getElementById('nazraMarks').value) || 0;
            const nazraTotal = parseFloat(document.getElementById('nazraTotal').value) || 100;
            const kalmaMarks = parseFloat(document.getElementById('kalmaMarks').value) || 0;
            const kalmaTotal = parseFloat(document.getElementById('kalmaTotal').value) || 100;
            const namazMarks = parseFloat(document.getElementById('namazMarks').value) || 0;
            const namazTotal = parseFloat(document.getElementById('namazTotal').value) || 100;
            
            const totalObtained = nazraMarks + kalmaMarks + namazMarks;
            const overallTotal = nazraTotal + kalmaTotal + namazTotal;
            
            document.getElementById('totalObtained').value = totalObtained;
            document.getElementById('overallTotal').value = overallTotal;
            
            if (overallTotal > 0) {
                const percentage = ((totalObtained / overallTotal) * 100).toFixed(2);
                document.getElementById('percentage').value = percentage + '%';
                
                // Auto assign grade based on percentage
                if (percentage >= 90) document.getElementById('grade').value = 'A+';
                else if (percentage >= 80) document.getElementById('grade').value = 'A';
                else if (percentage >= 70) document.getElementById('grade').value = 'B';
                else if (percentage >= 60) document.getElementById('grade').value = 'C';
                else if (percentage >= 50) document.getElementById('grade').value = 'D';
                else document.getElementById('grade').value = 'F';
            }
        }

        // Load all students for result adding
        function loadStudentList() {
            showMessage('Loading students...', 'info');
            
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                const studentList = document.getElementById('studentList');
                studentList.innerHTML = '';
                
                if (!students) {
                    studentList.innerHTML = '<div class="message info">No students found. Please add students first.</div>';
                    showMessage('', '');
                    return;
                }
                
                allStudents = [];
                
                Object.keys(students).forEach(rollNumber => {
                    const student = students[rollNumber];
                    allStudents.push(student);
                    
                    const studentItem = document.createElement('div');
                    studentItem.className = 'student-item';
                    studentItem.innerHTML = `
                        <button class="delete-btn" onclick="deleteStudent('${rollNumber}', event)">√ó</button>
                        <h4>${student.name}</h4>
                        <p><strong>Roll No:</strong> ${student.rollNumber}</p>
                        <p><strong>Class:</strong> ${student.class}</p>
                    `;
                    studentItem.onclick = () => selectStudent(student);
                    studentList.appendChild(studentItem);
                });
                
                showMessage('', '');
            });
        }

        // Delete individual student
        function deleteStudent(rollNumber, event) {
            event.stopPropagation(); // Prevent selecting the student
            
            if (!confirm(`Are you sure you want to delete student with Roll Number: ${rollNumber}? This will also delete all their results!`)) {
                return;
            }
            
            const adminCode = prompt('Enter admin code to confirm deletion:');
            if (adminCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            // Delete student
            database.ref('students/' + rollNumber).remove()
                .then(() => {
                    // Delete all results for this student
                    return database.ref('results').once('value')
                        .then(snapshot => {
                            const updates = {};
                            snapshot.forEach(child => {
                                if (child.val().studentRoll === rollNumber) {
                                    updates[child.key] = null;
                                }
                            });
                            return database.ref('results').update(updates);
                        });
                })
                .then(() => {
                    showToast(`Student ${rollNumber} deleted successfully!`, 'success');
                    loadStudentList();
                    loadAllStudentsTable();
                    loadAllStudents();
                })
                .catch(error => {
                    showToast('Error deleting student: ' + error.message, 'error');
                });
        }

        // Filter students
        function filterStudents() {
            const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
            const studentItems = document.querySelectorAll('.student-item');
            
            studentItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Select student for result adding
        async function selectStudent(student) {
            selectedStudentId = student.rollNumber;
            
            // Update selected student UI
            document.querySelectorAll('.student-item').forEach(item => {
                item.classList.remove('selected');
            });
            event.target.closest('.student-item').classList.add('selected');
            
            // Fill form fields
            document.getElementById('resultStudentRoll').value = student.rollNumber;
            document.getElementById('resultStudentName').value = student.name;
            document.getElementById('selectedStudentName').textContent = student.name;
            
            // Reset marks
            document.getElementById('nazraMarks').value = '';
            document.getElementById('kalmaMarks').value = '';
            document.getElementById('namazMarks').value = '';
            
            calculateTotal();
            
            // Calculate and show fine information
            await calculateAndShowFine(student.rollNumber);
            
            showToast(`Selected student: ${student.name}`, 'success');
        }

        // Calculate and show fine information
        async function calculateAndShowFine(studentRoll) {
            const examMonth = document.getElementById('examMonth').value;
            const currentYear = new Date().getFullYear();
            const examDate = new Date(`${examMonth} 1, ${currentYear}`);
            const examMonthNum = examDate.getMonth() + 1;
            
            // Get attendance for this month from Excel file
            let absentDays = 0;
            
            if (currentExcelData) {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                const currentMonth = examMonthNum.toString().padStart(2, '0');
                
                jsonData.forEach(row => {
                    if (row['Roll No'] && row['Roll No'].toString() === studentRoll.toString()) {
                        // Check each day of the month
                        for (let day = 1; day <= 31; day++) {
                            const dateStr = `${currentYear}-${currentMonth}-${day.toString().padStart(2, '0')}`;
                            if (row[dateStr] && (row[dateStr] === 'A' || row[dateStr] === 'Absent' || row[dateStr] === 'absent')) {
                                absentDays++;
                            }
                        }
                    }
                });
            }
            
            // Calculate fine: ‚Çπ10 per absent day
            const totalFine = absentDays * 10;
            
            // Show fine information
            const fineInfoDiv = document.getElementById('fineInfoInAdd');
            if (absentDays > 0) {
                document.getElementById('absentDaysCount').textContent = absentDays;
                document.getElementById('fineAmount').textContent = totalFine;
                fineInfoDiv.style.display = 'block';
            } else {
                fineInfoDiv.style.display = 'none';
            }
        }

        // Add result with fine calculation for absent students
        async function addResult() {
            if (!selectedStudentId) {
                showToast('Please select a student first!', 'error');
                return;
            }
            
            const studentRoll = document.getElementById('resultStudentRoll').value;
            const studentName = document.getElementById('resultStudentName').value;
            const examMonth = document.getElementById('examMonth').value;
            
            const nazraMarks = parseFloat(document.getElementById('nazraMarks').value) || 0;
            const nazraTotal = parseFloat(document.getElementById('nazraTotal').value) || 100;
            const kalmaMarks = parseFloat(document.getElementById('kalmaMarks').value) || 0;
            const kalmaTotal = parseFloat(document.getElementById('kalmaTotal').value) || 100;
            const namazMarks = parseFloat(document.getElementById('namazMarks').value) || 0;
            const namazTotal = parseFloat(document.getElementById('namazTotal').value) || 100;
            
            const grade = document.getElementById('grade').value;
            const percentage = document.getElementById('percentage').value.replace('%', '');
            
            // Validate marks
            if (nazraMarks > nazraTotal || kalmaMarks > kalmaTotal || namazMarks > namazTotal) {
                showToast('Obtained marks cannot exceed total marks!', 'error');
                return;
            }
            
            // Check if marks are entered
            if (!nazraMarks && !kalmaMarks && !namazMarks) {
                showToast('Please enter marks for at least one subject!', 'error');
                return;
            }
            
            // Calculate fine based on attendance from Excel file
            let totalFine = 0;
            let absentDays = 0;
            const currentYear = new Date().getFullYear();
            const examDate = new Date(`${examMonth} 1, ${currentYear}`);
            const examMonthNum = examDate.getMonth() + 1;
            
            if (currentExcelData) {
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                const currentMonth = examMonthNum.toString().padStart(2, '0');
                
                jsonData.forEach(row => {
                    if (row['Roll No'] && row['Roll No'].toString() === studentRoll.toString()) {
                        // Check each day of the month
                        for (let day = 1; day <= 31; day++) {
                            const dateStr = `${currentYear}-${currentMonth}-${day.toString().padStart(2, '0')}`;
                            if (row[dateStr] && (row[dateStr] === 'A' || row[dateStr] === 'Absent' || row[dateStr] === 'absent')) {
                                absentDays++;
                            }
                        }
                    }
                });
                
                // Calculate fine: ‚Çπ10 per absent day
                totalFine = absentDays * 10;
            }
            
            const resultData = {
                studentRoll: studentRoll,
                studentName: studentName,
                examMonth: examMonth,
                subjects: {
                    nazra: { obtained: nazraMarks, total: nazraTotal },
                    kalma: { obtained: kalmaMarks, total: kalmaTotal },
                    namaz: { obtained: namazMarks, total: namazTotal }
                },
                totalObtained: parseFloat(document.getElementById('totalObtained').value),
                overallTotal: parseFloat(document.getElementById('overallTotal').value),
                percentage: parseFloat(percentage),
                grade: grade,
                fine: totalFine,
                absentDays: absentDays,
                date: new Date().toISOString(),
                timestamp: Date.now()
            };
            
            const resultId = `RES-${Date.now()}`;
            
            database.ref('results/' + resultId).set(resultData)
                .then(() => {
                    showToast('Result saved successfully!', 'success');
                    
                    // Reset form
                    document.getElementById('nazraMarks').value = '';
                    document.getElementById('kalmaMarks').value = '';
                    document.getElementById('namazMarks').value = '';
                    document.getElementById('fineInfoInAdd').style.display = 'none';
                    
                    // Clear selected student
                    selectedStudentId = null;
                    document.querySelectorAll('.student-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    document.getElementById('resultStudentRoll').value = '';
                    document.getElementById('resultStudentName').value = '';
                    document.getElementById('selectedStudentName').textContent = '[Select Student]';
                    
                    // Do NOT move to check results page - stay on same page
                    // Just reload the student list
                    loadStudentList();
                    
                })
                .catch(error => {
                    showToast('Error saving result: ' + error.message, 'error');
                });
        }

        // Add student
        function addStudent() {
            const rollNumber = document.getElementById('studentRoll').value.trim();
            const name = document.getElementById('studentName').value.trim();
            const studentClass = document.getElementById('studentClass').value;
            
            if (!rollNumber || !name || !studentClass) {
                showToast('Please fill in all required fields!', 'error');
                return;
            }
            
            // Check if roll number already exists
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                let rollExists = false;
                
                if (students) {
                    Object.keys(students).forEach(key => {
                        if (students[key].rollNumber === rollNumber) {
                            rollExists = true;
                        }
                    });
                }
                
                if (rollExists) {
                    showToast('Roll number already exists! Please use a different number.', 'error');
                    return;
                }
                
                const studentData = {
                    rollNumber: rollNumber,
                    name: name,
                    class: studentClass,
                    dateAdded: new Date().toISOString(),
                    status: 'Active'
                };
                
                database.ref('students/' + rollNumber).set(studentData)
                    .then(() => {
                        showToast(`Student ${name} registered successfully with Roll Number: ${rollNumber}`, 'success');
                        
                        // Clear form
                        document.getElementById('studentRoll').value = '';
                        document.getElementById('studentName').value = '';
                        
                        // Refresh student lists
                        loadAllStudents();
                        loadStudentList();
                        loadAllStudentsTable();
                    })
                    .catch(error => {
                        showToast('Error adding student: ' + error.message, 'error');
                    });
            });
        }

        // Load all students for table
        function loadAllStudentsTable() {
            showMessage('Loading students list...', 'info');
            
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                const container = document.getElementById('allStudentsList');
                
                if (!students) {
                    container.innerHTML = '<div class="message info">No students registered yet.</div>';
                    showMessage('', '');
                    return;
                }
                
                let html = '<div class="students-table-container" style="overflow-x: auto;">';
                html += '<table class="students-table">';
                html += '<tr><th>Roll Number</th><th>Name</th><th>Class</th><th>Status</th><th>Action</th></tr>';
                
                Object.keys(students).forEach(rollNumber => {
                    const student = students[rollNumber];
                    html += `
                        <tr>
                            <td><strong>${student.rollNumber}</strong></td>
                            <td>${student.name}</td>
                            <td>${student.class}</td>
                            <td><span style="color: #10b981; font-weight: bold;">${student.status || 'Active'}</span></td>
                            <td>
                                <button class="btn-danger" onclick="deleteStudentFromTable('${rollNumber}')" style="padding: 8px 15px; font-size: 0.9rem;">
                                    Delete
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</table></div>';
                container.innerHTML = html;
                showMessage('', '');
            });
        }

        // Delete student from table
        function deleteStudentFromTable(rollNumber) {
            if (!confirm(`Are you sure you want to delete student with Roll Number: ${rollNumber}? This will also delete all their results!`)) {
                return;
            }
            
            const adminCode = prompt('Enter admin code to confirm deletion:');
            if (adminCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            // Delete student
            database.ref('students/' + rollNumber).remove()
                .then(() => {
                    // Delete all results for this student
                    return database.ref('results').once('value')
                        .then(snapshot => {
                            const updates = {};
                            snapshot.forEach(child => {
                                if (child.val().studentRoll === rollNumber) {
                                    updates[child.key] = null;
                                }
                            });
                            return database.ref('results').update(updates);
                        });
                })
                .then(() => {
                    showToast(`Student ${rollNumber} deleted successfully!`, 'success');
                    loadAllStudentsTable();
                    loadStudentList();
                    loadAllStudents();
                })
                .catch(error => {
                    showToast('Error deleting student: ' + error.message, 'error');
                });
        }

        // Load Excel file from local storage
        function loadExcelFileFromStorage() {
            const savedFileInfo = localStorage.getItem('mudrasaExcelFileInfo');
            if (savedFileInfo) {
                try {
                    const fileInfo = JSON.parse(savedFileInfo);
                    document.getElementById('currentExcelFileName').textContent = fileInfo.name || 'daily_attendance.xlsx';
                    document.getElementById('excelLastUpdated').textContent = fileInfo.lastUpdated || 'Never';
                    
                    // Try to load the file data if available
                    const fileData = localStorage.getItem('mudrasaExcelFileData');
                    if (fileData) {
                        currentExcelData = JSON.parse(fileData);
                        showToast('Excel file loaded from storage', 'success');
                    }
                } catch (e) {
                    console.error('Error loading Excel file info:', e);
                }
            }
        }

        // Save Excel file to local storage
        function saveExcelFileToStorage(fileName, fileData) {
            const fileInfo = {
                name: fileName,
                lastUpdated: new Date().toLocaleString(),
                timestamp: Date.now()
            };
            
            localStorage.setItem('mudrasaExcelFileInfo', JSON.stringify(fileInfo));
            localStorage.setItem('mudrasaExcelFileData', JSON.stringify(fileData));
            
            document.getElementById('currentExcelFileName').textContent = fileName;
            document.getElementById('excelLastUpdated').textContent = fileInfo.lastUpdated;
        }

        // Upload Excel file
        function uploadExcelFile() {
            const fileInput = document.getElementById('excelFile');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('Please select an Excel file first!', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Store the workbook data
                    currentExcelFile = file;
                    currentExcelData = workbook;
                    
                    // Save to local storage
                    saveExcelFileToStorage(file.name, workbook);
                    
                    showToast(`Excel file "${file.name}" uploaded successfully!`, 'success');
                    
                    // Update fine summary
                    updateFineSummary();
                    
                } catch (error) {
                    showToast('Error reading Excel file: ' + error.message, 'error');
                }
            };
            
            reader.onerror = function() {
                showToast('Error reading file!', 'error');
            };
            
            reader.readAsArrayBuffer(file);
        }

        // Download Excel template
        function downloadTemplate() {
            // Create a new workbook
            const workbook = XLSX.utils.book_new();
            
            // Create header row
            const headers = ['Roll No', 'Name', 'Class'];
            
            // Add dates for current month
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            const daysInMonth = new Date(currentYear, currentMonth, 0).getDate();
            
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentYear}-${currentMonth.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                headers.push(dateStr);
            }
            
            // Add fine columns
            headers.push('Total Absent Days', 'Fine Amount (‚Çπ10 per day)', 'Total Fine');
            
            // Create sample data
            const data = [headers];
            
            // Add sample students
            const sampleStudents = [
                { rollNo: '101', name: 'Student 1', class: 'Noorani Qayda' },
                { rollNo: '102', name: 'Student 2', class: 'Separa' },
                { rollNo: '103', name: 'Student 3', class: 'Noorani Qayda' }
            ];
            
            sampleStudents.forEach(student => {
                const row = [student.rollNo, student.name, student.class];
                
                // Add empty cells for each day
                for (let day = 1; day <= daysInMonth; day++) {
                    row.push(''); // Empty for attendance
                }
                
                // Add empty cells for fine calculations
                row.push('', '', '');
                
                data.push(row);
            });
            
            // Create worksheet
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            
            // Add to workbook
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Attendance');
            
            // Generate and download file
            const fileName = `attendance_template_${currentYear}_${currentMonth.toString().padStart(2, '0')}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            showToast('Template downloaded successfully!', 'success');
        }

        // Load students for attendance
        function loadAttendanceStudents() {
            const selectedClass = document.getElementById('attendanceClass').value;
            const date = document.getElementById('attendanceDate').value;
            
            if (!date) {
                showToast('Please select a date!', 'error');
                return;
            }
            
            if (!currentExcelData) {
                showToast('Please upload an Excel file first!', 'error');
                return;
            }
            
            showMessage('Loading students for attendance...', 'info');
            
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                const attendanceList = document.getElementById('attendanceList');
                
                if (!students) {
                    attendanceList.innerHTML = '<div class="message info">No students registered yet. Please add students first.</div>';
                    showMessage('', '');
                    return;
                }
                
                // Get attendance from Excel file for this date
                const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                
                attendanceList.innerHTML = '';
                attendanceStatus = {};
                
                let presentCount = 0;
                let absentCount = 0;
                let totalCount = 0;
                
                Object.keys(students).forEach(rollNumber => {
                    const student = students[rollNumber];
                    
                    // Filter by class if not "all"
                    if (selectedClass !== 'all' && student.class !== selectedClass) {
                        return;
                    }
                    
                    totalCount++;
                    
                    // Check attendance from Excel file
                    let isPresent = true; // Default to present
                    
                    // Find student in Excel data
                    const excelRecord = jsonData.find(row => row['Roll No'] && row['Roll No'].toString() === rollNumber.toString());
                    if (excelRecord && excelRecord[date]) {
                        const status = excelRecord[date];
                        isPresent = !(status === 'A' || status === 'Absent' || status === 'absent');
                    }
                    
                    if (isPresent) presentCount++;
                    else absentCount++;
                    
                    attendanceStatus[rollNumber] = isPresent ? 'present' : 'absent';
                    
                    const attendanceCard = document.createElement('div');
                    attendanceCard.className = `attendance-card ${attendanceStatus[rollNumber]}`;
                    attendanceCard.id = `attendance-${rollNumber}`;
                    attendanceCard.innerHTML = `
                        <h4>${student.name}</h4>
                        <p><strong>Roll No:</strong> ${student.rollNumber}</p>
                        <p><strong>Class:</strong> ${student.class}</p>
                        <div class="status-toggle">
                            <button class="status-btn present-btn ${attendanceStatus[rollNumber] === 'present' ? 'active' : ''}" 
                                    onclick="markAttendance('${rollNumber}', 'present')">
                                ‚úì Present
                            </button>
                            <button class="status-btn absent-btn ${attendanceStatus[rollNumber] === 'absent' ? 'active' : ''}" 
                                    onclick="markAttendance('${rollNumber}', 'absent')">
                                ‚úó Absent
                            </button>
                        </div>
                    `;
                    attendanceList.appendChild(attendanceCard);
                });
                
                // Update counters
                document.getElementById('presentCount').textContent = presentCount;
                document.getElementById('absentCount').textContent = absentCount;
                document.getElementById('totalCount').textContent = totalCount;
                
                showMessage('', '');
                showToast(`Loaded ${totalCount} students for attendance`, 'success');
                
                // Update fine summary
                updateFineSummary();
            });
        }

        // Mark attendance
        function markAttendance(rollNumber, status) {
            attendanceStatus[rollNumber] = status;
            
            const card = document.getElementById(`attendance-${rollNumber}`);
            if (card) {
                card.className = `attendance-card ${status}`;
                
                // Update button states
                const presentBtn = card.querySelector('.present-btn');
                const absentBtn = card.querySelector('.absent-btn');
                
                if (presentBtn) presentBtn.className = `status-btn present-btn ${status === 'present' ? 'active' : ''}`;
                if (absentBtn) absentBtn.className = `status-btn absent-btn ${status === 'absent' ? 'active' : ''}`;
            }
            
            updateAttendanceCounters();
        }

        // Mark all present
        function markAllPresent() {
            if (Object.keys(attendanceStatus).length === 0) {
                showToast('Please load students first!', 'error');
                return;
            }
            
            Object.keys(attendanceStatus).forEach(rollNumber => {
                markAttendance(rollNumber, 'present');
            });
            showToast('All students marked as Present', 'success');
        }

        // Mark all absent
        function markAllAbsent() {
            if (Object.keys(attendanceStatus).length === 0) {
                showToast('Please load students first!', 'error');
                return;
            }
            
            Object.keys(attendanceStatus).forEach(rollNumber => {
                markAttendance(rollNumber, 'absent');
            });
            showToast('All students marked as Absent', 'warning');
        }

        // Update attendance counters
        function updateAttendanceCounters() {
            let presentCount = 0;
            let absentCount = 0;
            
            Object.values(attendanceStatus).forEach(status => {
                if (status === 'present') presentCount++;
                if (status === 'absent') absentCount++;
            });
            
            document.getElementById('presentCount').textContent = presentCount;
            document.getElementById('absentCount').textContent = absentCount;
            document.getElementById('totalCount').textContent = presentCount + absentCount;
        }

        // Update fine summary
        function updateFineSummary() {
            if (!currentExcelData) {
                document.getElementById('fineSummary').style.display = 'none';
                return;
            }
            
            const sheet = currentExcelData.Sheets[currentExcelData.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(sheet);
            
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth() + 1;
            const currentMonthStr = currentMonth.toString().padStart(2, '0');
            
            let totalAbsentDays = 0;
            let totalFineAmount = 0;
            
            const monthlyData = {};
            
            // Initialize monthly data
            for (let m = 1; m <= 12; m++) {
                monthlyData[m] = {
                    month: new Date(currentYear, m - 1, 1).toLocaleString('default', { month: 'long' }),
                    absentDays: 0,
                    fineAmount: 0
                };
            }
            
            jsonData.forEach(row => {
                if (row['Roll No']) {
                    // Check each month
                    for (let month = 1; month <= 12; month++) {
                        let monthAbsentDays = 0;
                        const monthStr = month.toString().padStart(2, '0');
                        
                        // Check each day of the month
                        for (let day = 1; day <= 31; day++) {
                            const dateStr = `${currentYear}-${monthStr}-${day.toString().padStart(2, '0')}`;
                            if (row[dateStr] && (row[dateStr] === 'A' || row[dateStr] === 'Absent' || row[dateStr] === 'absent')) {
                                monthAbsentDays++;
                                totalAbsentDays++;
                            }
                        }
                        
                        monthlyData[month].absentDays += monthAbsentDays;
                        monthlyData[month].fineAmount += monthAbsentDays * 10;
                    }
                }
            });
            
            // Calculate total fine amount
            totalFineAmount = totalAbsentDays * 10;
            
            // Update display
            document.getElementById('totalAbsentDays').textContent = totalAbsentDays;
            document.getElementById('totalFineAmount').textContent = totalFineAmount;
            
            // Update monthly details
            const monthlyContainer = document.getElementById('monthlyFineDetails');
            monthlyContainer.innerHTML = '';
            
            Object.values(monthlyData).forEach(monthData => {
                if (monthData.absentDays > 0) {
                    const card = document.createElement('div');
                    card.className = 'monthly-fine-card';
                    card.innerHTML = `
                        <h5>${monthData.month}</h5>
                        <p>Absent Days: <strong>${monthData.absentDays}</strong></p>
                        <p>Fine Amount: <strong>‚Çπ${monthData.fineAmount}</strong></p>
                    `;
                    monthlyContainer.appendChild(card);
                }
            });
            
            document.getElementById('fineSummary').style.display = 'block';
        }

        // Save attendance to Excel file
        function saveAttendanceToExcel() {
            const date = document.getElementById('attendanceDate').value;
            
            if (!date) {
                showToast('Please select a date!', 'error');
                return;
            }
            
            if (!currentExcelData) {
                showToast('Please upload an Excel file first!', 'error');
                return;
            }
            
            if (Object.keys(attendanceStatus).length === 0) {
                showToast('No attendance data to save! Please load students first.', 'error');
                return;
            }
            
            // Get the first sheet
            const sheetName = currentExcelData.SheetNames[0];
            const sheet = currentExcelData.Sheets[sheetName];
            
            // Convert to JSON
            const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            // Find header row
            const headerRow = jsonData[0];
            const dateColumnIndex = headerRow.indexOf(date);
            
            if (dateColumnIndex === -1) {
                // Date column doesn't exist, add it
                headerRow.push(date);
            }
            
            // Update attendance for each student
            for (let i = 1; i < jsonData.length; i++) {
                const row = jsonData[i];
                const rollNumber = row[0] ? row[0].toString() : '';
                
                if (rollNumber && attendanceStatus[rollNumber]) {
                    const status = attendanceStatus[rollNumber] === 'present' ? 'P' : 'A';
                    
                    if (dateColumnIndex === -1) {
                        // New date column
                        row.push(status);
                    } else {
                        // Existing date column
                        row[dateColumnIndex] = status;
                    }
                    
                    // Update absent days and fine calculations
                    updateFineCalculations(row, headerRow);
                }
            }
            
            // Convert back to worksheet
            const updatedWorksheet = XLSX.utils.aoa_to_sheet(jsonData);
            currentExcelData.Sheets[sheetName] = updatedWorksheet;
            
            // Save updated file
            saveExcelFileToStorage(document.getElementById('currentExcelFileName').textContent, currentExcelData);
            
            // Download updated file
            const fileName = document.getElementById('currentExcelFileName').textContent;
            XLSX.writeFile(currentExcelData, fileName);
            
            showToast(`Attendance saved to ${fileName}`, 'success');
            
            // Update fine summary
            updateFineSummary();
        }

        // Update fine calculations in Excel row
        function updateFineCalculations(row, headerRow) {
            const rollNoIndex = 0;
            const nameIndex = 1;
            const classIndex = 2;
            const totalAbsentIndex = headerRow.indexOf('Total Absent Days');
            const finePerDayIndex = headerRow.indexOf('Fine Amount (‚Çπ10 per day)');
            const totalFineIndex = headerRow.indexOf('Total Fine');
            
            if (totalAbsentIndex === -1 || finePerDayIndex === -1 || totalFineIndex === -1) {
                // Fine columns don't exist, add them
                if (totalAbsentIndex === -1) {
                    headerRow.push('Total Absent Days');
                    row.push(0);
                }
                if (finePerDayIndex === -1) {
                    headerRow.push('Fine Amount (‚Çπ10 per day)');
                    row.push(10);
                }
                if (totalFineIndex === -1) {
                    headerRow.push('Total Fine');
                    row.push(0);
                }
                
                // Re-find indices
                const newTotalAbsentIndex = headerRow.indexOf('Total Absent Days');
                const newFinePerDayIndex = headerRow.indexOf('Fine Amount (‚Çπ10 per day)');
                const newTotalFineIndex = headerRow.indexOf('Total Fine');
                
                // Calculate absent days
                let absentDays = 0;
                for (let i = 3; i < newTotalAbsentIndex; i++) {
                    if (headerRow[i] && row[i] && (row[i] === 'A' || row[i] === 'Absent' || row[i] === 'absent')) {
                        absentDays++;
                    }
                }
                
                row[newTotalAbsentIndex] = absentDays;
                row[newTotalFineIndex] = absentDays * 10;
            } else {
                // Calculate absent days
                let absentDays = 0;
                for (let i = 3; i < totalAbsentIndex; i++) {
                    if (headerRow[i] && row[i] && (row[i] === 'A' || row[i] === 'Absent' || row[i] === 'absent')) {
                        absentDays++;
                    }
                }
                
                row[totalAbsentIndex] = absentDays;
                row[totalFineIndex] = absentDays * 10;
            }
        }

        // Load class positions from database
        function loadClassPositions() {
            database.ref('classPositions').once('value', snapshot => {
                const positions = snapshot.val();
                if (positions) {
                    classPositions = positions;
                }
            });
        }

        // Save class positions to database
        function saveClassPositions() {
            const examMonth = document.getElementById('positionMonth').value;
            const positionData = {
                month: examMonth,
                positions: classPositions,
                timestamp: Date.now()
            };
            
            database.ref('classPositions/' + examMonth).set(positionData)
                .then(() => {
                    showToast(`Class positions saved for ${examMonth}!`, 'success');
                })
                .catch(error => {
                    showToast('Error saving positions: ' + error.message, 'error');
                });
        }

        // Load position candidates for each class
        function loadClassPositionCandidates() {
            const examMonth = document.getElementById('positionMonth').value;
            
            database.ref('results').once('value', snapshot => {
                const results = snapshot.val();
                const positionDiv = document.getElementById('classPositionSelection');
                
                if (!results) {
                    positionDiv.innerHTML = '<div class="message info">No results found for position selection.</div>';
                    return;
                }
                
                // Filter results by month
                const monthlyResults = [];
                Object.values(results).forEach(result => {
                    if (result.examMonth === examMonth) {
                        monthlyResults.push(result);
                    }
                });
                
                if (monthlyResults.length === 0) {
                    positionDiv.innerHTML = '<div class="message info">No results found for selected month.</div>';
                    return;
                }
                
                // Load saved positions for this month
                database.ref('classPositions/' + examMonth).once('value', posSnapshot => {
                    const savedPositions = posSnapshot.val();
                    let savedClassPositions = {
                        "Separa": {1: null, 2: null, 3: null},
                        "Noorani Qayda": {1: null, 2: null, 3: null}
                    };
                    
                    if (savedPositions && savedPositions.positions) {
                        savedClassPositions = savedPositions.positions;
                        classPositions = savedClassPositions;
                    }
                    
                    positionDiv.innerHTML = '';
                    
                    // Create position selection for Separa class
                    const separaResults = monthlyResults.filter(result => {
                        const studentClass = getStudentClass(result.studentRoll);
                        return studentClass === 'Separa';
                    }).sort((a, b) => b.percentage - a.percentage);
                    
                    const separaCard = document.createElement('div');
                    separaCard.className = 'class-position-card separa';
                    separaCard.innerHTML = `
                        <div class="class-header">Separa Class - Top 3 Positions</div>
                        ${[1, 2, 3].map(i => `
                            <div class="position-card">
                                <h4>
                                    <span class="position-badge position-${i}" style="position: static; width: 30px; height: 30px; display: inline-flex; margin-right: 10px;">
                                        ${i}
                                    </span>
                                    ${i === 1 ? 'ü•á First Position' : i === 2 ? 'ü•à Second Position' : 'ü•â Third Position'}
                                </h4>
                                <div class="position-selector">
                                    <select id="separaPosition${i}" onchange="updateClassPosition('Separa', ${i}, this.value)">
                                        <option value="">-- Select Student --</option>
                                        ${separaResults.map(result => `
                                            <option value="${result.studentRoll}" ${savedClassPositions['Separa'][i] === result.studentRoll ? 'selected' : ''}>
                                                ${result.studentName} (${result.percentage}%) - Roll: ${result.studentRoll}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        `).join('')}
                    `;
                    positionDiv.appendChild(separaCard);
                    
                    // Create position selection for Noorani Qayda class
                    const nooraniResults = monthlyResults.filter(result => {
                        const studentClass = getStudentClass(result.studentRoll);
                        return studentClass === 'Noorani Qayda';
                    }).sort((a, b) => b.percentage - a.percentage);
                    
                    const nooraniCard = document.createElement('div');
                    nooraniCard.className = 'class-position-card noorani';
                    nooraniCard.innerHTML = `
                        <div class="class-header">Noorani Qayda Class - Top 3 Positions</div>
                        ${[1, 2, 3].map(i => `
                            <div class="position-card">
                                <h4>
                                    <span class="position-badge position-${i}" style="position: static; width: 30px; height: 30px; display: inline-flex; margin-right: 10px;">
                                        ${i}
                                    </span>
                                    ${i === 1 ? 'ü•á First Position' : i === 2 ? 'ü•à Second Position' : 'ü•â Third Position'}
                                </h4>
                                <div class="position-selector">
                                    <select id="nooraniPosition${i}" onchange="updateClassPosition('Noorani Qayda', ${i}, this.value)">
                                        <option value="">-- Select Student --</option>
                                        ${nooraniResults.map(result => `
                                            <option value="${result.studentRoll}" ${savedClassPositions['Noorani Qayda'][i] === result.studentRoll ? 'selected' : ''}>
                                                ${result.studentName} (${result.percentage}%) - Roll: ${result.studentRoll}
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        `).join('')}
                    `;
                    positionDiv.appendChild(nooraniCard);
                });
            });
        }

        // Update class position in memory
        function updateClassPosition(className, positionNumber, studentRoll) {
            classPositions[className][positionNumber] = studentRoll || null;
        }

        // Search results (public access - individual only)
        function searchResults() {
            const query = document.getElementById('searchQuery').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            
            if (!query) {
                showToast('Please enter roll number!', 'error');
                return;
            }
            
            showMessage('Searching results...', 'info');
            resultsDiv.innerHTML = '<div class="spinner"></div>';
            
            database.ref('results').once('value', snapshot => {
                const results = snapshot.val();
                resultsDiv.innerHTML = '';
                
                if (!results) {
                    resultsDiv.innerHTML = '<div class="result-card"><p>No results found for this roll number.</p></div>';
                    showMessage('', '');
                    return;
                }
                
                let foundResults = [];
                
                Object.keys(results).forEach(resultId => {
                    const result = results[resultId];
                    if (result.studentRoll === query) {
                        foundResults.push(result);
                    }
                });
                
                if (foundResults.length === 0) {
                    resultsDiv.innerHTML = '<div class="result-card"><p>No results found for Roll Number: ' + query + '</p></div>';
                    showMessage('', '');
                    return;
                }
                
                // Sort by date (newest first)
                foundResults.sort((a, b) => b.timestamp - a.timestamp);
                
                // Show only latest result to public
                const latestResult = foundResults[0];
                
                // Get student class
                const studentClass = getStudentClass(latestResult.studentRoll);
                
                // Load positions for display
                database.ref('classPositions').once('value', posSnapshot => {
                    const positions = posSnapshot.val();
                    let position = null;
                    
                    // Check if student has position in their class
                    if (positions && positions[latestResult.examMonth] && positions[latestResult.examMonth].positions) {
                        const classPos = positions[latestResult.examMonth].positions[studentClass];
                        if (classPos) {
                            if (classPos[1] === latestResult.studentRoll) position = 1;
                            else if (classPos[2] === latestResult.studentRoll) position = 2;
                            else if (classPos[3] === latestResult.studentRoll) position = 3;
                        }
                    }
                    
                    displayResultCard(latestResult, position, studentClass);
                    
                    // Show message that only latest result is shown
                    if (foundResults.length > 1) {
                        const infoCard = document.createElement('div');
                        infoCard.className = 'result-card';
                        infoCard.style.borderLeftColor = '#3b82f6';
                        infoCard.innerHTML = `
                            <p><strong>‚ÑπÔ∏è Note:</strong> Only the latest result is shown. 
                            Total ${foundResults.length} results found for this student.</p>
                        `;
                        resultsDiv.appendChild(infoCard);
                    }
                    
                    showMessage('', '');
                });
            });
        }

        // Display result card with position on right side and fine information
        function displayResultCard(result, position = null, studentClass = null) {
            const resultsDiv = document.getElementById('searchResults');
            const gradeClass = `grade-${result.grade.charAt(0).toLowerCase()}`;
            
            // Create position badge if student has position (on RIGHT side)
            let positionBadge = '';
            if (position) {
                let positionText = '';
                if (position === 1) {
                    positionText = '1st Position';
                } else if (position === 2) {
                    positionText = '2nd Position';
                } else if (position === 3) {
                    positionText = '3rd Position';
                }
                
                positionBadge = `
                    <div class="position-badge position-${position}">
                        <div>${position}</div>
                        <div class="position-text">${positionText}</div>
                    </div>
                `;
            }
            
            // Create fine information if any
            let fineInfo = '';
            if (result.fine && result.fine > 0) {
                fineInfo = `
                    <div style="margin: 10px 0; padding: 12px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border: 1px solid #f59e0b;">
                        <p style="color: #92400e; font-weight: bold; margin: 0;">
                            Fine: ‚Çπ${result.fine} (${result.absentDays} absent days)
                        </p>
                    </div>
                `;
            }
            
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card';
            resultCard.innerHTML = `
                ${positionBadge}
                <h3>${result.studentName}</h3>
                <p><strong>Roll Number:</strong> ${result.studentRoll}</p>
                <p><strong>Class:</strong> ${studentClass || getStudentClass(result.studentRoll)}</p>
                <p><strong>Exam Month:</strong> ${result.examMonth}</p>
                
                <div style="margin: 15px 0; padding: 18px; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border-radius: 10px; border: 2px solid #e2e8f0;">
                    <h4 style="color: #4b0082; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">üìö Subject-wise Marks:</h4>
                    <p><strong>Nazra:</strong> ${result.subjects.nazra.obtained}/${result.subjects.nazra.total}</p>
                    <p><strong>Kalma:</strong> ${result.subjects.kalma.obtained}/${result.subjects.kalma.total}</p>
                    <p><strong>Namaz:</strong> ${result.subjects.namaz.obtained}/${result.subjects.namaz.total}</p>
                </div>
                
                <div style="text-align: center; margin: 20px 0; padding: 15px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 10px; border: 2px solid #3b82f6;">
                    <div style="font-size: 1.5rem; color: #1e40af; font-weight: bold; margin: 5px 0;">
                        Total: ${result.totalObtained}/${result.overallTotal}
                    </div>
                    ${fineInfo}
                    <div style="font-size: 2rem; color: #3b82f6; font-weight: bold; margin: 10px 0;">
                        ${result.percentage}%
                    </div>
                    <div style="font-size: 1.8rem; color: #667eea; font-weight: bold;">
                        Grade: <span class="grade-badge ${gradeClass}">${result.grade}</span>
                    </div>
                </div>
                
                <p style="margin-top: 15px; color: #666; font-size: 0.9rem; text-align: center;">
                    üìÖ Date: ${new Date(result.date).toLocaleDateString('en-US', {
                        year: 'numeric', month: 'long', day: 'numeric'
                    })}
                </p>
            `;
            resultsDiv.appendChild(resultCard);
        }

        // Get student class by roll number
        function getStudentClass(rollNumber) {
            const student = allStudents.find(s => s.rollNumber === rollNumber);
            return student ? student.class : 'N/A';
        }

        // ==================== SEPARATE EXPORT FUNCTIONS ====================

        // Export Students to Excel
        function exportStudentsToExcel() {
            showMessage('Preparing students data for export...', 'info');
            
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                
                if (!students) {
                    showToast('No students data to export!', 'error');
                    showMessage('', '');
                    return;
                }
                
                const workbook = XLSX.utils.book_new();
                const fileName = `Mudrasa_Students_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Export Students sheet
                const studentsData = [];
                studentsData.push(['Roll Number', 'Name', 'Class', 'Status', 'Date Added']);
                
                Object.keys(students).forEach(rollNumber => {
                    const student = students[rollNumber];
                    studentsData.push([
                        student.rollNumber,
                        student.name,
                        student.class,
                        student.status || 'Active',
                        new Date(student.dateAdded).toLocaleDateString()
                    ]);
                });
                
                const studentsSheet = XLSX.utils.aoa_to_sheet(studentsData);
                XLSX.utils.book_append_sheet(workbook, studentsSheet, "Students");
                
                XLSX.writeFile(workbook, fileName);
                showToast('Students data exported successfully!', 'success');
                showMessage('', '');
            }).catch(error => {
                showToast('Error exporting students data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // Export Results to Excel
        function exportResultsToExcel() {
            showMessage('Preparing results data for export...', 'info');
            
            database.ref('results').once('value', snapshot => {
                const results = snapshot.val();
                
                if (!results) {
                    showToast('No results data to export!', 'error');
                    showMessage('', '');
                    return;
                }
                
                const workbook = XLSX.utils.book_new();
                const fileName = `Mudrasa_Results_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Export Results sheet
                const resultsData = [];
                resultsData.push(['Roll No', 'Name', 'Month', 'Nazra', 'Kalma', 'Namaz', 'Total', 'Percentage', 'Grade', 'Fine', 'Absent Days', 'Date']);
                
                Object.keys(results).forEach(resultId => {
                    const result = results[resultId];
                    resultsData.push([
                        result.studentRoll,
                        result.studentName,
                        result.examMonth,
                        `${result.subjects.nazra.obtained}/${result.subjects.nazra.total}`,
                        `${result.subjects.kalma.obtained}/${result.subjects.kalma.total}`,
                        `${result.subjects.namaz.obtained}/${result.subjects.namaz.total}`,
                        `${result.totalObtained}/${result.overallTotal}`,
                        result.percentage + '%',
                        result.grade,
                        result.fine || 0,
                        result.absentDays || 0,
                        new Date(result.date).toLocaleDateString()
                    ]);
                });
                
                const resultsSheet = XLSX.utils.aoa_to_sheet(resultsData);
                XLSX.utils.book_append_sheet(workbook, resultsSheet, "Results");
                
                XLSX.writeFile(workbook, fileName);
                showToast('Results data exported successfully!', 'success');
                showMessage('', '');
            }).catch(error => {
                showToast('Error exporting results data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // Export Attendance to Excel
        function exportAttendanceToExcel() {
            showMessage('Preparing attendance data for export...', 'info');
            
            Promise.all([
                database.ref('students').once('value'),
                database.ref('attendance').once('value')
            ]).then(([studentsSnap, attendanceSnap]) => {
                const students = studentsSnap.val();
                const attendance = attendanceSnap.val();
                
                if (!attendance) {
                    showToast('No attendance data to export!', 'error');
                    showMessage('', '');
                    return;
                }
                
                const workbook = XLSX.utils.book_new();
                const fileName = `Mudrasa_Attendance_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Export Attendance sheet
                const attendanceData = [];
                attendanceData.push(['Date', 'Class', 'Roll No', 'Name', 'Status']);
                
                Object.keys(attendance).forEach(attendanceId => {
                    const record = attendance[attendanceId];
                    Object.keys(record.students || {}).forEach(rollNumber => {
                        // Find student name
                        let studentName = '';
                        if (students && students[rollNumber]) {
                            studentName = students[rollNumber].name;
                        }
                        
                        attendanceData.push([
                            record.date,
                            record.class,
                            rollNumber,
                            studentName,
                            record.students[rollNumber]
                        ]);
                    });
                });
                
                const attendanceSheet = XLSX.utils.aoa_to_sheet(attendanceData);
                XLSX.utils.book_append_sheet(workbook, attendanceSheet, "Attendance");
                
                XLSX.writeFile(workbook, fileName);
                showToast('Attendance data exported successfully!', 'success');
                showMessage('', '');
            }).catch(error => {
                showToast('Error exporting attendance data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // Export Positions to Excel
        function exportPositionsToExcel() {
            showMessage('Preparing positions data for export...', 'info');
            
            Promise.all([
                database.ref('students').once('value'),
                database.ref('results').once('value'),
                database.ref('classPositions').once('value')
            ]).then(([studentsSnap, resultsSnap, positionsSnap]) => {
                const students = studentsSnap.val();
                const results = resultsSnap.val();
                const positions = positionsSnap.val();
                
                if (!positions) {
                    showToast('No positions data to export!', 'error');
                    showMessage('', '');
                    return;
                }
                
                const workbook = XLSX.utils.book_new();
                const fileName = `Mudrasa_Positions_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Export Positions sheet
                const positionsData = [];
                positionsData.push(['Month', 'Class', 'Position', 'Roll No', 'Name', 'Percentage']);
                
                Object.keys(positions).forEach(month => {
                    const classPos = positions[month].positions;
                    Object.keys(classPos).forEach(className => {
                        const pos = classPos[className];
                        for (let i = 1; i <= 3; i++) {
                            if (pos[i]) {
                                // Find student name
                                let studentName = '';
                                if (students && students[pos[i]]) {
                                    studentName = students[pos[i]].name;
                                }
                                
                                // Find percentage
                                let percentage = '';
                                if (results) {
                                    Object.values(results).forEach(result => {
                                        if (result.studentRoll === pos[i] && result.examMonth === month) {
                                            percentage = result.percentage + '%';
                                        }
                                    });
                                }
                                
                                let positionText = '';
                                if (i === 1) positionText = '1st Position ü•á';
                                else if (i === 2) positionText = '2nd Position ü•à';
                                else if (i === 3) positionText = '3rd Position ü•â';
                                
                                positionsData.push([
                                    month,
                                    className,
                                    positionText,
                                    pos[i],
                                    studentName,
                                    percentage
                                ]);
                            }
                        }
                    });
                });
                
                const positionsSheet = XLSX.utils.aoa_to_sheet(positionsData);
                XLSX.utils.book_append_sheet(workbook, positionsSheet, "Positions");
                
                XLSX.writeFile(workbook, fileName);
                showToast('Positions data exported successfully!', 'success');
                showMessage('', '');
            }).catch(error => {
                showToast('Error exporting positions data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // Export All Data to Excel (Single File with Multiple Sheets)
        function exportAllToExcel() {
            showMessage('Preparing all data for export...', 'info');
            
            Promise.all([
                database.ref('students').once('value'),
                database.ref('results').once('value'),
                database.ref('attendance').once('value'),
                database.ref('classPositions').once('value')
            ]).then(([studentsSnap, resultsSnap, attendanceSnap, positionsSnap]) => {
                const students = studentsSnap.val();
                const results = resultsSnap.val();
                const attendance = attendanceSnap.val();
                const positions = positionsSnap.val();
                
                if (!students && !results && !attendance && !positions) {
                    showToast('No data to export!', 'error');
                    showMessage('', '');
                    return;
                }
                
                const workbook = XLSX.utils.book_new();
                const fileName = `Mudrasa_All_Data_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                // Export Students sheet
                if (students) {
                    const studentsData = [];
                    studentsData.push(['Roll Number', 'Name', 'Class', 'Status', 'Date Added']);
                    
                    Object.keys(students).forEach(rollNumber => {
                        const student = students[rollNumber];
                        studentsData.push([
                            student.rollNumber,
                            student.name,
                            student.class,
                            student.status || 'Active',
                            new Date(student.dateAdded).toLocaleDateString()
                        ]);
                    });
                    
                    const studentsSheet = XLSX.utils.aoa_to_sheet(studentsData);
                    XLSX.utils.book_append_sheet(workbook, studentsSheet, "Students");
                }
                
                // Export Results sheet
                if (results) {
                    const resultsData = [];
                    resultsData.push(['Roll No', 'Name', 'Month', 'Nazra', 'Kalma', 'Namaz', 'Total', 'Percentage', 'Grade', 'Fine', 'Absent Days', 'Date']);
                    
                    Object.keys(results).forEach(resultId => {
                        const result = results[resultId];
                        resultsData.push([
                            result.studentRoll,
                            result.studentName,
                            result.examMonth,
                            `${result.subjects.nazra.obtained}/${result.subjects.nazra.total}`,
                            `${result.subjects.kalma.obtained}/${result.subjects.kalma.total}`,
                            `${result.subjects.namaz.obtained}/${result.subjects.namaz.total}`,
                            `${result.totalObtained}/${result.overallTotal}`,
                            result.percentage + '%',
                            result.grade,
                            result.fine || 0,
                            result.absentDays || 0,
                            new Date(result.date).toLocaleDateString()
                        ]);
                    });
                    
                    const resultsSheet = XLSX.utils.aoa_to_sheet(resultsData);
                    XLSX.utils.book_append_sheet(workbook, resultsSheet, "Results");
                }
                
                // Export Attendance sheet
                if (attendance) {
                    const attendanceData = [];
                    attendanceData.push(['Date', 'Class', 'Roll No', 'Name', 'Status']);
                    
                    Object.keys(attendance).forEach(attendanceId => {
                        const record = attendance[attendanceId];
                        Object.keys(record.students || {}).forEach(rollNumber => {
                            // Find student name
                            let studentName = '';
                            if (students && students[rollNumber]) {
                                studentName = students[rollNumber].name;
                            }
                            
                            attendanceData.push([
                                record.date,
                                record.class,
                                rollNumber,
                                studentName,
                                record.students[rollNumber]
                            ]);
                        });
                    });
                    
                    const attendanceSheet = XLSX.utils.aoa_to_sheet(attendanceData);
                    XLSX.utils.book_append_sheet(workbook, attendanceSheet, "Attendance");
                }
                
                // Export Positions sheet
                if (positions) {
                    const positionsData = [];
                    positionsData.push(['Month', 'Class', 'Position', 'Roll No', 'Name', 'Percentage']);
                    
                    Object.keys(positions).forEach(month => {
                        const classPos = positions[month].positions;
                        Object.keys(classPos).forEach(className => {
                            const pos = classPos[className];
                            for (let i = 1; i <= 3; i++) {
                                if (pos[i]) {
                                    // Find student name
                                    let studentName = '';
                                    if (students && students[pos[i]]) {
                                        studentName = students[pos[i]].name;
                                    }
                                    
                                    // Find percentage
                                    let percentage = '';
                                    if (results) {
                                        Object.values(results).forEach(result => {
                                            if (result.studentRoll === pos[i] && result.examMonth === month) {
                                                percentage = result.percentage + '%';
                                            }
                                        });
                                    }
                                    
                                    let positionText = '';
                                    if (i === 1) positionText = '1st Position ü•á';
                                    else if (i === 2) positionText = '2nd Position ü•à';
                                    else if (i === 3) positionText = '3rd Position ü•â';
                                    
                                    positionsData.push([
                                        month,
                                        className,
                                        positionText,
                                        pos[i],
                                        studentName,
                                        percentage
                                    ]);
                                }
                            }
                        });
                    });
                    
                    const positionsSheet = XLSX.utils.aoa_to_sheet(positionsData);
                    XLSX.utils.book_append_sheet(workbook, positionsSheet, "Positions");
                }
                
                XLSX.writeFile(workbook, fileName);
                showToast('All data exported successfully!', 'success');
                showMessage('', '');
            }).catch(error => {
                showToast('Error exporting data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // ==================== DELETE FUNCTIONS ====================

        // Delete all results
        function deleteAllResults() {
            const confirmation = confirm('Are you sure you want to delete ALL results? This action cannot be undone!\n\nEnter admin code to confirm:');
            if (!confirmation) return;
            
            const enteredCode = prompt('Enter admin code to confirm deletion:');
            if (enteredCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            showMessage('Deleting results...', 'warning');
            
            database.ref('results').remove()
                .then(() => {
                    showToast('All results deleted successfully!', 'success');
                    showMessage('', '');
                })
                .catch(error => {
                    showToast('Error deleting results: ' + error.message, 'error');
                    showMessage('', '');
                });
        }

        // Delete all students
        function deleteAllStudents() {
            const confirmation = confirm('Are you sure you want to delete ALL students? This will also remove all their results!\n\nEnter admin code to confirm:');
            if (!confirmation) return;
            
            const enteredCode = prompt('Enter admin code to confirm deletion:');
            if (enteredCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            showMessage('Deleting students...', 'warning');
            
            database.ref('students').remove()
                .then(() => {
                    showToast('All students deleted successfully!', 'success');
                    loadAllStudentsTable();
                    loadStudentList();
                    showMessage('', '');
                })
                .catch(error => {
                    showToast('Error deleting students: ' + error.message, 'error');
                    showMessage('', '');
                });
        }

        // Delete all attendance
        function deleteAllAttendance() {
            const confirmation = confirm('Are you sure you want to delete ALL attendance records?\n\nEnter admin code to confirm:');
            if (!confirmation) return;
            
            const enteredCode = prompt('Enter admin code to confirm deletion:');
            if (enteredCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            showMessage('Deleting attendance...', 'warning');
            
            database.ref('attendance').remove()
                .then(() => {
                    showToast('All attendance records deleted successfully!', 'success');
                    showMessage('', '');
                })
                .catch(error => {
                    showToast('Error deleting attendance: ' + error.message, 'error');
                    showMessage('', '');
                });
        }

        // Delete all positions
        function deleteAllPositions() {
            const confirmation = confirm('Are you sure you want to delete ALL positions records?\n\nEnter admin code to confirm:');
            if (!confirmation) return;
            
            const enteredCode = prompt('Enter admin code to confirm deletion:');
            if (enteredCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            showMessage('Deleting positions...', 'warning');
            
            database.ref('classPositions').remove()
                .then(() => {
                    showToast('All positions records deleted successfully!', 'success');
                    showMessage('', '');
                })
                .catch(error => {
                    showToast('Error deleting positions: ' + error.message, 'error');
                    showMessage('', '');
                });
        }

        // Delete all data
        function deleteAllData() {
            const confirmation = confirm('WARNING: This will delete ALL students, results, attendance and positions! This action cannot be undone!\n\nEnter admin code to confirm:');
            if (!confirmation) return;
            
            const enteredCode = prompt('Enter admin code to confirm deletion:');
            if (enteredCode !== ADMIN_CODE) {
                showToast('Invalid admin code! Deletion cancelled.', 'error');
                return;
            }
            
            showMessage('Deleting all data...', 'warning');
            
            Promise.all([
                database.ref('students').remove(),
                database.ref('results').remove(),
                database.ref('attendance').remove(),
                database.ref('classPositions').remove()
            ]).then(() => {
                showToast('All data deleted successfully!', 'success');
                loadAllStudentsTable();
                loadStudentList();
                showMessage('', '');
            }).catch(error => {
                showToast('Error deleting data: ' + error.message, 'error');
                showMessage('', '');
            });
        }

        // Load all students (global)
        function loadAllStudents() {
            database.ref('students').once('value', snapshot => {
                const students = snapshot.val();
                allStudents = students ? Object.values(students) : [];
            });
        }
    </script>
</body>
</html>