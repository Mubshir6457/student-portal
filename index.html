<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faizan-e-Raza Madarsa Result Portal</title>
<style>
:root {
  --primary: #2e7d32;
  --primary-dark: #1b5e20;
  --primary-light: #4caf50;
  --secondary: #d4af37;
  --accent: #1976d2;
  --danger: #d32f2f;
  --warning: #ff9800;
  --success: #388e3c;
  --light-bg: #f8fff8;
  --card-bg: #ffffff;
  --text: #333333;
  --text-light: #666666;
  --border: #e0e0e0;
  --shadow: 0 2px 8px rgba(0,0,0,0.1);
}

* {
  box-sizing: border-box;
}

body { 
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
  background: var(--light-bg); 
  margin: 0; 
  padding: 0; 
  color: var(--text);
  line-height: 1.6;
}

header { 
  background: linear-gradient(to right, var(--primary), var(--secondary)); 
  color: white; 
  text-align: center; 
  padding: 1rem; 
  font-size: 1.4rem; 
  font-weight: bold;
  box-shadow: var(--shadow);
}

nav { 
  display: flex; 
  justify-content: center; 
  flex-wrap: wrap; 
  background: var(--card-bg); 
  border-bottom: 2px solid var(--border);
  padding: 0.5rem;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow);
}

nav button { 
  margin: 5px; 
  padding: 10px 18px; 
  border: none; 
  background: var(--primary); 
  color: white; 
  border-radius: 5px; 
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.3s ease;
  flex: 1;
  min-width: 120px;
  max-width: 200px;
}

nav button:hover { 
  background: var(--primary-dark); 
  transform: translateY(-2px);
}

section { 
  display: none; 
  padding: 20px; 
  max-width: 1200px;
  margin: 0 auto;
}

.active { 
  display: block; 
}

.hidden { 
  display: none; 
}

input, select { 
  width: 100%; 
  padding: 12px; 
  margin-top: 8px; 
  border: 1px solid var(--border); 
  border-radius: 5px; 
  font-size: 1rem;
  transition: border 0.3s;
}

input:focus, select:focus {
  border-color: var(--primary);
  outline: none;
  box-shadow: 0 0 0 2px rgba(46, 125, 50, 0.2);
}

.btn { 
  background: var(--success); 
  color: white; 
  border: none; 
  padding: 12px 18px; 
  border-radius: 5px; 
  cursor: pointer; 
  margin-top: 10px;
  font-size: 1rem;
  transition: all 0.3s ease;
  display: inline-block;
  text-align: center;
}

.btn:hover { 
  background: var(--primary-dark); 
  transform: translateY(-2px);
}

.btn-info { 
  background: var(--accent); 
  color: white; 
  border: none; 
  padding: 8px 14px; 
  border-radius: 5px; 
  cursor: pointer; 
  margin-top: 5px; 
  margin-left: 10px; 
}

.btn-info:hover { 
  background: #1565c0; 
}

.btn-danger { 
  background: var(--danger); 
  color: white; 
  border: none; 
  padding: 8px 14px; 
  border-radius: 5px; 
  cursor: pointer; 
  margin-top: 5px; 
  margin-left: 10px; 
}

.btn-danger:hover { 
  background: #b71c1c; 
}

.btn-warning { 
  background: var(--warning); 
  color: white; 
  border: none; 
  padding: 8px 14px; 
  border-radius: 5px; 
  cursor: pointer; 
  margin-top: 5px; 
  margin-left: 10px; 
}

.btn-warning:hover { 
  background: #f57c00; 
}

table { 
  width: 100%; 
  border-collapse: collapse; 
  margin-top: 15px;
  box-shadow: var(--shadow);
  border-radius: 8px;
  overflow: hidden;
}

th, td { 
  border: 1px solid var(--border); 
  padding: 12px; 
  text-align: center; 
}

th { 
  background: #e8f5e9; 
  font-weight: 600;
}

.result-card { 
  background: var(--card-bg); 
  border-radius: 8px; 
  padding: 20px; 
  margin-top: 20px; 
  box-shadow: var(--shadow);
  border-left: 4px solid var(--primary);
}

.position-1st { 
  color: var(--secondary); 
  font-weight: bold; 
  font-size: 1.2em; 
}

.position-2nd { 
  color: var(--primary); 
  font-weight: bold; 
}

.position-3rd { 
  color: var(--primary-dark); 
  font-weight: bold; 
}

.position-pass { 
  color: var(--text-light); 
}

.absent { 
  color: var(--danger); 
  font-weight: bold; 
}

.flower { 
  position: fixed; 
  font-size: 20px; 
  opacity: 0; 
  z-index: 1000; 
  pointer-events: none; 
}

@keyframes fall {
  0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}

.confirmation-dialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 25px;
  border-radius: 8px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  z-index: 2000;
  text-align: center;
  max-width: 90%;
  width: 400px;
}

.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1999;
}

.attendance-inputs {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
  flex-wrap: wrap;
}

.attendance-inputs input {
  flex: 1;
  min-width: 150px;
}

.fine-calc { 
  background: #fff3cd; 
  padding: 15px; 
  border-radius: 5px; 
  margin: 15px 0; 
  border: 1px solid #ffeaa7;
}

.edit-form {
  background: #e8f5e9;
  padding: 20px;
  border-radius: 8px;
  margin: 20px 0;
  border: 1px solid #c8e6c9;
}

.currency {
  font-weight: bold;
  color: var(--primary);
}

.student-edit-form {
  background: #e3f2fd;
  padding: 20px;
  border-radius: 8px;
  margin: 20px 0;
  border: 2px solid var(--accent);
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 15px;
}

/* Mobile-specific styles */
@media (max-width: 768px) {
  header {
    font-size: 1.2rem;
    padding: 0.8rem;
  }
  
  nav {
    padding: 0.3rem;
  }
  
  nav button {
    padding: 8px 12px;
    font-size: 0.8rem;
    min-width: 100px;
  }
  
  section {
    padding: 15px;
  }
  
  table {
    font-size: 0.85rem;
  }
  
  th, td {
    padding: 8px 5px;
  }
  
  .btn {
    padding: 10px 15px;
    width: 100%;
    margin: 5px 0;
  }
  
  .form-grid {
    grid-template-columns: 1fr;
  }
  
  .attendance-inputs {
    flex-direction: column;
  }
  
  .confirmation-dialog {
    width: 90%;
    padding: 20px;
  }
}

@media (max-width: 480px) {
  header {
    font-size: 1rem;
  }
  
  nav button {
    min-width: 80px;
    font-size: 0.75rem;
    padding: 6px 8px;
  }
  
  table {
    display: block;
    overflow-x: auto;
  }
  
  input, select {
    padding: 10px;
  }
}

/* Sequential numbering styles */
.sequential-number {
  display: inline-block;
  width: 30px;
  height: 30px;
  line-height: 30px;
  text-align: center;
  background: var(--primary);
  color: white;
  border-radius: 50%;
  margin-right: 10px;
  font-weight: bold;
}

/* Eye-friendly improvements */
h1, h2, h3 {
  color: var(--primary-dark);
  margin-top: 0;
}

p {
  margin: 10px 0;
}

label {
  display: block;
  margin-bottom: 5px;
  font-weight: 500;
  color: var(--text);
}

/* Loading spinner */
.spinner {
  border: 4px solid rgba(0, 0, 0, 0.1);
  border-left-color: var(--primary);
  border-radius: 50%;
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
  margin: 20px auto;
  display: none;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Success/Error messages */
.message {
  padding: 10px 15px;
  border-radius: 5px;
  margin: 10px 0;
  font-weight: 500;
}

.message.success {
  background: #e8f5e9;
  color: var(--success);
  border: 1px solid #c8e6c9;
}

.message.error {
  background: #ffebee;
  color: var(--danger);
  border: 1px solid #ffcdd2;
}

.message.info {
  background: #e3f2fd;
  color: var(--accent);
  border: 1px solid #bbdefb;
}

.roll-warning {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  padding: 10px;
  border-radius: 5px;
  margin: 10px 0;
  color: #856404;
}
</style>
</head>
<body>

<header>🕌 Faizan-e-Raza Madarsa Result Portal</header>

<nav>
  <button onclick="showSection('resultSection')">Check Result</button>
  <button id="loginBtn" onclick="showSection('loginSection')">Admin Login</button>
  <button id="studentBtn" class="hidden" onclick="showSection('studentSection')">Add / Exit Student</button>
  <button id="allStudentBtn" class="hidden" onclick="showSection('allStudentsSection')">All Students</button>
  <button id="exitListBtn" class="hidden" onclick="showSection('exitListSection')">Exit Student List</button>
  <button id="resultBtn" class="hidden" onclick="showSection('addResultSection')">Add Results</button>
  <button id="allResultBtn" class="hidden" onclick="showSection('allResultsSection')">All Results</button>
  <button id="changeCodeBtn" class="hidden" onclick="showSection('changeCodeSection')">Change Admin Code</button>
  <button id="logoutBtn" class="hidden" onclick="adminLogout()">Logout</button>
</nav>

<!-- 🟢 PUBLIC RESULT CHECK -->
<section id="resultSection" class="active">
  <h2>Check Student Result</h2>
  <input type="text" id="searchRoll" placeholder="Enter Roll Number">
  <button class="btn" onclick="checkResult()">Check</button>
  <div id="resultOutput"></div>
</section>

<!-- 🔐 ADMIN LOGIN -->
<section id="loginSection">
  <h2>Admin Login</h2>
  <input type="password" id="adminCode" placeholder="Enter Admin Code">
  <button class="btn" onclick="adminLogin()">Login</button>
  <p id="loginMsg"></p>
</section>

<!-- 🧑‍🎓 ADD / EXIT STUDENT -->
<section id="studentSection">
  <h2>Add Student</h2>
  <input type="text" id="nameInput" placeholder="Student Name">
  <input type="text" id="fatherInput" placeholder="Father Name">
  <input type="text" id="phoneInput" placeholder="Phone Number">
  <input type="text" id="rollInput" placeholder="Roll Number">
  <input type="date" id="admissionInput">
  <select id="categoryInput">
    <option value="">Select Class</option>
    <option>Noorani Qaida</option>
    <option>Separa</option>
    <option>Nazra</option>
    <option>Hifz</option>
  </select>
  <button class="btn" onclick="addStudent()">Add Student</button>
  <p id="stdMsg"></p>
  <hr>
  <h2>Exit Student</h2>
  <input type="text" id="exitRoll" placeholder="Enter Roll Number">
  <input type="date" id="exitDate">
  <input type="text" id="exitReason" placeholder="Reason for Exit">
  <button class="btn" onclick="exitStudent()">Exit Student</button>
  <p id="exitMsg"></p>
</section>

<!-- 📋 ALL STUDENTS -->
<section id="allStudentsSection">
  <h2>All Students</h2>
  <button class="btn" onclick="loadAllStudents()">Refresh</button>
  
  <!-- Student Edit Form (Hidden by default) -->
  <div id="editStudentForm" class="student-edit-form hidden">
    <h3>✏️ Edit Student Information</h3>
    <input type="hidden" id="editStudentRoll">
    <div class="form-grid">
      <div>
        <label>Roll Number</label>
        <input type="text" id="editStudentNewRoll" placeholder="New Roll Number">
        <div id="rollWarning" class="roll-warning hidden">
          ⚠ Changing roll number will update all related records
        </div>
      </div>
      <div>
        <label>Student Name</label>
        <input type="text" id="editStudentName" placeholder="Student Name">
      </div>
      <div>
        <label>Father Name</label>
        <input type="text" id="editStudentFather" placeholder="Father Name">
      </div>
      <div>
        <label>Phone Number</label>
        <input type="text" id="editStudentPhone" placeholder="Phone Number">
      </div>
      <div>
        <label>Admission Date</label>
        <input type="date" id="editStudentAdmission">
      </div>
      <div>
        <label>Class</label>
        <select id="editStudentCategory">
          <option value="">Select Class</option>
          <option>Noorani Qaida</option>
          <option>Separa</option>
          <option>Nazra</option>
          <option>Hifz</option>
        </select>
      </div>
    </div>
    <button class="btn" onclick="updateStudent()">💾 Update Student</button>
    <button class="btn-warning" onclick="cancelStudentEdit()">❌ Cancel</button>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Roll</th>
        <th>Name</th>
        <th>Father</th>
        <th>Phone</th>
        <th>Class</th>
        <th>Admission</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="allStudentsTable"></tbody>
  </table>
</section>

<!-- 🧾 EXIT LIST -->
<section id="exitListSection">
  <h2>Exit Student List</h2>
  <button class="btn" onclick="loadExitList()">Refresh</button>
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Roll</th>
        <th>Name</th>
        <th>Date</th>
        <th>Reason</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="exitStudentsTable"></tbody>
  </table>
</section>

<!-- 🧮 ADD RESULTS -->
<section id="addResultSection">
  <h2>Add Monthly Results</h2>
  <input type="text" id="monthInput" placeholder="Month (e.g. October)">
  
  <h3>Set Total Marks</h3>
  <input type="number" id="namazTotal" placeholder="Namaz Total">
  <input type="number" id="kalmaTotal" placeholder="Kalma Total">
  <input type="number" id="quranTotal" placeholder="Nazra Total">
  
  <h3>Set Attendance Details</h3>
  <div class="attendance-inputs">
    <input type="number" id="totalWorkingDays" placeholder="Total Working Days" required>
  </div>
  
  <div class="fine-calc">
    <strong>💰 Fine Calculation:</strong>
    <p><span class="currency">Rs.</span> 10 per absent day will be automatically calculated</p>
    <p>Fine = (Total Working Days - Present Days) × <span class="currency">Rs.</span> 10</p>
  </div>
  
  <button class="btn" onclick="loadStudentsForResults()">Load Students</button>
  <div id="resultTableContainer"></div>
  <button class="btn" onclick="saveAllResults()">💾 Save All Results</button>
  <p id="resMsg"></p>
</section>

<!-- 📊 ALL RESULTS -->
<section id="allResultsSection">
  <h2>All Results</h2>
  <button class="btn" onclick="loadAllResults()">Refresh</button>
  <button class="btn-danger" onclick="showDeleteConfirmation()">🗑 Delete All Results</button>
  
  <!-- Edit Form (Hidden by default) -->
  <div id="editResultForm" class="edit-form hidden">
    <h3>✏️ Edit Result</h3>
    <input type="hidden" id="editResultKey">
    <div class="attendance-inputs">
      <input type="number" id="editNamazObt" placeholder="Namaz Obtained">
      <input type="number" id="editKalmaObt" placeholder="Kalma Obtained">
      <input type="number" id="editQuranObt" placeholder="Nazra Obtained">
    </div>
    <div class="attendance-inputs">
      <input type="number" id="editPresentDays" placeholder="Present Days">
      <input type="number" id="editTotalWorkingDays" placeholder="Total Working Days">
    </div>
    <div class="attendance-inputs">
      <input type="number" id="editFine" placeholder="Fine Amount">
      <select id="editPosition">
        <option value="">Select Position</option>
        <option value="1st">1st Position</option>
        <option value="2nd">2nd Position</option>
        <option value="3rd">3rd Position</option>
        <option value="Pass">Pass</option>
      </select>
    </div>
    <button class="btn" onclick="updateResult()">💾 Update Result</button>
    <button class="btn-warning" onclick="cancelEdit()">❌ Cancel</button>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Roll</th>
        <th>Name</th>
        <th>Father</th>
        <th>Month</th>
        <th>Total</th>
        <th>Attendance</th>
        <th>Position</th>
        <th>Fine</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="allResultsTable"></tbody>
  </table>
</section>

<!-- 🔑 CHANGE ADMIN CODE -->
<section id="changeCodeSection">
  <h2>Change Admin Code</h2>
  <input type="password" id="oldCode" placeholder="Old Code">
  <input type="password" id="newCode" placeholder="New Code">
  <button class="btn" onclick="changeAdminCode()">Change</button>
  <p id="codeMsg"></p>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get, child, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB_zOJiXH5ZSHs4miirkF4p7Fc6NUDuNiY",
  authDomain: "faizan-e-raza-madarsa-8c743.firebaseapp.com",
  databaseURL: "https://faizan-e-raza-madarsa-8c743-default-rtdb.firebaseio.com",
  projectId: "faizan-e-raza-madarsa-8c743",
  storageBucket: "faizan-e-raza-madarsa-8c743.firebasestorage.app",
  messagingSenderId: "659467130617",
  appId: "1:659467130617:web:9ed42e7bb8e3eea5917428"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ✅ Ensure Admin Code exists in Firebase
const adminRef = ref(db, "admin/code");
get(adminRef).then(snap => { if (!snap.exists()) set(adminRef, "6457"); });

// Navigation
window.showSection=id=>{
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

// 🔐 Admin Login
window.adminLogin=async()=>{
  const code=adminCode.value.trim();
  const snap=await get(ref(db,"admin/code"));
  const realCode=snap.exists()?snap.val():"6457";
  if(code===realCode){
    document.querySelectorAll("#studentBtn,#logoutBtn,#resultBtn,#allResultBtn,#changeCodeBtn,#exitListBtn,#allStudentBtn")
      .forEach(b=>b.classList.remove("hidden"));
    document.getElementById("loginBtn").classList.add("hidden");
    loginMsg.textContent="✅ Login Successful!";
    showSection("studentSection");
  } else loginMsg.textContent="❌ Wrong Admin Code!";
};

// Logout
window.adminLogout=()=>{
  document.querySelectorAll("#studentBtn,#logoutBtn,#resultBtn,#allResultBtn,#changeCodeBtn,#exitListBtn,#allStudentBtn")
    .forEach(b=>b.classList.add("hidden"));
  document.getElementById("loginBtn").classList.remove("hidden");
  showSection("resultSection");
};

// Add Student
window.addStudent=async()=>{
  if(!nameInput.value||!fatherInput.value||!rollInput.value||!categoryInput.value)
    return stdMsg.textContent="⚠ Fill all fields!";
  await set(ref(db,"students/"+rollInput.value),{
    name:nameInput.value,father:fatherInput.value,phone:phoneInput.value,
    roll:rollInput.value,admission:admissionInput.value,category:categoryInput.value
  });
  stdMsg.textContent="✅ Student Added!";
  nameInput.value=fatherInput.value=phoneInput.value=rollInput.value="";
};

// Exit Student
window.exitStudent=async()=>{
  const roll=exitRoll.value.trim();
  if(!roll||!exitDate.value||!exitReason.value)
    return exitMsg.textContent="⚠ Fill all fields!";
  const s=await get(child(ref(db),"students/"+roll));
  if(s.exists()){
    const st=s.val();
    await set(ref(db,"exited/"+roll),{roll,name:st.name,date:exitDate.value,reason:exitReason.value});
    await remove(ref(db,"students/"+roll));
    exitMsg.textContent="✅ Student Exited!";
  } else exitMsg.textContent="❌ Roll Not Found!";
};

// Exit List
window.loadExitList=()=>{
  get(child(ref(db),"exited")).then(snap=>{
    exitStudentsTable.innerHTML="";
    if(snap.exists()){
      let count = 1;
      snap.forEach(c=>{
        const s=c.val();
        exitStudentsTable.innerHTML+=`<tr>
          <td>${count}</td>
          <td>${s.roll}</td>
          <td>${s.name}</td>
          <td>${s.date}</td>
          <td>${s.reason}</td>
          <td><button onclick="deleteExitStudent('${s.roll}')">🗑</button></td>
        </tr>`;
        count++;
      });
    } else exitStudentsTable.innerHTML="<tr><td colspan='6'>No Exited Students</td></tr>";
  });
};
window.deleteExitStudent=async(roll)=>{await remove(ref(db,"exited/"+roll));loadExitList();};

// All Students
window.loadAllStudents=()=>{
  get(child(ref(db),"students")).then(snap=>{
    allStudentsTable.innerHTML="";
    if(snap.exists()){
      let count = 1;
      snap.forEach(c=>{
        const s=c.val();
        allStudentsTable.innerHTML+=`<tr>
          <td>${count}</td>
          <td>${s.roll}</td>
          <td>${s.name}</td>
          <td>${s.father}</td>
          <td>${s.phone}</td>
          <td>${s.category}</td>
          <td>${s.admission}</td>
          <td>
            <button class="btn-info" onclick="editStudent('${s.roll}')">✏️ Edit</button>
            <button class="btn-danger" onclick="deleteStudent('${s.roll}')">🗑 Delete</button>
          </td>
        </tr>`;
        count++;
      });
    } else allStudentsTable.innerHTML="<tr><td colspan='8'>No Students</td></tr>";
  });
};

// Edit Student
window.editStudent = async (roll) => {
  const studentRef = ref(db, "students/" + roll);
  const snapshot = await get(studentRef);
  
  if (snapshot.exists()) {
    const student = snapshot.val();
    
    // Show edit form
    document.getElementById('editStudentForm').classList.remove('hidden');
    
    // Fill form with current data
    document.getElementById('editStudentRoll').value = roll;
    document.getElementById('editStudentNewRoll').value = roll;
    document.getElementById('editStudentName').value = student.name || '';
    document.getElementById('editStudentFather').value = student.father || '';
    document.getElementById('editStudentPhone').value = student.phone || '';
    document.getElementById('editStudentAdmission').value = student.admission || '';
    document.getElementById('editStudentCategory').value = student.category || '';
    
    // Show warning when roll number is changed
    document.getElementById('editStudentNewRoll').addEventListener('input', function() {
      if(this.value !== roll) {
        document.getElementById('rollWarning').classList.remove('hidden');
      } else {
        document.getElementById('rollWarning').classList.add('hidden');
      }
    });
    
    // Scroll to edit form
    document.getElementById('editStudentForm').scrollIntoView({ behavior: 'smooth' });
  }
};

// Update Student
window.updateStudent = async () => {
  const oldRoll = document.getElementById('editStudentRoll').value;
  const newRoll = document.getElementById('editStudentNewRoll').value;
  
  const name = document.getElementById('editStudentName').value;
  const father = document.getElementById('editStudentFather').value;
  const phone = document.getElementById('editStudentPhone').value;
  const admission = document.getElementById('editStudentAdmission').value;
  const category = document.getElementById('editStudentCategory').value;
  
  if(!name || !father || !category || !newRoll) {
    alert("⚠ Please fill all required fields!");
    return;
  }
  
  const updates = {
    name: name,
    father: father,
    phone: phone,
    admission: admission,
    category: category,
    roll: newRoll
  };
  
  try {
    // If roll number is changed, we need to:
    // 1. Create new student record with new roll
    // 2. Update all results with new roll
    // 3. Delete old student record
    
    if(oldRoll !== newRoll) {
      // Check if new roll number already exists
      const existingStudent = await get(ref(db, "students/" + newRoll));
      if(existingStudent.exists()) {
        alert("❌ Roll number already exists! Please use a different roll number.");
        return;
      }
      
      // Create new student record
      await set(ref(db, "students/" + newRoll), updates);
      
      // Update all results with new roll number
      const resultsSnap = await get(child(ref(db), "results"));
      if(resultsSnap.exists()) {
        const updatePromises = [];
        resultsSnap.forEach(c => {
          const result = c.val();
          if(result.roll === oldRoll) {
            // Create new result with updated roll
            const newResult = {...result, roll: newRoll};
            const newKey = newRoll + "_" + result.month;
            updatePromises.push(set(ref(db, "results/" + newKey), newResult));
            // Delete old result
            updatePromises.push(remove(ref(db, "results/" + c.key)));
          }
        });
        await Promise.all(updatePromises);
      }
      
      // Delete old student record
      await remove(ref(db, "students/" + oldRoll));
      
    } else {
      // Just update the student record if roll number is same
      await update(ref(db, "students/" + oldRoll), updates);
    }
    
    document.getElementById('editStudentForm').classList.add('hidden');
    loadAllStudents();
    alert("✅ Student information updated successfully!");
  } catch (error) {
    alert("❌ Error updating student: " + error.message);
  }
};

// Cancel Student Edit
window.cancelStudentEdit = () => {
  document.getElementById('editStudentForm').classList.add('hidden');
};

// Delete Student
window.deleteStudent=async(roll)=>{
  if(confirm("Are you sure you want to delete this student? This will also delete all their results!")) {
    try {
      // Delete student
      await remove(ref(db,"students/"+roll));
      
      // Delete student's results
      const resultsSnap = await get(child(ref(db), "results"));
      if(resultsSnap.exists()) {
        const deletePromises = [];
        resultsSnap.forEach(c => {
          const result = c.val();
          if(result.roll === roll) {
            deletePromises.push(remove(ref(db, "results/" + c.key)));
          }
        });
        await Promise.all(deletePromises);
      }
      
      loadAllStudents();
      alert("✅ Student and their results deleted successfully!");
    } catch (error) {
      alert("❌ Error deleting student: " + error.message);
    }
  }
};

// Add Results
window.loadStudentsForResults=()=>{
  const totalWorkingDays = document.getElementById('totalWorkingDays').value;
  if(!totalWorkingDays) {
    alert("⚠ Please enter Total Working Days first!");
    return;
  }

  get(child(ref(db),"students")).then(snap=>{
    if(!snap.exists())return resultTableContainer.innerHTML="<p>No Students Found</p>";
    
    let html=`<table><thead><tr>
      <th>#</th>
      <th>Roll</th>
      <th>Name</th>
      <th>Father</th>
      <th>Namaz</th>
      <th>Kalma</th>
      <th>Nazra</th>
      <th>Present Days</th>
      <th>Auto Fine (<span class="currency">Rs.</span> 10/day)</th>
      <th>Position</th>
    </tr></thead><tbody>`;
    
    let count = 1;
    snap.forEach(c=>{
      const s=c.val();
      html+=`<tr>
        <td>${count}</td>
        <td>${s.roll}</td>
        <td>${s.name}</td>
        <td>${s.father}</td>
        <td><input type='number' id='n${s.roll}' placeholder='0' min='0' max='${document.getElementById('namazTotal').value || 100}'></td>
        <td><input type='number' id='k${s.roll}' placeholder='0' min='0' max='${document.getElementById('kalmaTotal').value || 100}'></td>
        <td><input type='number' id='q${s.roll}' placeholder='0' min='0' max='${document.getElementById('quranTotal').value || 100}'></td>
        <td><input type='number' id='a${s.roll}' placeholder='0' min='0' max='${totalWorkingDays}' onchange="calculateAutoFine('${s.roll}')"></td>
        <td><span id='autoFine${s.roll}'><span class="currency">Rs.</span> 0</span></td>
        <td><select id='p${s.roll}'><option value=''>Select Position</option><option value='1st'>1st Position</option><option value='2nd'>2nd Position</option><option value='3rd'>3rd Position</option><option value='Pass'>Pass</option></select></td>
      </tr>`;
      count++;
    });
    html+="</tbody></table>";
    resultTableContainer.innerHTML=html;
  });
};

// Calculate automatic fine
window.calculateAutoFine = (roll) => {
  const totalWorkingDays = +document.getElementById('totalWorkingDays').value;
  const presentDays = +document.getElementById('a'+roll).value || 0;
  const absentDays = totalWorkingDays - presentDays;
  const autoFine = absentDays * 10; // Rs. 10 per absent day
  
  document.getElementById('autoFine'+roll).innerHTML = `<span class="currency">Rs.</span> ${autoFine}`;
};

// Save Results (month-wise)
window.saveAllResults=async()=>{
  const month=monthInput.value.trim();
  if(!month)return resMsg.textContent="⚠ Enter month!";
  
  const nT=+namazTotal.value,kT=+kalmaTotal.value,qT=+quranTotal.value;
  const totalWorkingDays = +document.getElementById('totalWorkingDays').value;
  if(!totalWorkingDays)return resMsg.textContent="⚠ Enter Total Working Days!";
  
  const snap=await get(child(ref(db),"students"));
  if(!snap.exists())return resMsg.textContent="⚠ No Students!";
  
  const promises=[];
  snap.forEach(c=>{
    const s=c.val();
    const positionValue = document.getElementById('p'+s.roll)?.value || '';
    const presentDays = +document.getElementById('a'+s.roll)?.value || 0;
    const absentDays = totalWorkingDays - presentDays;
    const autoFine = absentDays * 10; // Rs. 10 per absent day
    
    // Calculate attendance percentage
    const attendancePercentage = totalWorkingDays > 0 ? Math.round((presentDays / totalWorkingDays) * 100) : 0;
    
    const d={
      roll:s.roll,name:s.name,father:s.father,month,
      namazObt:document.getElementById('n'+s.roll)?.value||0,
      kalmaObt:document.getElementById('k'+s.roll)?.value||0,
      quranObt:document.getElementById('q'+s.roll)?.value||0,
      presentDays: presentDays,
      totalWorkingDays: totalWorkingDays,
      attendancePercentage: attendancePercentage,
      position:positionValue,
      fine: autoFine, // Auto calculated fine
      namazTotal:nT,kalmaTotal:kT,quranTotal:qT
    };
    promises.push(set(ref(db,"results/"+s.roll+"_"+month),d));
  });
  await Promise.all(promises);
  resMsg.textContent="✅ All Results Saved!";
};

// All Results
window.loadAllResults=()=>{
  get(child(ref(db),"results")).then(snap=>{
    allResultsTable.innerHTML="";
    if(snap.exists()){
      let count = 1;
      snap.forEach(c=>{
        const r=c.val();
        const obt=(+r.namazObt||0)+(+r.kalmaObt||0)+(+r.quranObt||0);
        const total=(+r.namazTotal||0)+(+r.kalmaTotal||0)+(+r.quranTotal||0);
        
        let positionClass = "";
        let positionDisplay = r.position || "-";
        
        if(r.position === "1st") positionClass = "position-1st";
        else if(r.position === "2nd") positionClass = "position-2nd";
        else if(r.position === "3rd") positionClass = "position-3rd";
        else if(r.position === "Pass") positionClass = "position-pass";
        
        allResultsTable.innerHTML+=`<tr>
          <td>${count}</td>
          <td>${r.roll}</td>
          <td>${r.name}</td>
          <td>${r.father}</td>
          <td>${r.month}</td>
          <td>${obt}/${total}</td>
          <td>${r.presentDays}/${r.totalWorkingDays} (${r.attendancePercentage}%)</td>
          <td class="${positionClass}">${positionDisplay}</td>
          <td><span class="currency">Rs.</span> ${r.fine||0}</td>
          <td>
            <button class="btn-info" onclick="editResult('${c.key}')">✏️ Edit</button>
            <button class="btn-danger" onclick="deleteResult('${c.key}')">🗑 Delete</button>
          </td>
        </tr>`;
        count++;
      });
    } else allResultsTable.innerHTML="<tr><td colspan='10'>No Results Found</td></tr>";
  });
};

// Edit Result
window.editResult = async (key) => {
  const resultRef = ref(db, "results/" + key);
  const snapshot = await get(resultRef);
  
  if (snapshot.exists()) {
    const result = snapshot.val();
    
    // Show edit form
    document.getElementById('editResultForm').classList.remove('hidden');
    
    // Fill form with current data
    document.getElementById('editResultKey').value = key;
    document.getElementById('editNamazObt').value = result.namazObt || 0;
    document.getElementById('editKalmaObt').value = result.kalmaObt || 0;
    document.getElementById('editQuranObt').value = result.quranObt || 0;
    document.getElementById('editPresentDays').value = result.presentDays || 0;
    document.getElementById('editTotalWorkingDays').value = result.totalWorkingDays || 0;
    document.getElementById('editFine').value = result.fine || 0;
    document.getElementById('editPosition').value = result.position || '';
    
    // Scroll to edit form
    document.getElementById('editResultForm').scrollIntoView({ behavior: 'smooth' });
  }
};

// Update Result
window.updateResult = async () => {
  const key = document.getElementById('editResultKey').value;
  const resultRef = ref(db, "results/" + key);
  
  const namazObt = +document.getElementById('editNamazObt').value || 0;
  const kalmaObt = +document.getElementById('editKalmaObt').value || 0;
  const quranObt = +document.getElementById('editQuranObt').value || 0;
  const presentDays = +document.getElementById('editPresentDays').value || 0;
  const totalWorkingDays = +document.getElementById('editTotalWorkingDays').value || 0;
  const fine = +document.getElementById('editFine').value || 0;
  const position = document.getElementById('editPosition').value;
  
  // Calculate attendance percentage
  const attendancePercentage = totalWorkingDays > 0 ? Math.round((presentDays / totalWorkingDays) * 100) : 0;
  
  const updates = {
    namazObt: namazObt,
    kalmaObt: kalmaObt,
    quranObt: quranObt,
    presentDays: presentDays,
    totalWorkingDays: totalWorkingDays,
    attendancePercentage: attendancePercentage,
    fine: fine,
    position: position
  };
  
  try {
    await update(resultRef, updates);
    document.getElementById('editResultForm').classList.add('hidden');
    loadAllResults();
    alert("✅ Result updated successfully!");
  } catch (error) {
    alert("❌ Error updating result: " + error.message);
  }
};

// Cancel Edit
window.cancelEdit = () => {
  document.getElementById('editResultForm').classList.add('hidden');
};

// Delete Result
window.deleteResult=async(key)=>{
  if(confirm("Are you sure you want to delete this result?")) {
    await remove(ref(db,"results/"+key));
    loadAllResults();
  }
};

// Delete All Results
window.showDeleteConfirmation=()=>{
  const dialog = document.createElement('div');
  dialog.className = 'confirmation-dialog';
  dialog.innerHTML = `
    <h3>⚠ Delete All Results</h3>
    <p>Are you sure you want to delete ALL results?</p>
    <p style="color: red; font-weight: bold;">This action cannot be undone!</p>
    <button class="btn-danger" onclick="deleteAllResults()">Yes, Delete All</button>
    <button class="btn" onclick="closeConfirmation()" style="margin-left: 10px;">Cancel</button>
  `;
  
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  
  document.body.appendChild(overlay);
  document.body.appendChild(dialog);
};

window.closeConfirmation=()=>{
  const dialog = document.querySelector('.confirmation-dialog');
  const overlay = document.querySelector('.overlay');
  if(dialog) document.body.removeChild(dialog);
  if(overlay) document.body.removeChild(overlay);
};

window.deleteAllResults=async()=>{
  try {
    await remove(ref(db, "results"));
    closeConfirmation();
    loadAllResults();
    alert("✅ All results deleted successfully!");
  } catch (error) {
    alert("❌ Error deleting results: " + error.message);
  }
};

// Flower animation function with different durations and new flowers
function createFlowers(position) {
  // No flowers for Pass students
  if(position === "Pass") return;
  
  const flowerContainer = document.createElement('div');
  flowerContainer.id = 'flowerContainer';
  flowerContainer.style.position = 'fixed';
  flowerContainer.style.top = '0';
  flowerContainer.style.left = '0';
  flowerContainer.style.width = '100%';
  flowerContainer.style.height = '100%';
  flowerContainer.style.pointerEvents = 'none';
  flowerContainer.style.zIndex = '1000';
  document.body.appendChild(flowerContainer);

  let flowers = [];
  let flowerCount = 0;
  let maxFlowers = 0;
  let duration = 0;
  let intervalTime = 0;
  
  // Set different parameters based on position with NEW FLOWERS
  if(position === "1st") {
    flowers = ["💐", "🌺", "🏵️"]; // New flowers for 1st position
    maxFlowers = 25;
    duration = 7000;
    intervalTime = 150;
  } else if(position === "2nd") {
    flowers = ["🌷", "🌻", "🥀"]; // New flowers for 2nd position
    maxFlowers = 18;
    duration = 5000;
    intervalTime = 200;
  } else if(position === "3rd") {
    flowers = ["🌼", "🌸", "💮"]; // New flowers for 3rd position
    maxFlowers = 12;
    duration = 4000;
    intervalTime = 250;
  }
  
  const interval = setInterval(() => {
    if(flowerCount >= maxFlowers) {
      clearInterval(interval);
      setTimeout(() => {
        if(document.getElementById('flowerContainer')) {
          document.body.removeChild(flowerContainer);
        }
      }, 1000);
      return;
    }
    
    flowers.forEach(flower => {
      const flowerElement = document.createElement('div');
      flowerElement.className = 'flower';
      flowerElement.innerHTML = flower;
      flowerElement.style.left = Math.random() * 100 + 'vw';
      flowerElement.style.animation = `fall ${Math.random() * 2 + 3}s linear forwards`;
      flowerContainer.appendChild(flowerElement);
      
      setTimeout(() => {
        if(flowerElement.parentNode === flowerContainer) {
          flowerContainer.removeChild(flowerElement);
        }
      }, 6000);
    });
    
    flowerCount += flowers.length;
  }, intervalTime);

  setTimeout(() => {
    clearInterval(interval);
    setTimeout(() => {
      if(document.getElementById('flowerContainer')) {
        document.body.removeChild(flowerContainer);
      }
    }, 1000);
  }, duration);
}

// Check Result (Public)
window.checkResult=()=>{
  const roll=searchRoll.value.trim();
  if(!roll)return resultOutput.textContent="⚠ Enter Roll Number!";
  
  get(child(ref(db),"results")).then(snap=>{
    if(snap.exists()){
      let found=false;
      let latestResult = null;
      
      // Find the latest result for this roll number
      snap.forEach(c=>{
        const d=c.val();
        if(d.roll===roll){
          found=true;
          // Keep the most recent result (assuming chronological order)
          if(!latestResult || d.month > latestResult.month) {
            latestResult = d;
          }
        }
      });
      
      if(found && latestResult) {
        const d = latestResult;
        const obt=(+d.namazObt)+(+d.kalmaObt)+(+d.quranObt);
        const total=(+d.namazTotal)+(+d.kalmaTotal)+(+d.quranTotal);
        
        let positionClass = "";
        let positionDisplay = d.position || "Not assigned";
        
        if(d.position === "1st") positionClass = "position-1st";
        else if(d.position === "2nd") positionClass = "position-2nd";
        else if(d.position === "3rd") positionClass = "position-3rd";
        else if(d.position === "Pass") positionClass = "position-pass";
        
        // Check if student has marks (not absent)
        const hasMarks = (+d.namazObt || +d.kalmaObt || +d.quranObt) > 0;
        
        // Create flower animation based on position with different durations
        if(d.position && d.position !== "Pass" && hasMarks) {
          createFlowers(d.position);
        }
        
        resultOutput.innerHTML=`<div class="result-card">
        <h3>${d.name} (${d.roll})</h3>
        <p><b>Father:</b> ${d.father}</p>
        <p><b>Month:</b> ${d.month}</p>
        ${hasMarks ? `
          <p>Namaz: ${d.namazObt}/${d.namazTotal}</p>
          <p>Kalma: ${d.kalmaObt}/${d.kalmaTotal}</p>
          <p>Nazra: ${d.quranObt}/${d.quranTotal}</p>
          <p>Attendance: ${d.presentDays}/${d.totalWorkingDays} Days (${d.attendancePercentage}%)</p>
          <p><b>Position:</b> <span class="${positionClass}">${positionDisplay}</span></p>
          <p><b>Fine:</b> <span class="currency">Rs.</span> ${d.fine||0}</p>
          <p><b>Total Marks:</b> ${obt}/${total}</p>
        ` : `
          <p class="absent"><b>Status: ABSENT</b></p>
          <p>Attendance: ${d.presentDays}/${d.totalWorkingDays} Days (${d.attendancePercentage}%)</p>
          <p><b>Fine:</b> <span class="currency">Rs.</span> ${d.fine||0}</p>
        `}
        </div>`;
      } else {
        // Student exists but has no results
        get(child(ref(db),"students/"+roll)).then(studentSnap=>{
          if(studentSnap.exists()){
            const student = studentSnap.val();
            resultOutput.innerHTML=`<div class="result-card">
              <h3>${student.name} (${student.roll})</h3>
              <p><b>Father:</b> ${student.father}</p>
              <p style="color: #666; font-style: italic;">No result available yet. Please check back later.</p>
            </div>`;
          } else {
            resultOutput.textContent="❌ No Record Found!";
          }
        });
      }
    } else {
      // No results at all
      get(child(ref(db),"students/"+roll)).then(studentSnap=>{
        if(studentSnap.exists()){
          const student = studentSnap.val();
          resultOutput.innerHTML=`<div class="result-card">
            <h3>${student.name} (${student.roll})</h3>
            <p><b>Father:</b> ${student.father}</p>
            <p style="color: #666; font-style: italic;">No result available yet. Please check back later.</p>
          </div>`;
        } else {
          resultOutput.textContent="❌ No Record Found!";
        }
      });
    }
  });
};

// Change Admin Code (Firebase-based)
window.changeAdminCode=async()=>{
  const old=oldCode.value.trim(),newC=newCode.value.trim();
  const snap=await get(ref(db,"admin/code"));
  const realCode=snap.exists()?snap.val():"6457";
  if(old===realCode && newC){
    await set(ref(db,"admin/code"),newC);
    codeMsg.textContent="✅ Admin Code Changed Successfully!";
    oldCode.value=newCode.value="";
  } else codeMsg.textContent="❌ Wrong Old Code!";
};
</script>
</body>
</html>