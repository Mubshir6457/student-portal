<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Faizan-e-Raza Madarsa Result Portal</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5fff5; margin: 0; padding: 0; }
    header { background: linear-gradient(to right, #228b22, #d4af37); color: white; text-align: center; padding: 1rem; font-size: 1.4rem; font-weight: bold; }
    nav { display: flex; justify-content: center; background: #e8f5e9; border-bottom: 2px solid #c5e1a5; flex-wrap: wrap; }
    nav button { margin: 5px; padding: 10px 18px; border: none; background: #2e7d32; color: white; border-radius: 5px; cursor: pointer; }
    nav button:hover { background: #1b5e20; }
    section { display: none; padding: 20px; }
    .active { display: block; }
    .hidden { display: none; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
    .btn { background: #388e3c; color: white; border: none; padding: 8px 14px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
    .btn:hover { background: #2e7d32; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #c8e6c9; }
  </style>
</head>
<body>
  <header>üïå Faizan-e-Raza Madarsa Result Portal</header>

  <nav>
    <button onclick="showSection('resultSection')">Check Result</button>
    <button id="loginBtn" onclick="showSection('loginSection')">Admin Login</button>
    <button id="studentBtn" class="hidden" onclick="showSection('studentSection')">Add / Exit Student</button>
    <button id="allStudentBtn" class="hidden" onclick="showSection('allStudentsSection')">All Students</button>
    <button id="exitListBtn" class="hidden" onclick="showSection('exitListSection')">Exit Student List</button>
    <button id="resultBtn" class="hidden" onclick="showSection('addResultSection')">Add Result</button>
    <button id="allResultBtn" class="hidden" onclick="showSection('allResultsSection')">All Results</button>
    <button id="changeCodeBtn" class="hidden" onclick="showSection('changeCodeSection')">Change Admin Code</button>
    <button id="logoutBtn" class="hidden" onclick="adminLogout()">Logout</button>
  </nav>

  <!-- üîπ Check Result -->
  <section id="resultSection" class="active">
    <h2>Check Student Result</h2>
    <input type="text" id="searchRoll" placeholder="Enter Roll Number">
    <button class="btn" onclick="checkResult()">Check</button>
    <div id="resultOutput"></div>
  </section>

  <!-- üîπ Admin Login -->
  <section id="loginSection">
    <h2>Admin Login</h2>
    <input type="password" id="adminCode" placeholder="Enter Admin Code">
    <button class="btn" onclick="adminLogin()">Login</button>
    <p id="loginMsg"></p>
  </section>

  <!-- üîπ Add / Exit Student -->
  <section id="studentSection">
    <h2>Add Student</h2>
    <input type="text" id="nameInput" placeholder="Student Name">
    <input type="text" id="rollInput" placeholder="Roll Number">
    <input type="date" id="admissionInput">
    <select id="categoryInput">
      <option value="">Select Class/Category</option>
      <option value="Noorani Qaida">Noorani Qaida</option>
      <option value="Separa">Separa</option>
      <option value="Nazra">Nazra</option>
      <option value="Hifz">Hifz</option>
    </select>
    <button class="btn" onclick="addStudent()">Add Student</button>
    <p id="stdMsg"></p>
    <hr>
    <h2>Exit Student</h2>
    <input type="text" id="exitRoll" placeholder="Enter Roll Number">
    <input type="date" id="exitDate">
    <input type="text" id="exitReason" placeholder="Reason for Exit">
    <button class="btn" onclick="exitStudent()">Exit Student</button>
    <p id="exitMsg"></p>
  </section>

  <!-- üîπ All Students -->
  <section id="allStudentsSection">
    <h2>All Students</h2>
    <button class="btn" onclick="loadAllStudents()">Refresh List</button>
    <table>
      <thead><tr><th>Roll</th><th>Name</th><th>Class</th><th>Admission</th><th>Action</th></tr></thead>
      <tbody id="allStudentsTable"></tbody>
    </table>
  </section>

  <!-- üîπ Exit Student List -->
  <section id="exitListSection">
    <h2>Exit Student List</h2>
    <button class="btn" onclick="loadExitList()">Refresh</button>
    <table>
      <thead><tr><th>Roll</th><th>Name</th><th>Date</th><th>Reason</th><th>Action</th></tr></thead>
      <tbody id="exitStudentsTable"></tbody>
    </table>
  </section>

  <!-- üîπ Add Result -->
  <section id="addResultSection">
    <h2>Add Result</h2>
    <select id="rRoll"></select>
    <input type="text" id="rName" placeholder="Name">
    <input type="text" id="monthInput" placeholder="Month (e.g. October)">
    <input type="number" id="namazObt" placeholder="Namaz Obtained">
    <input type="number" id="namazTotal" placeholder="Namaz Total">
    <input type="number" id="quranObt" placeholder="Quran Obtained">
    <input type="number" id="quranTotal" placeholder="Quran Total">
    <input type="number" id="kalmaObt" placeholder="Kalma Obtained">
    <input type="number" id="kalmaTotal" placeholder="Kalma Total">
    <input type="number" id="attendance" placeholder="Attendance (%)">
    <button class="btn" onclick="addResult()">Add Result</button>
    <p id="resMsg"></p>
  </section>

  <!-- üîπ All Results -->
  <section id="allResultsSection">
    <h2>All Results</h2>
    <button class="btn" onclick="loadAllResults()">Refresh</button>
    <table>
      <thead><tr><th>Roll</th><th>Name</th><th>Month</th><th>Total Marks</th><th>Attendance</th><th>Action</th></tr></thead>
      <tbody id="allResultsTable"></tbody>
    </table>
  </section>

  <!-- üîπ Change Admin Code -->
  <section id="changeCodeSection">
    <h2>Change Admin Code</h2>
    <input type="password" id="oldCode" placeholder="Old Code">
    <input type="password" id="newCode" placeholder="New Code">
    <button class="btn" onclick="changeAdminCode()">Change</button>
    <p id="codeMsg"></p>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, get, child, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_zOJiXH5ZSHs4miirkF4p7Fc6NUDuNiY",
      authDomain: "faizan-e-raza-madarsa-8c743.firebaseapp.com",
      databaseURL: "https://faizan-e-raza-madarsa-8c743-default-rtdb.firebaseio.com",
      projectId: "faizan-e-raza-madarsa-8c743",
      storageBucket: "faizan-e-raza-madarsa-8c743.firebasestorage.app",
      messagingSenderId: "659467130617",
      appId: "1:659467130617:web:9ed42e7bb8e3eea5917428"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.showSection = id => {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    };

    if (!localStorage.getItem("adminCode")) localStorage.setItem("adminCode", "6457");

    window.adminLogin = function() {
      if (adminCode.value === localStorage.getItem("adminCode")) {
        ["loginBtn","studentBtn","logoutBtn","resultBtn","allResultBtn","changeCodeBtn","exitListBtn","allStudentBtn"]
          .forEach(id => document.getElementById(id).classList.toggle("hidden"));
        showSection("studentSection");
        loadRollNumbers();
      } else alert("‚ùå Wrong Admin Code!");
    };

    window.adminLogout = function() {
      ["loginBtn","studentBtn","logoutBtn","resultBtn","allResultBtn","changeCodeBtn","exitListBtn","allStudentBtn"]
        .forEach(id => document.getElementById(id).classList.toggle("hidden"));
      showSection("resultSection");
    };

    window.addStudent = function() {
      if (!nameInput.value || !rollInput.value || !categoryInput.value)
        return stdMsg.textContent = "‚ö† Please fill all fields!";
      set(ref(db, "students/" + rollInput.value), {
        name: nameInput.value, roll: rollInput.value, admission: admissionInput.value, category: categoryInput.value
      }).then(() => { stdMsg.textContent = "‚úÖ Student Added!"; loadRollNumbers(); });
    };

    window.exitStudent = async function() {
      const roll = exitRoll.value.trim(), date = exitDate.value, reason = exitReason.value.trim();
      if (!roll || !date || !reason) return exitMsg.textContent = "‚ö† Fill all fields!";
      const s = await get(child(ref(db), "students/" + roll));
      if (s.exists()) {
        const stu = s.val();
        await set(ref(db, "exited/" + roll), { roll, name: stu.name, date, reason });
        await remove(ref(db, "students/" + roll));
        await remove(ref(db, "results/" + roll));
        exitMsg.textContent = "‚úÖ Student Exited!";
        loadRollNumbers();
      } else exitMsg.textContent = "‚ùå Roll not found!";
    };

    window.loadAllStudents = function() {
      get(child(ref(db), "students")).then(snap => {
        allStudentsTable.innerHTML = "";
        if (snap.exists()) {
          snap.forEach(c => {
            const s = c.val();
            allStudentsTable.innerHTML += `<tr><td>${s.roll}</td><td>${s.name}</td><td>${s.category}</td><td>${s.admission}</td>
            <td><button onclick="deleteStudent('${s.roll}')">üóë Delete</button></td></tr>`;
          });
        } else allStudentsTable.innerHTML = "<tr><td colspan='5'>No Students Found</td></tr>";
      });
    };

    window.deleteStudent = async function(roll) {
      if (confirm("Delete this student?")) {
        await remove(ref(db, "students/" + roll));
        await remove(ref(db, "results/" + roll));
        loadAllStudents(); loadRollNumbers();
      }
    };

    window.loadExitList = function() {
      get(child(ref(db), "exited")).then(snap => {
        exitStudentsTable.innerHTML = "";
        if (snap.exists()) {
          snap.forEach(c => {
            const s = c.val();
            exitStudentsTable.innerHTML += `<tr><td>${s.roll}</td><td>${s.name}</td><td>${s.date}</td><td>${s.reason}</td>
            <td><button onclick="deleteExited('${s.roll}')">üóë Delete</button></td></tr>`;
          });
        } else exitStudentsTable.innerHTML = "<tr><td colspan='5'>No Exited Students Found</td></tr>";
      });
    };

    window.deleteExited = async function(roll) {
      if (confirm("Delete this exited student?")) {
        await remove(ref(db, "exited/" + roll));
        loadExitList();
      }
    };

    window.loadRollNumbers = function() {
      rRoll.innerHTML = "";
      get(child(ref(db), "students")).then(snap => {
        if (snap.exists()) {
          rRoll.innerHTML = "<option value=''>Select Roll</option>";
          snap.forEach(c => {
            const s = c.val();
            rRoll.innerHTML += `<option value='${s.roll}'>${s.roll} - ${s.name}</option>`;
          });
        } else rRoll.innerHTML = "<option>No Students Found</option>";
      });
    };

    window.addResult = function() {
      if (!rRoll.value || !rName.value || !monthInput.value)
        return resMsg.textContent = "‚ö† Fill all fields!";
      set(ref(db, "results/" + rRoll.value), {
        roll: rRoll.value, name: rName.value, month: monthInput.value,
        namazObt: namazObt.value, namazTotal: namazTotal.value,
        quranObt: quranObt.value, quranTotal: quranTotal.value,
        kalmaObt: kalmaObt.value, kalmaTotal: kalmaTotal.value,
        attendance: attendance.value
      }).then(() => resMsg.textContent = "‚úÖ Result Added!");
    };

    window.loadAllResults = function() {
      get(child(ref(db), "results")).then(snap => {
        allResultsTable.innerHTML = "";
        if (snap.exists()) {
          snap.forEach(c => {
            const r = c.val();
            const obt = (+r.namazObt||0)+(+r.quranObt||0)+(+r.kalmaObt||0);
            const total = (+r.namazTotal||0)+(+r.quranTotal||0)+(+r.kalmaTotal||0);
            allResultsTable.innerHTML += `<tr><td>${r.roll}</td><td>${r.name}</td><td>${r.month}</td><td>${obt}/${total}</td><td>${r.attendance}%</td>
            <td><button onclick="deleteResult('${r.roll}')">üóë Delete</button></td></tr>`;
          });
        } else allResultsTable.innerHTML = "<tr><td colspan='6'>No Results Found</td></tr>";
      });
    };

    window.deleteResult = async function(roll) {
      if (confirm("Delete this result?")) {
        await remove(ref(db, "results/" + roll));
        loadAllResults();
      }
    };

    window.changeAdminCode = function() {
      if (oldCode.value === localStorage.getItem("adminCode")) {
        localStorage.setItem("adminCode", newCode.value);
        codeMsg.textContent = "‚úÖ Code Changed!";
      } else codeMsg.textContent = "‚ùå Wrong old code!";
    };

    window.checkResult = function() {
      get(child(ref(db), "results/" + searchRoll.value)).then(snap => {
        if (snap.exists()) {
          const d = snap.val();
          const obt = (+d.namazObt||0)+(+d.quranObt||0)+(+d.kalmaObt||0);
          const total = (+d.namazTotal||0)+(+d.quranTotal||0)+(+d.kalmaTotal||0);
          resultOutput.innerHTML = `
            <h3>${d.name} (${d.roll})</h3>
            <p><b>Month:</b> ${d.month}</p>
            <p>Namaz: ${d.namazObt}/${d.namazTotal}</p>
            <p>Quran: ${d.quranObt}/${d.quranTotal}</p>
            <p>Kalma: ${d.kalmaObt}/${d.kalmaTotal}</p>
            <p>Attendance: ${d.attendance}%</p>
            <hr><b>Total:</b> ${obt}/${total}`;
        } else resultOutput.innerHTML = "‚ùå No record found!";
      });
    };
  </script>
</body>
</html>
