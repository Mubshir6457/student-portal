<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Faizan-e-Raza Madarsa Result Portal</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f5fff5; margin: 0; padding: 0; }
    header { background: linear-gradient(to right, #228b22, #d4af37); color: white; text-align: center; padding: 1rem; font-size: 1.4rem; font-weight: bold; }
    nav { display: flex; justify-content: center; background: #e8f5e9; border-bottom: 2px solid #c5e1a5; flex-wrap: wrap; }
    nav button { margin: 5px; padding: 10px 18px; border: none; background: #2e7d32; color: white; border-radius: 5px; cursor: pointer; }
    nav button:hover { background: #1b5e20; }
    section { display: none; padding: 20px; }
    .active { display: block; }
    .hidden { display: none; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 5px; }
    .btn { background: #388e3c; color: white; border: none; padding: 8px 14px; border-radius: 5px; cursor: pointer; margin-top: 5px; }
    .btn:hover { background: #2e7d32; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background: #c8e6c9; }
  </style>
</head>
<body>
  <header>üïå Faizan-e-Raza Madarsa Result Portal</header>

  <nav>
    <button onclick="showSection('resultSection')">Check Result</button>
    <button id="loginBtn" onclick="showSection('loginSection')">Admin Login</button>
    <button id="studentBtn" class="hidden" onclick="showSection('studentSection')">Add Student</button>
    <button id="studentListBtn" class="hidden" onclick="showSection('studentListSection')">Student List</button>
    <button id="exitListBtn" class="hidden" onclick="showSection('exitListSection')">Exit Student List</button>
    <button id="resultBtn" class="hidden" onclick="showSection('addResultSection')">Add Result</button>
    <button id="changeCodeBtn" class="hidden" onclick="showSection('changeCodeSection')">Change Admin Code</button>
    <button id="logoutBtn" class="hidden" onclick="adminLogout()">Logout</button>
  </nav>

  <!-- üîπ Result Check -->
  <section id="resultSection" class="active">
    <h2>Check Student Result</h2>
    <input type="text" id="searchRoll" placeholder="Enter Roll Number">
    <button class="btn" onclick="checkResult()">Check</button>
    <div id="resultOutput"></div>
  </section>

  <!-- üîπ Admin Login -->
  <section id="loginSection">
    <h2>Admin Login</h2>
    <input type="password" id="adminCode" placeholder="Enter Admin Code">
    <button class="btn" onclick="adminLogin()">Login</button>
    <p id="loginMsg"></p>
  </section>

  <!-- üîπ Add Student + Exit Student -->
  <section id="studentSection">
    <h2>Add Student</h2>
    <input type="text" id="name" placeholder="Student Name">
    <input type="text" id="roll" placeholder="Roll Number">
    <input type="date" id="admission" placeholder="Admission Date">

    <!-- üî∏ New Class/Category Field -->
    <select id="category">
      <option value="">Select Class/Category</option>
      <option value="Noorani Qaida">Noorani Qaida</option>
      <option value="Separa">Separa</option>
      <option value="Nazra">Nazra</option>
      <option value="Hifz">Hifz</option>
    </select>

    <button class="btn" onclick="addStudent()">Add Student</button>
    <p id="stdMsg"></p>

    <hr>
    <h2>Exit Student</h2>
    <input type="text" id="exitRoll" placeholder="Enter Roll Number">
    <input type="date" id="exitDate">
    <input type="text" id="exitReason" placeholder="Reason for Exit">
    <button class="btn" onclick="exitStudent()">Exit Student</button>
    <p id="exitMsg"></p>
  </section>

  <!-- üîπ Student List -->
  <section id="studentListSection">
    <h2>All Students</h2>
    <button class="btn" onclick="loadStudentList()">Refresh List</button>
    <table>
      <thead><tr><th>Roll</th><th>Name</th><th>Class</th><th>Admission Date</th></tr></thead>
      <tbody id="studentTable"></tbody>
    </table>
  </section>

  <!-- üîπ Exit Student List -->
  <section id="exitListSection">
    <h2>Exit Student List</h2>
    <button class="btn" onclick="loadExitList()">Refresh Exit List</button>
    <table>
      <thead><tr><th>Roll</th><th>Exit Date</th><th>Reason</th></tr></thead>
      <tbody id="exitTable"></tbody>
    </table>
  </section>

  <!-- üîπ Add Result -->
  <section id="addResultSection">
    <h2>Add Result</h2>
    <select id="rRoll"></select>
    <input type="text" id="rName" placeholder="Name">
    <input type="text" id="month" placeholder="Month (e.g. October)">
    <input type="number" id="namazObt" placeholder="Namaz Obtained">
    <input type="number" id="namazTotal" placeholder="Namaz Total">
    <input type="number" id="quranObt" placeholder="Quran Obtained">
    <input type="number" id="quranTotal" placeholder="Quran Total">
    <input type="number" id="kalmaObt" placeholder="Kalma Obtained">
    <input type="number" id="kalmaTotal" placeholder="Kalma Total">
    <input type="number" id="attendance" placeholder="Attendance (%)">
    <button class="btn" onclick="addResult()">Add Result</button>
    <p id="resMsg"></p>
  </section>

  <!-- üîπ Change Admin Code -->
  <section id="changeCodeSection">
    <h2>Change Admin Code</h2>
    <input type="password" id="oldCode" placeholder="Enter Old Code">
    <input type="password" id="newCode" placeholder="Enter New Code">
    <button class="btn" onclick="changeAdminCode()">Change Code</button>
    <p id="codeMsg"></p>
  </section>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, get, child, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB_zOJiXH5ZSHs4miirkF4p7Fc6NUDuNiY",
      authDomain: "faizan-e-raza-madarsa-8c743.firebaseapp.com",
      databaseURL: "https://faizan-e-raza-madarsa-8c743-default-rtdb.firebaseio.com",
      projectId: "faizan-e-raza-madarsa-8c743",
      storageBucket: "faizan-e-raza-madarsa-8c743.firebasestorage.app",
      messagingSenderId: "659467130617",
      appId: "1:659467130617:web:9ed42e7bb8e3eea5917428"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    window.showSection = function (id) {
      document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    };

    if (!localStorage.getItem("adminCode")) localStorage.setItem("adminCode", "6457");

    window.adminLogin = function () {
      const inputCode = document.getElementById("adminCode").value.trim();
      const msg = document.getElementById("loginMsg");
      const savedCode = localStorage.getItem("adminCode");

      if (inputCode === savedCode) {
        msg.textContent = "‚úÖ Login Successful!";
        msg.style.color = "green";
        ["loginBtn","studentBtn","resultBtn","logoutBtn","studentListBtn","changeCodeBtn","exitListBtn"].forEach(id => document.getElementById(id).classList.toggle("hidden"));
        showSection("studentSection");
        loadRollNumbers();
      } else {
        msg.textContent = "‚ùå Wrong Code!";
        msg.style.color = "red";
      }
    };

    window.adminLogout = function () {
      ["loginBtn","studentBtn","resultBtn","logoutBtn","studentListBtn","changeCodeBtn","exitListBtn"].forEach(id => document.getElementById(id).classList.toggle("hidden"));
      showSection("resultSection");
      alert("Logged out successfully!");
    };

    // --- Add Student ---
    window.addStudent = function () {
      const name = document.getElementById("name").value.trim();
      const roll = document.getElementById("roll").value.trim();
      const admission = document.getElementById("admission").value;
      const category = document.getElementById("category").value;
      const msg = document.getElementById("stdMsg");

      if (!name || !roll || !category) {
        msg.textContent = "‚ö† Please fill all fields!";
        return;
      }

      set(ref(db, "students/" + roll), { name, roll, admission, category })
        .then(() => {
          msg.textContent = "‚úÖ Student Added Successfully!";
          loadRollNumbers();
        })
        .catch(err => msg.textContent = "‚ùå Error: " + err.message);
    };

    // --- Exit Student ---
    window.exitStudent = function () {
      const roll = document.getElementById("exitRoll").value.trim();
      const date = document.getElementById("exitDate").value;
      const reason = document.getElementById("exitReason").value.trim();
      const msg = document.getElementById("exitMsg");

      if (!roll || !date || !reason) {
        msg.textContent = "‚ö† Please fill all fields!";
        msg.style.color = "red";
        return;
      }

      set(ref(db, "exited/" + roll), { roll, date, reason })
        .then(() => {
          remove(ref(db, "students/" + roll));
          remove(ref(db, "results/" + roll));
          msg.textContent = "‚úÖ Student Exited & Removed Successfully!";
          msg.style.color = "green";
        })
        .catch(err => msg.textContent = "‚ùå Error: " + err.message);
    };

    // --- Student List ---
    window.loadStudentList = function () {
      const table = document.getElementById("studentTable");
      const dbRef = ref(db);
      get(child(dbRef, "students")).then(snapshot => {
        table.innerHTML = "";
        if (snapshot.exists()) {
          snapshot.forEach(childSnap => {
            const s = childSnap.val();
            table.innerHTML += `<tr><td>${s.roll}</td><td>${s.name}</td><td>${s.category || "-"}</td><td>${s.admission || "-"}</td></tr>`;
          });
        } else table.innerHTML = "<tr><td colspan='4'>No Students Found</td></tr>";
      });
    };

    // --- Exit List ---
    window.loadExitList = function () {
      const table = document.getElementById("exitTable");
      const dbRef = ref(db);
      get(child(dbRef, "exited")).then(snapshot => {
        table.innerHTML = "";
        if (snapshot.exists()) {
          snapshot.forEach(childSnap => {
            const s = childSnap.val();
            table.innerHTML += `<tr><td>${s.roll}</td><td>${s.date}</td><td>${s.reason}</td></tr>`;
          });
        } else table.innerHTML = "<tr><td colspan='3'>No Exit Students Found</td></tr>";
      });
    };

    // --- Load Roll Numbers ---
    window.loadRollNumbers = function () {
      const select = document.getElementById("rRoll");
      select.innerHTML = "";
      const dbRef = ref(db);
      get(child(dbRef, "students")).then(snapshot => {
        if (snapshot.exists()) {
          select.innerHTML = "<option value=''>Select Roll Number</option>";
          snapshot.forEach(childSnap => {
            const s = childSnap.val();
            select.innerHTML += `<option value='${s.roll}'>${s.roll} - ${s.name}</option>`;
          });
        } else {
          select.innerHTML = "<option>No Students Found</option>";
        }
      });
    };

    // --- Add Result ---
    window.addResult = function () {
      const roll = document.getElementById("rRoll").value.trim();
      const name = document.getElementById("rName").value.trim();
      const month = document.getElementById("month").value.trim();
      const namazObt = document.getElementById("namazObt").value;
      const namazTotal = document.getElementById("namazTotal").value;
      const quranObt = document.getElementById("quranObt").value;
      const quranTotal = document.getElementById("quranTotal").value;
      const kalmaObt = document.getElementById("kalmaObt").value;
      const kalmaTotal = document.getElementById("kalmaTotal").value;
      const attendance = document.getElementById("attendance").value;
      const msg = document.getElementById("resMsg");

      if (!roll || !name || !month) {
        msg.textContent = "‚ö† Please fill all main fields!";
        return;
      }

      set(ref(db, "results/" + roll), {
        roll, name, month,
        namazObt, namazTotal,
        quranObt, quranTotal,
        kalmaObt, kalmaTotal,
        attendance
      }).then(() => msg.textContent = "‚úÖ Result Added Successfully!");
    };

    // --- Change Admin Code ---
    window.changeAdminCode = function () {
      const oldCode = document.getElementById("oldCode").value.trim();
      const newCode = document.getElementById("newCode").value.trim();
      const msg = document.getElementById("codeMsg");
      const savedCode = localStorage.getItem("adminCode");

      if (oldCode === savedCode && newCode) {
        localStorage.setItem("adminCode", newCode);
        msg.textContent = "‚úÖ Admin Code Changed Successfully!";
        msg.style.color = "green";
      } else {
        msg.textContent = "‚ùå Wrong old code or empty new code!";
        msg.style.color = "red";
      }
    };

    // --- Check Result ---
    window.checkResult = function () {
      const roll = document.getElementById("searchRoll").value.trim();
      const output = document.getElementById("resultOutput");
      const dbRef = ref(db);

      get(child(dbRef, "results/" + roll)).then(snapshot => {
        if (snapshot.exists()) {
          const d = snapshot.val();
          const totalObt = Number(d.namazObt || 0) + Number(d.quranObt || 0) + Number(d.kalmaObt || 0);
          const totalMax = Number(d.namazTotal || 0) + Number(d.quranTotal || 0) + Number(d.kalmaTotal || 0);

          output.innerHTML = `
            <h3>${d.name} (Roll: ${d.roll})</h3>
            <p><b>Month:</b> ${d.month}</p>
            <p>üïå Namaz: ${d.namazObt}/${d.namazTotal}</p>
            <p>üìñ Quran: ${d.quranObt}/${d.quranTotal}</p>
            <p>‚ò™ Kalma: ${d.kalmaObt}/${d.kalmaTotal}</p>
            <p>üìÖ Attendance: ${d.attendance}%</p>
            <hr>
            <p><b>Total Marks:</b> ${totalObt}/${totalMax}</p>
          `;
        } else {
          output.innerHTML = "‚ùå No record found!";
        }
      });
    };
  </script>
</body>
</html>
