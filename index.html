<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Faizan-e-Raza Madarsa Result Portal</title>
<style>
body { font-family: Arial, sans-serif; background:#f5fff5; margin:0; padding:0; }
header { background:linear-gradient(to right,#228b22,#d4af37); color:white; text-align:center; padding:1rem; font-size:1.4rem; font-weight:bold; }
nav { display:flex; justify-content:center; flex-wrap:wrap; background:#e8f5e9; border-bottom:2px solid #c5e1a5; }
nav button { margin:5px; padding:10px 18px; border:none; background:#2e7d32; color:white; border-radius:5px; cursor:pointer; }
nav button:hover { background:#1b5e20; }
section { display:none; padding:20px; }
.active { display:block; }
.hidden { display:none; }
input, select { width:100%; padding:8px; margin-top:5px; border:1px solid #ccc; border-radius:5px; }
.btn { background:#388e3c; color:white; border:none; padding:8px 14px; border-radius:5px; cursor:pointer; margin-top:5px; }
.btn:hover { background:#2e7d32; }
.btn-info { background:#1976d2; color:white; border:none; padding:8px 14px; border-radius:5px; cursor:pointer; margin-top:5px; margin-left:10px; }
.btn-info:hover { background:#1565c0; }
.btn-danger { background:#d32f2f; color:white; border:none; padding:8px 14px; border-radius:5px; cursor:pointer; margin-top:5px; margin-left:10px; }
.btn-danger:hover { background:#b71c1c; }
.btn-warning { background:#ff9800; color:white; border:none; padding:8px 14px; border-radius:5px; cursor:pointer; margin-top:5px; margin-left:10px; }
.btn-warning:hover { background:#f57c00; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th,td { border:1px solid #ccc; padding:8px; text-align:center; }
th { background:#c8e6c9; }
.result-card { background:white; border-radius:8px; padding:15px; margin-top:15px; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
.position-1st { color: #d4af37; font-weight: bold; font-size: 1.2em; }
.position-2nd { color: #228b22; font-weight: bold; }
.position-3rd { color: #2e7d32; font-weight: bold; }
.position-pass { color: #666; }
.absent { color: #ff4444; font-weight: bold; }
.flower { position: fixed; font-size: 20px; opacity: 0; z-index: 1000; pointer-events: none; }
@keyframes fall {
  0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(360deg); opacity: 0; }
}
.confirmation-dialog {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  z-index: 2000;
  text-align: center;
}
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1999;
}
.attendance-inputs {
  display: flex;
  gap: 10px;
  margin-bottom: 15px;
}
.attendance-inputs input {
  flex: 1;
}
.fine-calc { 
  background: #fff3cd; 
  padding: 10px; 
  border-radius: 5px; 
  margin: 10px 0; 
  border: 1px solid #ffeaa7;
}
.edit-form {
  background: #e8f5e9;
  padding: 15px;
  border-radius: 8px;
  margin: 15px 0;
  border: 1px solid #c8e6c9;
}
.currency {
  font-weight: bold;
  color: #2e7d32;
}
.student-edit-form {
  background: #e3f2fd;
  padding: 20px;
  border-radius: 8px;
  margin: 20px 0;
  border: 2px solid #1976d2;
}
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
  margin-bottom: 15px;
}
</style>
</head>
<body>

<header>üïå Faizan-e-Raza Madarsa Result Portal</header>

<nav>
  <button onclick="showSection('resultSection')">Check Result</button>
  <button id="loginBtn" onclick="showSection('loginSection')">Admin Login</button>
  <button id="studentBtn" class="hidden" onclick="showSection('studentSection')">Add / Exit Student</button>
  <button id="allStudentBtn" class="hidden" onclick="showSection('allStudentsSection')">All Students</button>
  <button id="exitListBtn" class="hidden" onclick="showSection('exitListSection')">Exit Student List</button>
  <button id="resultBtn" class="hidden" onclick="showSection('addResultSection')">Add Results</button>
  <button id="allResultBtn" class="hidden" onclick="showSection('allResultsSection')">All Results</button>
  <button id="changeCodeBtn" class="hidden" onclick="showSection('changeCodeSection')">Change Admin Code</button>
  <button id="logoutBtn" class="hidden" onclick="adminLogout()">Logout</button>
</nav>

<!-- üü¢ PUBLIC RESULT CHECK -->
<section id="resultSection" class="active">
  <h2>Check Student Result</h2>
  <input type="text" id="searchRoll" placeholder="Enter Roll Number">
  <button class="btn" onclick="checkResult()">Check</button>
  <div id="resultOutput"></div>
</section>

<!-- üîê ADMIN LOGIN -->
<section id="loginSection">
  <h2>Admin Login</h2>
  <input type="password" id="adminCode" placeholder="Enter Admin Code">
  <button class="btn" onclick="adminLogin()">Login</button>
  <p id="loginMsg"></p>
</section>

<!-- üßë‚Äçüéì ADD / EXIT STUDENT -->
<section id="studentSection">
  <h2>Add Student</h2>
  <input type="text" id="nameInput" placeholder="Student Name">
  <input type="text" id="fatherInput" placeholder="Father Name">
  <input type="text" id="phoneInput" placeholder="Phone Number">
  <input type="text" id="rollInput" placeholder="Roll Number">
  <input type="date" id="admissionInput">
  <select id="categoryInput">
    <option value="">Select Class</option>
    <option>Noorani Qaida</option>
    <option>Separa</option>
    <option>Nazra</option>
    <option>Hifz</option>
  </select>
  <button class="btn" onclick="addStudent()">Add Student</button>
  <p id="stdMsg"></p>
  <hr>
  <h2>Exit Student</h2>
  <input type="text" id="exitRoll" placeholder="Enter Roll Number">
  <input type="date" id="exitDate">
  <input type="text" id="exitReason" placeholder="Reason for Exit">
  <button class="btn" onclick="exitStudent()">Exit Student</button>
  <p id="exitMsg"></p>
</section>

<!-- üìã ALL STUDENTS -->
<section id="allStudentsSection">
  <h2>All Students</h2>
  <button class="btn" onclick="loadAllStudents()">Refresh</button>
  
  <!-- Student Edit Form (Hidden by default) -->
  <div id="editStudentForm" class="student-edit-form hidden">
    <h3>‚úèÔ∏è Edit Student Information</h3>
    <input type="hidden" id="editStudentRoll">
    <div class="form-grid">
      <div>
        <label>Student Name</label>
        <input type="text" id="editStudentName" placeholder="Student Name">
      </div>
      <div>
        <label>Father Name</label>
        <input type="text" id="editStudentFather" placeholder="Father Name">
      </div>
      <div>
        <label>Phone Number</label>
        <input type="text" id="editStudentPhone" placeholder="Phone Number">
      </div>
      <div>
        <label>Admission Date</label>
        <input type="date" id="editStudentAdmission">
      </div>
      <div>
        <label>Class</label>
        <select id="editStudentCategory">
          <option value="">Select Class</option>
          <option>Noorani Qaida</option>
          <option>Separa</option>
          <option>Nazra</option>
          <option>Hifz</option>
        </select>
      </div>
    </div>
    <button class="btn" onclick="updateStudent()">üíæ Update Student</button>
    <button class="btn-warning" onclick="cancelStudentEdit()">‚ùå Cancel</button>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>Roll</th>
        <th>Name</th>
        <th>Father</th>
        <th>Phone</th>
        <th>Class</th>
        <th>Admission</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="allStudentsTable"></tbody>
  </table>
</section>

<!-- üßæ EXIT LIST -->
<section id="exitListSection">
  <h2>Exit Student List</h2>
  <button class="btn" onclick="loadExitList()">Refresh</button>
  <table>
    <thead><tr><th>Roll</th><th>Name</th><th>Date</th><th>Reason</th><th>Action</th></tr></thead>
    <tbody id="exitStudentsTable"></tbody>
  </table>
</section>

<!-- üßÆ ADD RESULTS -->
<section id="addResultSection">
  <h2>Add Monthly Results</h2>
  <input type="text" id="monthInput" placeholder="Month (e.g. October)">
  
  <h3>Set Total Marks</h3>
  <input type="number" id="namazTotal" placeholder="Namaz Total">
  <input type="number" id="kalmaTotal" placeholder="Kalma Total">
  <input type="number" id="quranTotal" placeholder="Nazra Total">
  
  <h3>Set Attendance Details</h3>
  <div class="attendance-inputs">
    <input type="number" id="totalWorkingDays" placeholder="Total Working Days" required>
  </div>
  
  <div class="fine-calc">
    <strong>üí∞ Fine Calculation:</strong>
    <p><span class="currency">Rs.</span> 10 per absent day will be automatically calculated</p>
    <p>Fine = (Total Working Days - Present Days) √ó <span class="currency">Rs.</span> 10</p>
  </div>
  
  <button class="btn" onclick="loadStudentsForResults()">Load Students</button>
  <div id="resultTableContainer"></div>
  <button class="btn" onclick="saveAllResults()">üíæ Save All Results</button>
  <p id="resMsg"></p>
</section>

<!-- üìä ALL RESULTS -->
<section id="allResultsSection">
  <h2>All Results</h2>
  <button class="btn" onclick="loadAllResults()">Refresh</button>
  <button class="btn-danger" onclick="showDeleteConfirmation()">üóë Delete All Results</button>
  
  <!-- Edit Form (Hidden by default) -->
  <div id="editResultForm" class="edit-form hidden">
    <h3>‚úèÔ∏è Edit Result</h3>
    <input type="hidden" id="editResultKey">
    <div class="attendance-inputs">
      <input type="number" id="editNamazObt" placeholder="Namaz Obtained">
      <input type="number" id="editKalmaObt" placeholder="Kalma Obtained">
      <input type="number" id="editQuranObt" placeholder="Nazra Obtained">
    </div>
    <div class="attendance-inputs">
      <input type="number" id="editPresentDays" placeholder="Present Days">
      <input type="number" id="editTotalWorkingDays" placeholder="Total Working Days">
    </div>
    <div class="attendance-inputs">
      <input type="number" id="editFine" placeholder="Fine Amount">
      <select id="editPosition">
        <option value="">Select Position</option>
        <option value="1st">1st Position</option>
        <option value="2nd">2nd Position</option>
        <option value="3rd">3rd Position</option>
        <option value="Pass">Pass</option>
      </select>
    </div>
    <button class="btn" onclick="updateResult()">üíæ Update Result</button>
    <button class="btn-warning" onclick="cancelEdit()">‚ùå Cancel</button>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>Roll</th>
        <th>Name</th>
        <th>Father</th>
        <th>Month</th>
        <th>Total</th>
        <th>Attendance</th>
        <th>Position</th>
        <th>Fine</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="allResultsTable"></tbody>
  </table>
</section>

<!-- üîë CHANGE ADMIN CODE -->
<section id="changeCodeSection">
  <h2>Change Admin Code</h2>
  <input type="password" id="oldCode" placeholder="Old Code">
  <input type="password" id="newCode" placeholder="New Code">
  <button class="btn" onclick="changeAdminCode()">Change</button>
  <p id="codeMsg"></p>
</section>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getDatabase, ref, set, get, child, remove, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyB_zOJiXH5ZSHs4miirkF4p7Fc6NUDuNiY",
  authDomain: "faizan-e-raza-madarsa-8c743.firebaseapp.com",
  databaseURL: "https://faizan-e-raza-madarsa-8c743-default-rtdb.firebaseio.com",
  projectId: "faizan-e-raza-madarsa-8c743",
  storageBucket: "faizan-e-raza-madarsa-8c743.firebasestorage.app",
  messagingSenderId: "659467130617",
  appId: "1:659467130617:web:9ed42e7bb8e3eea5917428"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ‚úÖ Ensure Admin Code exists in Firebase
const adminRef = ref(db, "admin/code");
get(adminRef).then(snap => { if (!snap.exists()) set(adminRef, "6457"); });

// Navigation
window.showSection=id=>{
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
};

// üîê Admin Login
window.adminLogin=async()=>{
  const code=adminCode.value.trim();
  const snap=await get(ref(db,"admin/code"));
  const realCode=snap.exists()?snap.val():"6457";
  if(code===realCode){
    document.querySelectorAll("#studentBtn,#logoutBtn,#resultBtn,#allResultBtn,#changeCodeBtn,#exitListBtn,#allStudentBtn")
      .forEach(b=>b.classList.remove("hidden"));
    document.getElementById("loginBtn").classList.add("hidden");
    loginMsg.textContent="‚úÖ Login Successful!";
    showSection("studentSection");
  } else loginMsg.textContent="‚ùå Wrong Admin Code!";
};

// Logout
window.adminLogout=()=>{
  document.querySelectorAll("#studentBtn,#logoutBtn,#resultBtn,#allResultBtn,#changeCodeBtn,#exitListBtn,#allStudentBtn")
    .forEach(b=>b.classList.add("hidden"));
  document.getElementById("loginBtn").classList.remove("hidden");
  showSection("resultSection");
};

// Add Student
window.addStudent=async()=>{
  if(!nameInput.value||!fatherInput.value||!rollInput.value||!categoryInput.value)
    return stdMsg.textContent="‚ö† Fill all fields!";
  await set(ref(db,"students/"+rollInput.value),{
    name:nameInput.value,father:fatherInput.value,phone:phoneInput.value,
    roll:rollInput.value,admission:admissionInput.value,category:categoryInput.value
  });
  stdMsg.textContent="‚úÖ Student Added!";
  nameInput.value=fatherInput.value=phoneInput.value=rollInput.value="";
};

// Exit Student
window.exitStudent=async()=>{
  const roll=exitRoll.value.trim();
  if(!roll||!exitDate.value||!exitReason.value)
    return exitMsg.textContent="‚ö† Fill all fields!";
  const s=await get(child(ref(db),"students/"+roll));
  if(s.exists()){
    const st=s.val();
    await set(ref(db,"exited/"+roll),{roll,name:st.name,date:exitDate.value,reason:exitReason.value});
    await remove(ref(db,"students/"+roll));
    exitMsg.textContent="‚úÖ Student Exited!";
  } else exitMsg.textContent="‚ùå Roll Not Found!";
};

// Exit List
window.loadExitList=()=>{
  get(child(ref(db),"exited")).then(snap=>{
    exitStudentsTable.innerHTML="";
    if(snap.exists()){
      snap.forEach(c=>{
        const s=c.val();
        exitStudentsTable.innerHTML+=`<tr><td>${s.roll}</td><td>${s.name}</td><td>${s.date}</td><td>${s.reason}</td>
        <td><button onclick="deleteExitStudent('${s.roll}')">üóë</button></td></tr>`;
      });
    } else exitStudentsTable.innerHTML="<tr><td colspan='5'>No Exited Students</td></tr>";
  });
};
window.deleteExitStudent=async(roll)=>{await remove(ref(db,"exited/"+roll));loadExitList();};

// All Students
window.loadAllStudents=()=>{
  get(child(ref(db),"students")).then(snap=>{
    allStudentsTable.innerHTML="";
    if(snap.exists()){
      snap.forEach(c=>{
        const s=c.val();
        allStudentsTable.innerHTML+=`<tr>
          <td>${s.roll}</td>
          <td>${s.name}</td>
          <td>${s.father}</td>
          <td>${s.phone}</td>
          <td>${s.category}</td>
          <td>${s.admission}</td>
          <td>
            <button class="btn-info" onclick="editStudent('${s.roll}')">‚úèÔ∏è Edit</button>
            <button class="btn-danger" onclick="deleteStudent('${s.roll}')">üóë Delete</button>
          </td>
        </tr>`;
      });
    } else allStudentsTable.innerHTML="<tr><td colspan='7'>No Students</td></tr>";
  });
};

// Edit Student
window.editStudent = async (roll) => {
  const studentRef = ref(db, "students/" + roll);
  const snapshot = await get(studentRef);
  
  if (snapshot.exists()) {
    const student = snapshot.val();
    
    // Show edit form
    document.getElementById('editStudentForm').classList.remove('hidden');
    
    // Fill form with current data
    document.getElementById('editStudentRoll').value = roll;
    document.getElementById('editStudentName').value = student.name || '';
    document.getElementById('editStudentFather').value = student.father || '';
    document.getElementById('editStudentPhone').value = student.phone || '';
    document.getElementById('editStudentAdmission').value = student.admission || '';
    document.getElementById('editStudentCategory').value = student.category || '';
    
    // Scroll to edit form
    document.getElementById('editStudentForm').scrollIntoView({ behavior: 'smooth' });
  }
};

// Update Student
window.updateStudent = async () => {
  const roll = document.getElementById('editStudentRoll').value;
  const studentRef = ref(db, "students/" + roll);
  
  const name = document.getElementById('editStudentName').value;
  const father = document.getElementById('editStudentFather').value;
  const phone = document.getElementById('editStudentPhone').value;
  const admission = document.getElementById('editStudentAdmission').value;
  const category = document.getElementById('editStudentCategory').value;
  
  if(!name || !father || !category) {
    alert("‚ö† Please fill all required fields!");
    return;
  }
  
  const updates = {
    name: name,
    father: father,
    phone: phone,
    admission: admission,
    category: category,
    roll: roll // Keep the same roll number
  };
  
  try {
    await update(studentRef, updates);
    document.getElementById('editStudentForm').classList.add('hidden');
    loadAllStudents();
    alert("‚úÖ Student information updated successfully!");
  } catch (error) {
    alert("‚ùå Error updating student: " + error.message);
  }
};

// Cancel Student Edit
window.cancelStudentEdit = () => {
  document.getElementById('editStudentForm').classList.add('hidden');
};

// Delete Student
window.deleteStudent=async(roll)=>{
  if(confirm("Are you sure you want to delete this student? This will also delete all their results!")) {
    try {
      // Delete student
      await remove(ref(db,"students/"+roll));
      
      // Delete student's results
      const resultsSnap = await get(child(ref(db), "results"));
      if(resultsSnap.exists()) {
        const deletePromises = [];
        resultsSnap.forEach(c => {
          const result = c.val();
          if(result.roll === roll) {
            deletePromises.push(remove(ref(db, "results/" + c.key)));
          }
        });
        await Promise.all(deletePromises);
      }
      
      loadAllStudents();
      alert("‚úÖ Student and their results deleted successfully!");
    } catch (error) {
      alert("‚ùå Error deleting student: " + error.message);
    }
  }
};

// Add Results
window.loadStudentsForResults=()=>{
  const totalWorkingDays = document.getElementById('totalWorkingDays').value;
  if(!totalWorkingDays) {
    alert("‚ö† Please enter Total Working Days first!");
    return;
  }

  get(child(ref(db),"students")).then(snap=>{
    if(!snap.exists())return resultTableContainer.innerHTML="<p>No Students Found</p>";
    
    let html=`<table><thead><tr><th>Roll</th><th>Name</th><th>Father</th><th>Namaz</th><th>Kalma</th><th>Nazra</th><th>Present Days</th><th>Auto Fine (<span class="currency">Rs.</span> 10/day)</th><th>Position</th></tr></thead><tbody>`;
    snap.forEach(c=>{
      const s=c.val();
      html+=`<tr>
        <td>${s.roll}</td>
        <td>${s.name}</td>
        <td>${s.father}</td>
        <td><input type='number' id='n${s.roll}' placeholder='0' min='0' max='${document.getElementById('namazTotal').value || 100}'></td>
        <td><input type='number' id='k${s.roll}' placeholder='0' min='0' max='${document.getElementById('kalmaTotal').value || 100}'></td>
        <td><input type='number' id='q${s.roll}' placeholder='0' min='0' max='${document.getElementById('quranTotal').value || 100}'></td>
        <td><input type='number' id='a${s.roll}' placeholder='0' min='0' max='${totalWorkingDays}' onchange="calculateAutoFine('${s.roll}')"></td>
        <td><span id='autoFine${s.roll}'><span class="currency">Rs.</span> 0</span></td>
        <td><select id='p${s.roll}'><option value=''>Select Position</option><option value='1st'>1st Position</option><option value='2nd'>2nd Position</option><option value='3rd'>3rd Position</option><option value='Pass'>Pass</option></select></td>
      </tr>`;
    });
    html+="</tbody></table>";
    resultTableContainer.innerHTML=html;
  });
};

// Calculate automatic fine
window.calculateAutoFine = (roll) => {
  const totalWorkingDays = +document.getElementById('totalWorkingDays').value;
  const presentDays = +document.getElementById('a'+roll).value || 0;
  const absentDays = totalWorkingDays - presentDays;
  const autoFine = absentDays * 10; // Rs. 10 per absent day
  
  document.getElementById('autoFine'+roll).innerHTML = `<span class="currency">Rs.</span> ${autoFine}`;
};

// Save Results (month-wise)
window.saveAllResults=async()=>{
  const month=monthInput.value.trim();
  if(!month)return resMsg.textContent="‚ö† Enter month!";
  
  const nT=+namazTotal.value,kT=+kalmaTotal.value,qT=+quranTotal.value;
  const totalWorkingDays = +document.getElementById('totalWorkingDays').value;
  if(!totalWorkingDays)return resMsg.textContent="‚ö† Enter Total Working Days!";
  
  const snap=await get(child(ref(db),"students"));
  if(!snap.exists())return resMsg.textContent="‚ö† No Students!";
  
  const promises=[];
  snap.forEach(c=>{
    const s=c.val();
    const positionValue = document.getElementById('p'+s.roll)?.value || '';
    const presentDays = +document.getElementById('a'+s.roll)?.value || 0;
    const absentDays = totalWorkingDays - presentDays;
    const autoFine = absentDays * 10; // Rs. 10 per absent day
    
    // Calculate attendance percentage
    const attendancePercentage = totalWorkingDays > 0 ? Math.round((presentDays / totalWorkingDays) * 100) : 0;
    
    const d={
      roll:s.roll,name:s.name,father:s.father,month,
      namazObt:document.getElementById('n'+s.roll)?.value||0,
      kalmaObt:document.getElementById('k'+s.roll)?.value||0,
      quranObt:document.getElementById('q'+s.roll)?.value||0,
      presentDays: presentDays,
      totalWorkingDays: totalWorkingDays,
      attendancePercentage: attendancePercentage,
      position:positionValue,
      fine: autoFine, // Auto calculated fine
      namazTotal:nT,kalmaTotal:kT,quranTotal:qT
    };
    promises.push(set(ref(db,"results/"+s.roll+"_"+month),d));
  });
  await Promise.all(promises);
  resMsg.textContent="‚úÖ All Results Saved!";
};

// All Results
window.loadAllResults=()=>{
  get(child(ref(db),"results")).then(snap=>{
    allResultsTable.innerHTML="";
    if(snap.exists()){
      snap.forEach(c=>{
        const r=c.val();
        const obt=(+r.namazObt||0)+(+r.kalmaObt||0)+(+r.quranObt||0);
        const total=(+r.namazTotal||0)+(+r.kalmaTotal||0)+(+r.quranTotal||0);
        
        let positionClass = "";
        let positionDisplay = r.position || "-";
        
        if(r.position === "1st") positionClass = "position-1st";
        else if(r.position === "2nd") positionClass = "position-2nd";
        else if(r.position === "3rd") positionClass = "position-3rd";
        else if(r.position === "Pass") positionClass = "position-pass";
        
        allResultsTable.innerHTML+=`<tr>
          <td>${r.roll}</td>
          <td>${r.name}</td>
          <td>${r.father}</td>
          <td>${r.month}</td>
          <td>${obt}/${total}</td>
          <td>${r.presentDays}/${r.totalWorkingDays} (${r.attendancePercentage}%)</td>
          <td class="${positionClass}">${positionDisplay}</td>
          <td><span class="currency">Rs.</span> ${r.fine||0}</td>
          <td>
            <button class="btn-info" onclick="editResult('${c.key}')">‚úèÔ∏è Edit</button>
            <button class="btn-danger" onclick="deleteResult('${c.key}')">üóë Delete</button>
          </td>
        </tr>`;
      });
    } else allResultsTable.innerHTML="<tr><td colspan='9'>No Results Found</td></tr>";
  });
};

// Edit Result
window.editResult = async (key) => {
  const resultRef = ref(db, "results/" + key);
  const snapshot = await get(resultRef);
  
  if (snapshot.exists()) {
    const result = snapshot.val();
    
    // Show edit form
    document.getElementById('editResultForm').classList.remove('hidden');
    
    // Fill form with current data
    document.getElementById('editResultKey').value = key;
    document.getElementById('editNamazObt').value = result.namazObt || 0;
    document.getElementById('editKalmaObt').value = result.kalmaObt || 0;
    document.getElementById('editQuranObt').value = result.quranObt || 0;
    document.getElementById('editPresentDays').value = result.presentDays || 0;
    document.getElementById('editTotalWorkingDays').value = result.totalWorkingDays || 0;
    document.getElementById('editFine').value = result.fine || 0;
    document.getElementById('editPosition').value = result.position || '';
    
    // Scroll to edit form
    document.getElementById('editResultForm').scrollIntoView({ behavior: 'smooth' });
  }
};

// Update Result
window.updateResult = async () => {
  const key = document.getElementById('editResultKey').value;
  const resultRef = ref(db, "results/" + key);
  
  const namazObt = +document.getElementById('editNamazObt').value || 0;
  const kalmaObt = +document.getElementById('editKalmaObt').value || 0;
  const quranObt = +document.getElementById('editQuranObt').value || 0;
  const presentDays = +document.getElementById('editPresentDays').value || 0;
  const totalWorkingDays = +document.getElementById('editTotalWorkingDays').value || 0;
  const fine = +document.getElementById('editFine').value || 0;
  const position = document.getElementById('editPosition').value;
  
  // Calculate attendance percentage
  const attendancePercentage = totalWorkingDays > 0 ? Math.round((presentDays / totalWorkingDays) * 100) : 0;
  
  const updates = {
    namazObt: namazObt,
    kalmaObt: kalmaObt,
    quranObt: quranObt,
    presentDays: presentDays,
    totalWorkingDays: totalWorkingDays,
    attendancePercentage: attendancePercentage,
    fine: fine,
    position: position
  };
  
  try {
    await update(resultRef, updates);
    document.getElementById('editResultForm').classList.add('hidden');
    loadAllResults();
    alert("‚úÖ Result updated successfully!");
  } catch (error) {
    alert("‚ùå Error updating result: " + error.message);
  }
};

// Cancel Edit
window.cancelEdit = () => {
  document.getElementById('editResultForm').classList.add('hidden');
};

// Delete Result
window.deleteResult=async(key)=>{
  if(confirm("Are you sure you want to delete this result?")) {
    await remove(ref(db,"results/"+key));
    loadAllResults();
  }
};

// Delete All Results
window.showDeleteConfirmation=()=>{
  const dialog = document.createElement('div');
  dialog.className = 'confirmation-dialog';
  dialog.innerHTML = `
    <h3>‚ö† Delete All Results</h3>
    <p>Are you sure you want to delete ALL results?</p>
    <p style="color: red; font-weight: bold;">This action cannot be undone!</p>
    <button class="btn-danger" onclick="deleteAllResults()">Yes, Delete All</button>
    <button class="btn" onclick="closeConfirmation()" style="margin-left: 10px;">Cancel</button>
  `;
  
  const overlay = document.createElement('div');
  overlay.className = 'overlay';
  
  document.body.appendChild(overlay);
  document.body.appendChild(dialog);
};

window.closeConfirmation=()=>{
  const dialog = document.querySelector('.confirmation-dialog');
  const overlay = document.querySelector('.overlay');
  if(dialog) document.body.removeChild(dialog);
  if(overlay) document.body.removeChild(overlay);
};

window.deleteAllResults=async()=>{
  try {
    await remove(ref(db, "results"));
    closeConfirmation();
    loadAllResults();
    alert("‚úÖ All results deleted successfully!");
  } catch (error) {
    alert("‚ùå Error deleting results: " + error.message);
  }
};

// Flower animation function with different durations and new flowers
function createFlowers(position) {
  // No flowers for Pass students
  if(position === "Pass") return;
  
  const flowerContainer = document.createElement('div');
  flowerContainer.id = 'flowerContainer';
  flowerContainer.style.position = 'fixed';
  flowerContainer.style.top = '0';
  flowerContainer.style.left = '0';
  flowerContainer.style.width = '100%';
  flowerContainer.style.height = '100%';
  flowerContainer.style.pointerEvents = 'none';
  flowerContainer.style.zIndex = '1000';
  document.body.appendChild(flowerContainer);

  let flowers = [];
  let flowerCount = 0;
  let maxFlowers = 0;
  let duration = 0;
  let intervalTime = 0;
  
  // Set different parameters based on position with NEW FLOWERS
  if(position === "1st") {
    flowers = ["üíê", "üå∫", "üèµÔ∏è"]; // New flowers for 1st position
    maxFlowers = 25;
    duration = 7000;
    intervalTime = 150;
  } else if(position === "2nd") {
    flowers = ["üå∑", "üåª", "ü•Ä"]; // New flowers for 2nd position
    maxFlowers = 18;
    duration = 5000;
    intervalTime = 200;
  } else if(position === "3rd") {
    flowers = ["üåº", "üå∏", "üíÆ"]; // New flowers for 3rd position
    maxFlowers = 12;
    duration = 4000;
    intervalTime = 250;
  }
  
  const interval = setInterval(() => {
    if(flowerCount >= maxFlowers) {
      clearInterval(interval);
      setTimeout(() => {
        if(document.getElementById('flowerContainer')) {
          document.body.removeChild(flowerContainer);
        }
      }, 1000);
      return;
    }
    
    flowers.forEach(flower => {
      const flowerElement = document.createElement('div');
      flowerElement.className = 'flower';
      flowerElement.innerHTML = flower;
      flowerElement.style.left = Math.random() * 100 + 'vw';
      flowerElement.style.animation = `fall ${Math.random() * 2 + 3}s linear forwards`;
      flowerContainer.appendChild(flowerElement);
      
      setTimeout(() => {
        if(flowerElement.parentNode === flowerContainer) {
          flowerContainer.removeChild(flowerElement);
        }
      }, 6000);
    });
    
    flowerCount += flowers.length;
  }, intervalTime);

  setTimeout(() => {
    clearInterval(interval);
    setTimeout(() => {
      if(document.getElementById('flowerContainer')) {
        document.body.removeChild(flowerContainer);
      }
    }, 1000);
  }, duration);
}

// Check Result (Public)
window.checkResult=()=>{
  const roll=searchRoll.value.trim();
  if(!roll)return resultOutput.textContent="‚ö† Enter Roll Number!";
  
  get(child(ref(db),"results")).then(snap=>{
    if(snap.exists()){
      let found=false;
      let latestResult = null;
      
      // Find the latest result for this roll number
      snap.forEach(c=>{
        const d=c.val();
        if(d.roll===roll){
          found=true;
          // Keep the most recent result (assuming chronological order)
          if(!latestResult || d.month > latestResult.month) {
            latestResult = d;
          }
        }
      });
      
      if(found && latestResult) {
        const d = latestResult;
        const obt=(+d.namazObt)+(+d.kalmaObt)+(+d.quranObt);
        const total=(+d.namazTotal)+(+d.kalmaTotal)+(+d.quranTotal);
        
        let positionClass = "";
        let positionDisplay = d.position || "Not assigned";
        
        if(d.position === "1st") positionClass = "position-1st";
        else if(d.position === "2nd") positionClass = "position-2nd";
        else if(d.position === "3rd") positionClass = "position-3rd";
        else if(d.position === "Pass") positionClass = "position-pass";
        
        // Check if student has marks (not absent)
        const hasMarks = (+d.namazObt || +d.kalmaObt || +d.quranObt) > 0;
        
        // Create flower animation based on position with different durations
        if(d.position && d.position !== "Pass" && hasMarks) {
          createFlowers(d.position);
        }
        
        resultOutput.innerHTML=`<div class="result-card">
        <h3>${d.name} (${d.roll})</h3>
        <p><b>Father:</b> ${d.father}</p>
        <p><b>Month:</b> ${d.month}</p>
        ${hasMarks ? `
          <p>Namaz: ${d.namazObt}/${d.namazTotal}</p>
          <p>Kalma: ${d.kalmaObt}/${d.kalmaTotal}</p>
          <p>Nazra: ${d.quranObt}/${d.quranTotal}</p>
          <p>Attendance: ${d.presentDays}/${d.totalWorkingDays} Days (${d.attendancePercentage}%)</p>
          <p><b>Position:</b> <span class="${positionClass}">${positionDisplay}</span></p>
          <p><b>Fine:</b> <span class="currency">Rs.</span> ${d.fine||0}</p>
          <p><b>Total Marks:</b> ${obt}/${total}</p>
        ` : `
          <p class="absent"><b>Status: ABSENT</b></p>
          <p>Attendance: ${d.presentDays}/${d.totalWorkingDays} Days (${d.attendancePercentage}%)</p>
          <p><b>Fine:</b> <span class="currency">Rs.</span> ${d.fine||0}</p>
        `}
        </div>`;
      } else {
        // Student exists but has no results
        get(child(ref(db),"students/"+roll)).then(studentSnap=>{
          if(studentSnap.exists()){
            const student = studentSnap.val();
            resultOutput.innerHTML=`<div class="result-card">
              <h3>${student.name} (${student.roll})</h3>
              <p><b>Father:</b> ${student.father}</p>
              <p style="color: #666; font-style: italic;">No result available yet. Please check back later.</p>
            </div>`;
          } else {
            resultOutput.textContent="‚ùå No Record Found!";
          }
        });
      }
    } else {
      // No results at all
      get(child(ref(db),"students/"+roll)).then(studentSnap=>{
        if(studentSnap.exists()){
          const student = studentSnap.val();
          resultOutput.innerHTML=`<div class="result-card">
            <h3>${student.name} (${student.roll})</h3>
            <p><b>Father:</b> ${student.father}</p>
            <p style="color: #666; font-style: italic;">No result available yet. Please check back later.</p>
          </div>`;
        } else {
          resultOutput.textContent="‚ùå No Record Found!";
        }
      });
    }
  });
};

// Change Admin Code (Firebase-based)
window.changeAdminCode=async()=>{
  const old=oldCode.value.trim(),newC=newCode.value.trim();
  const snap=await get(ref(db,"admin/code"));
  const realCode=snap.exists()?snap.val():"6457";
  if(old===realCode && newC){
    await set(ref(db,"admin/code"),newC);
    codeMsg.textContent="‚úÖ Admin Code Changed Successfully!";
    oldCode.value=newCode.value="";
  } else codeMsg.textContent="‚ùå Wrong Old Code!";
};
</script>
</body>
</html>